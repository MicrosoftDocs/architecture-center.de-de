---
title: Auswahl einer übergeordneten Instanz
description: Koordinieren Sie die Aktionen, die von einer Sammlung zusammenarbeitender Taskinstanzen ausgeführt werden, in einer verteilten Anwendung, indem eine Instanz als übergeordnete Instanz ausgewählt wird, die die Verantwortung für die Verwaltung der anderen Instanzen übernimmt.
keywords: Entwurfsmuster
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- design-implementation
- resiliency
ms.openlocfilehash: 8c8efa0846550557bb53ea81f85ac0e303a77b19
ms.sourcegitcommit: f19314f18cd794ebe380fa722ca92066b8735b56
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 07/03/2018
ms.locfileid: "37348268"
---
# <a name="leader-election-pattern"></a><span data-ttu-id="19748-104">Muster für die Auswahl einer übergeordneten Instanz</span><span class="sxs-lookup"><span data-stu-id="19748-104">Leader Election pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="19748-105">Koordinieren Sie die von einer Sammlung zusammenarbeitender Instanzen ausgeführten Aktionen in einer verteilten Anwendung, indem Sie eine Instanz als übergeordnete Instanz auswählen, die die Verantwortung für die Verwaltung der anderen übernimmt.</span><span class="sxs-lookup"><span data-stu-id="19748-105">Coordinate the actions performed by a collection of collaborating instances in a distributed application by electing one instance as the leader that assumes responsibility for managing the others.</span></span> <span data-ttu-id="19748-106">Dies kann dazu beitragen, sicherzustellen, dass Instanzen nicht in Konflikt miteinander, um freigegebene Ressourcen oder versehentlich auch mit der Arbeit anderer Instanzen stehen.</span><span class="sxs-lookup"><span data-stu-id="19748-106">This can help to ensure that instances don't conflict with each other, cause contention for shared resources, or inadvertently interfere with the work that other instances are performing.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="19748-107">Kontext und Problem</span><span class="sxs-lookup"><span data-stu-id="19748-107">Context and problem</span></span>

<span data-ttu-id="19748-108">Eine typische Cloudanwendung weist viele Aufgaben auf, die koordiniert ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="19748-108">A typical cloud application has many tasks acting in a coordinated manner.</span></span> <span data-ttu-id="19748-109">Bei diesen Aufgaben kann es sich um Instanzen handeln, die alle denselben Code ausführen und auf dieselben Ressourcen zugreifen möchten, oder sie können parallel gemeinsam an Bestandteilen einer komplexen Berechnung arbeiten.</span><span class="sxs-lookup"><span data-stu-id="19748-109">These tasks could all be instances running the same code and requiring access to the same resources, or they might be working together in parallel to perform the individual parts of a complex calculation.</span></span>

<span data-ttu-id="19748-110">Zu einem großen Teil werden die Taskinstanzen möglicherweise separat ausgeführt, es kann jedoch auch notwendig sein, die Aktionen der einzelnen Instanzen zu koordinieren, um sicherzustellen, dass sie nicht in Konflikt miteinander, um freigegebene Ressourcen oder versehentlich auch mit der Arbeit anderer Instanzen stehen.</span><span class="sxs-lookup"><span data-stu-id="19748-110">The task instances might run separately for much of the time, but it might also be necessary to coordinate the actions of each instance to ensure that they don’t conflict, cause contention for shared resources, or accidentally interfere with the work that other task instances are performing.</span></span>

<span data-ttu-id="19748-111">Beispiel: </span><span class="sxs-lookup"><span data-stu-id="19748-111">For example:</span></span>

- <span data-ttu-id="19748-112">In einem cloudbasierten System, in dem eine horizontale Skalierung implementiert ist, können mehrere Instanzen desselben Tasks gleichzeitig ausgeführt werden, wobei jede Instanz einem anderen Benutzer zugeordnet ist.</span><span class="sxs-lookup"><span data-stu-id="19748-112">In a cloud-based system that implements horizontal scaling, multiple instances of the same task could be running at the same time with each instance serving a different user.</span></span> <span data-ttu-id="19748-113">Wenn diese Instanzen in eine freigegebene Ressource schreiben, müssen ihre Aktionen koordiniert werden, um zu verhindern, dass jede Instanz die von der anderen vorgenommenen Änderungen überschreibt.</span><span class="sxs-lookup"><span data-stu-id="19748-113">If these instances write to a shared resource, it's necessary to coordinate their actions to prevent each instance from overwriting the changes made by the others.</span></span>
- <span data-ttu-id="19748-114">Wenn die Aufgaben einzelne Elemente einer komplexen Berechnung parallel ausführen, müssen die Ergebnisse aggregiert werden, wenn alle abgeschlossen sind.</span><span class="sxs-lookup"><span data-stu-id="19748-114">If the tasks are performing individual elements of a complex calculation in parallel, the results need to be aggregated when they all complete.</span></span>

<span data-ttu-id="19748-115">Alle Taskinstanzen sind gleichrangig, daher gibt es keine natürliche übergeordnete Instanz, die als Koordinator oder Aggregator fungieren kann.</span><span class="sxs-lookup"><span data-stu-id="19748-115">The task instances are all peers, so there isn't a natural leader that can act as the coordinator or aggregator.</span></span>

## <a name="solution"></a><span data-ttu-id="19748-116">Lösung</span><span class="sxs-lookup"><span data-stu-id="19748-116">Solution</span></span>

<span data-ttu-id="19748-117">Eine einzelne Aufgabeninstanz sollte zur übergeordneten Instanz gewählt werden. Diese Instanz koordiniert die Aktionen der anderen untergeordneten Taskinstanzen.</span><span class="sxs-lookup"><span data-stu-id="19748-117">A single task instance should be elected to act as the leader, and this instance should coordinate the actions of the other subordinate task instances.</span></span> <span data-ttu-id="19748-118">Wenn alle Taskinstanzen denselben Code ausführen, kann jede als übergeordnete Instanz fungieren.</span><span class="sxs-lookup"><span data-stu-id="19748-118">If all of the task instances are running the same code, they are each capable of acting as the leader.</span></span> <span data-ttu-id="19748-119">Aus diesem Grund muss der Wahlprozess sorgfältig verwaltet werden, um zu verhindern, dass mehrere Instanzen die übergeordnete Rolle gleichzeitig annehmen.</span><span class="sxs-lookup"><span data-stu-id="19748-119">Therefore, the election process must be managed carefully to prevent two or more instances taking over the leader role at the same time.</span></span>

<span data-ttu-id="19748-120">Das System muss einen stabilen Mechanismus für die Auswahl der übergeordneten Instanz bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="19748-120">The system must provide a robust mechanism for selecting the leader.</span></span> <span data-ttu-id="19748-121">Diese Methode muss mit Ereignissen wie Netzwerkausfällen oder Prozessfehlern umgehen können.</span><span class="sxs-lookup"><span data-stu-id="19748-121">This method has to cope with events such as network outages or process failures.</span></span> <span data-ttu-id="19748-122">In vielen Lösungen überwachen die untergeordneten Aufgabeninstanzen die übergeordnete durch eine Taktmethode oder durch Polls.</span><span class="sxs-lookup"><span data-stu-id="19748-122">In many solutions, the subordinate task instances monitor the leader through some type of heartbeat method, or by polling.</span></span> <span data-ttu-id="19748-123">Wenn die festgelegte übergeordnete Instanz unerwartet beendet wird oder ein Netzwerkausfall dafür sorgt, dass sie nicht verfügbar ist, müssen die anderen Instanzen eine neue übergeordnete Instanz wählen.</span><span class="sxs-lookup"><span data-stu-id="19748-123">If the designated leader terminates unexpectedly, or a network failure makes the leader unavailable to the subordinate task instances, it's necessary for them to elect a new leader.</span></span>

<span data-ttu-id="19748-124">Für die Wahl einer übergeordneten Instanz zwischen mehreren in einer verteilten Umgebung gibt es mehrere Strategien, einschließlich:</span><span class="sxs-lookup"><span data-stu-id="19748-124">There are several strategies for electing a leader among a set of tasks in a distributed environment, including:</span></span>
- <span data-ttu-id="19748-125">Auswählen der Aufgabeninstanz mit der niedrigsten Instanz- oder Prozess-ID.</span><span class="sxs-lookup"><span data-stu-id="19748-125">Selecting the task instance with the lowest-ranked instance or process ID.</span></span>
- <span data-ttu-id="19748-126">Wettbewerb um den Abruf eines verteilten gegenseitigen Ausschlusses.</span><span class="sxs-lookup"><span data-stu-id="19748-126">Racing to acquire a shared, distributed mutex.</span></span> <span data-ttu-id="19748-127">Die erste Aufgabeninstanz, die den gegenseitigen Ausschluss abruft, ist die übergeordnete Instanz.</span><span class="sxs-lookup"><span data-stu-id="19748-127">The first task instance that acquires the mutex is the leader.</span></span> <span data-ttu-id="19748-128">Das System muss jedoch sicherstellen, dass beim Beenden oder Trennen der übergeordneten Instanz vom restlichen System der gegenseitige Ausschluss aufgehoben wird, sodass eine andere Aufgabeninstanz die übergeordnete Instanz werden kann.</span><span class="sxs-lookup"><span data-stu-id="19748-128">However, the system must ensure that, if the leader terminates or becomes disconnected from the rest of the system, the mutex is released to allow another task instance to become the leader.</span></span>
- <span data-ttu-id="19748-129">Implementieren eines der verbreiteten Algorithmen für die Wahl der übergeordneten Instanz, z.B. [Bullyalgorithmus](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html) oder [Ringalgorithmus](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span><span class="sxs-lookup"><span data-stu-id="19748-129">Implementing one of the common leader election algorithms such as the [Bully Algorithm](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html) or the [Ring Algorithm](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span></span> <span data-ttu-id="19748-130">Bei diesen Algorithmen wird davon ausgegangen, dass jeder Kandidat im Wahlverfahren eine eindeutige ID aufweist und zuverlässig mit den anderen Kandidaten kommunizieren kann.</span><span class="sxs-lookup"><span data-stu-id="19748-130">These algorithms assume that each candidate in the election has a unique ID, and that it can communicate with the other candidates reliably.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="19748-131">Probleme und Überlegungen</span><span class="sxs-lookup"><span data-stu-id="19748-131">Issues and considerations</span></span>

<span data-ttu-id="19748-132">Beachten Sie die folgenden Punkte bei der Entscheidung, wie dieses Muster implementiert werden soll:</span><span class="sxs-lookup"><span data-stu-id="19748-132">Consider the following points when deciding how to implement this pattern:</span></span>
- <span data-ttu-id="19748-133">Die Wahl einer übergeordneten Instanz sollte gegenüber vorübergehenden und permanenten Fehlern robust sein.</span><span class="sxs-lookup"><span data-stu-id="19748-133">The process of electing a leader should be resilient to transient and persistent failures.</span></span>
- <span data-ttu-id="19748-134">Es muss möglich sein, zu erkennen, wenn die übergeordnete Instanz einen Fehler aufweist oder anderweitig nicht mehr verfügbar ist, z.B. aufgrund eines Kommunikationsfehlers.</span><span class="sxs-lookup"><span data-stu-id="19748-134">It must be possible to detect when the leader has failed or has become otherwise unavailable (such as due to a communications failure).</span></span> <span data-ttu-id="19748-135">Wie schnell eine Erkennung benötigt wird, ist systemabhängig.</span><span class="sxs-lookup"><span data-stu-id="19748-135">How quickly detection is needed is system dependent.</span></span> <span data-ttu-id="19748-136">Einige Systeme funktionieren möglicherweise für kurze Zeit ohne übergeordnete Instanz. In dieser Zeit kann ein vorübergehender Fehler behoben werden.</span><span class="sxs-lookup"><span data-stu-id="19748-136">Some systems might be able to function for a short time without a leader, during which a transient fault might be fixed.</span></span> <span data-ttu-id="19748-137">In anderen Fällen kann es erforderlich sein, den Ausfall der übergeordneten Instanz sofort zu erkennen und eine neue Wahl auszulösen.</span><span class="sxs-lookup"><span data-stu-id="19748-137">In other cases, it might be necessary to detect leader failure immediately and trigger a new election.</span></span>
- <span data-ttu-id="19748-138">In einem System, in dem eine automatische horizontale Skalierung implementiert ist, kann die übergeordnete Instanz möglicherweise beendet werden, wenn das System zurückskaliert und einige der Verarbeitungsressourcen herunterfährt.</span><span class="sxs-lookup"><span data-stu-id="19748-138">In a system that implements horizontal autoscaling, the leader could be terminated if the system scales back and shuts down some of the computing resources.</span></span>
- <span data-ttu-id="19748-139">Mit der Verwendung eines freigegebenen, nicht verteilten gegenseitigen Ausschlusses wird eine Abhängigkeit von dem externen Dienst, der den gegenseitigen Ausschluss bereitstellt, eingeführt.</span><span class="sxs-lookup"><span data-stu-id="19748-139">Using a shared, distributed mutex introduces a dependency on the external service that provides the mutex.</span></span> <span data-ttu-id="19748-140">Der Dienst stellt einen Single Point of Failure dar.</span><span class="sxs-lookup"><span data-stu-id="19748-140">The service constitutes a single point of failure.</span></span> <span data-ttu-id="19748-141">Wenn er aus irgendeinem Grund nicht verfügbar ist, kann das System keine übergeordnete Instanz wählen.</span><span class="sxs-lookup"><span data-stu-id="19748-141">If it becomes unavailable for any reason, the system won't be able to elect a leader.</span></span>
- <span data-ttu-id="19748-142">Die Verwendung eines einzelnen dedizierten Prozesses als übergeordnete Instanz ist ein einfaches Verfahren.</span><span class="sxs-lookup"><span data-stu-id="19748-142">Using a single dedicated process as the leader is a straightforward approach.</span></span> <span data-ttu-id="19748-143">Wenn bei dem Verfahren jedoch ein Fehler auftritt, kann es während des Neustarts zu einer erheblichen Verzögerung kommen.</span><span class="sxs-lookup"><span data-stu-id="19748-143">However, if the process fails there could be a significant delay while it's restarted.</span></span> <span data-ttu-id="19748-144">Die resultierende Latenz kann die Leistung und die Antwortzeiten anderer Prozesse beeinträchtigen, wenn sie zum Koordinieren eines Vorgangs auf die übergeordnete Instanz warten.</span><span class="sxs-lookup"><span data-stu-id="19748-144">The resulting latency can affect the performance and response times of other processes if they're waiting for the leader to coordinate an operation.</span></span>
- <span data-ttu-id="19748-145">Die größte Flexibilität für die Feinabstimmung und Optimierung des Codes ist bei der manuellen Implementierung eines der Wahlalgorithmen für die übergeordnete Instanz gegeben.</span><span class="sxs-lookup"><span data-stu-id="19748-145">Implementing one of the leader election algorithms manually provides the greatest flexibility for tuning and optimizing the code.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="19748-146">Verwendung dieses Musters</span><span class="sxs-lookup"><span data-stu-id="19748-146">When to use this pattern</span></span>

<span data-ttu-id="19748-147">Verwenden Sie dieses Muster, wenn die Aufgaben in einer verteilten Anwendung wie einer in der Cloud gehosteten Lösung eine sorgfältige Koordination erfordern und keine natürliche übergeordnete Instanz besteht.</span><span class="sxs-lookup"><span data-stu-id="19748-147">Use this pattern when the tasks in a distributed application, such as a cloud-hosted solution, need careful coordination and there's no natural leader.</span></span>

>  <span data-ttu-id="19748-148">Vermeiden Sie es, die übergeordnete Instanz zu einem Engpass im System zu machen.</span><span class="sxs-lookup"><span data-stu-id="19748-148">Avoid making the leader a bottleneck in the system.</span></span> <span data-ttu-id="19748-149">Die übergeordnete Instanz dient zum Koordinieren der Arbeit der untergeordneten Aufgaben und muss nicht unbedingt selbst an dieser Arbeit teilnehmen – obwohl dies möglich sein sollte, wenn die Aufgabe nicht zur übergeordneten Instanz gewählt wurde.</span><span class="sxs-lookup"><span data-stu-id="19748-149">The purpose of the leader is to coordinate the work of the subordinate tasks, and it doesn't necessarily have to participate in this work itself&mdash;although it should be able to do so if the task isn't elected as the leader.</span></span>

<span data-ttu-id="19748-150">Dieses Muster ist in folgenden Fällen möglicherweise nicht geeignet:</span><span class="sxs-lookup"><span data-stu-id="19748-150">This pattern might not be useful if:</span></span>
- <span data-ttu-id="19748-151">Es gibt eine natürliche übergeordnete Instanz oder einen dedizierten Prozess, der immer die Rolle der übergeordneten Instanz übernehmen kann.</span><span class="sxs-lookup"><span data-stu-id="19748-151">There's a natural leader or dedicated process that can always act as the leader.</span></span> <span data-ttu-id="19748-152">Beispielsweise kann es möglich sein, einen Singleton-Prozess zu implementieren, der die Aufgabeninstanzen koordiniert.</span><span class="sxs-lookup"><span data-stu-id="19748-152">For example, it might be possible to implement a singleton process that coordinates the task instances.</span></span> <span data-ttu-id="19748-153">Wenn bei diesem Prozess ein Fehler auftritt oder seine Integrität beeinträchtigt wird, kann das System ihn herunterfahren und neu starten.</span><span class="sxs-lookup"><span data-stu-id="19748-153">If this process fails or becomes unhealthy, the system can shut it down and restart it.</span></span>
- <span data-ttu-id="19748-154">Die Koordination zwischen Aufgaben kann mithilfe einer weniger aufwendigen Methode erreicht werden.</span><span class="sxs-lookup"><span data-stu-id="19748-154">The coordination between tasks can be achieved using a more lightweight method.</span></span> <span data-ttu-id="19748-155">Wenn beispielsweise mehrere Aufgabeninstanzen einfach einen koordinierten Zugriff auf eine freigegebene Ressource benötigen, ist eine optimistische oder pessimistische Sperrung zum Steuern des Zugriffs eine bessere Lösung.</span><span class="sxs-lookup"><span data-stu-id="19748-155">For example, if several task instances simply need coordinated access to a shared resource, a better solution is to use optimistic or pessimistic locking to control access.</span></span>
- <span data-ttu-id="19748-156">Eine Lösung eines Drittanbieters ist besser geeignet.</span><span class="sxs-lookup"><span data-stu-id="19748-156">A third-party solution is more appropriate.</span></span> <span data-ttu-id="19748-157">Beispielsweise verwendet der Microsoft Azure HDInsight-Dienst (basierend auf Apache Hadoop) die von Apache ZooKeeper bereitgestellten Dienste zum Koordinieren der Zuordnung und Verringerung von Aufgaben, die Daten erfassen und zusammenfassen.</span><span class="sxs-lookup"><span data-stu-id="19748-157">For example, the Microsoft Azure HDInsight service (based on Apache Hadoop) uses the services provided by Apache Zookeeper to coordinate the map and reduce tasks that collect and summarize data.</span></span>

## <a name="example"></a><span data-ttu-id="19748-158">Beispiel</span><span class="sxs-lookup"><span data-stu-id="19748-158">Example</span></span>

<span data-ttu-id="19748-159">Das Projekt DistributedMutex in der Projektmappe LeaderElection (ein Beispiel für dieses Muster ist bei [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election) zu finden) zeigt, wie mit einer Lease für ein Azure Storage-Blob ein Mechanismus zum Implementieren eines freigegebenen, verteilten gegenseitigen Ausschlusses bereitgestellt werden kann.</span><span class="sxs-lookup"><span data-stu-id="19748-159">The DistributedMutex project in the LeaderElection solution (a sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election)) shows how to use a lease on an Azure Storage blob to provide a mechanism for implementing a shared, distributed mutex.</span></span> <span data-ttu-id="19748-160">Mit diesem gegenseitigen Ausschluss kann eine übergeordnete Instanz aus einer Gruppe von Rolleninstanzen in einem Azure-Clouddienst gewählt werden.</span><span class="sxs-lookup"><span data-stu-id="19748-160">This mutex can be used to elect a leader among a group of role instances in an Azure cloud service.</span></span> <span data-ttu-id="19748-161">Die erste Rolleninstanz, die die Lease erhält, wird als übergeordnete Instanz bestimmt und bleibt diese, bis sie die Lease freigibt oder diese nicht mehr erneuern kann.</span><span class="sxs-lookup"><span data-stu-id="19748-161">The first role instance to acquire the lease is elected the leader, and remains the leader until it releases the lease or isn't able to renew the lease.</span></span> <span data-ttu-id="19748-162">Andere Rolleninstanzen können die Bloblease für den Fall, dass die übergeordnete Instanz nicht mehr verfügbar ist, weiterhin überwachen.</span><span class="sxs-lookup"><span data-stu-id="19748-162">Other role instances can continue to monitor the blob lease in case the leader is no longer available.</span></span>

>  <span data-ttu-id="19748-163">Eine Bloblease ist eine exklusive Schreibsperre auf ein Blob.</span><span class="sxs-lookup"><span data-stu-id="19748-163">A blob lease is an exclusive write lock over a blob.</span></span> <span data-ttu-id="19748-164">Ein einzelnes Blob kann jeweils nur einer Lease unterliegen.</span><span class="sxs-lookup"><span data-stu-id="19748-164">A single blob can be the subject of only one lease at any point in time.</span></span> <span data-ttu-id="19748-165">Eine Rolleninstanz kann eine Lease für ein angegebenes Blob anfordern und erhält diese, wenn keine andere Rolleninstanz über eine Lease für dasselbe Blob verfügt.</span><span class="sxs-lookup"><span data-stu-id="19748-165">A role instance can request a lease over a specified blob, and it'll be granted the lease if no other role instance holds a lease over the same blob.</span></span> <span data-ttu-id="19748-166">Andernfalls löst die Anforderung eine Ausnahme aus.</span><span class="sxs-lookup"><span data-stu-id="19748-166">Otherwise the request will throw an exception.</span></span>
> 
> <span data-ttu-id="19748-167">Um eine fehlerhafte Rolleninstanz zu vermeiden, die die Lease unbegrenzt beibehält, geben Sie eine Gültigkeitsdauer für die Lease an.</span><span class="sxs-lookup"><span data-stu-id="19748-167">To avoid a faulted role instance retaining the lease indefinitely, specify a lifetime for the lease.</span></span> <span data-ttu-id="19748-168">Wenn diese abläuft, ist die Lease wieder verfügbar.</span><span class="sxs-lookup"><span data-stu-id="19748-168">When this expires, the lease becomes available.</span></span> <span data-ttu-id="19748-169">Während eine Rolleninstanz über die Lease verfügt, kann sie jedoch eine Erneuerung der Lease anfordern und erhält dann die Lease für einen weiteren Zeitraum.</span><span class="sxs-lookup"><span data-stu-id="19748-169">However, while a role instance holds the lease it can request that the lease is renewed, and it'll be granted the lease for a further period of time.</span></span> <span data-ttu-id="19748-170">Die Rolleninstanz kann diesen Vorgang fortlaufend wiederholen, wenn sie die Lease beibehalten möchte.</span><span class="sxs-lookup"><span data-stu-id="19748-170">The role instance can continually repeat this process if it wants to retain the lease.</span></span>
> <span data-ttu-id="19748-171">Weitere Informationen zum Leasen eines Blobs finden Sie unter [Leasen eines Blobs (REST-API)](https://msdn.microsoft.com/library/azure/ee691972.aspx).</span><span class="sxs-lookup"><span data-stu-id="19748-171">For more information on how to lease a blob, see [Lease Blob (REST API)](https://msdn.microsoft.com/library/azure/ee691972.aspx).</span></span>

<span data-ttu-id="19748-172">Die `BlobDistributedMutex`-Klasse im folgenden C#-Beispiel enthält die `RunTaskWhenMutexAquired`-Methode, die einer Rolleninstanz ermöglicht, eine Lease für ein angegebenes Blob abzurufen.</span><span class="sxs-lookup"><span data-stu-id="19748-172">The `BlobDistributedMutex` class in the C# example below contains the `RunTaskWhenMutexAquired` method that enables a role instance to attempt to acquire a lease over a specified blob.</span></span> <span data-ttu-id="19748-173">Die Details des Blobs (Name, Container und Speicherkonto) werden in den Konstruktor in einem `BlobSettings`-Objekt übergeben, wenn das `BlobDistributedMutex`-Objekt erstellt wird (eine einfache Struktur, die im Beispielcode enthalten ist).</span><span class="sxs-lookup"><span data-stu-id="19748-173">The details of the blob (the name, container, and storage account) are passed to the constructor in a `BlobSettings` object when the `BlobDistributedMutex` object is created (this object is a simple struct that is included in the sample code).</span></span> <span data-ttu-id="19748-174">Der Konstruktor akzeptiert auch eine `Task`, die auf den Code verweist, den die Rolleninstanz ausführen sollte, wenn sie erfolgreich die Lease für das Blob abruft und zur übergeordneten Instanz gewählt wird.</span><span class="sxs-lookup"><span data-stu-id="19748-174">The constructor also accepts a `Task` that references the code that the role instance should run if it successfully acquires the lease over the blob and is elected the leader.</span></span> <span data-ttu-id="19748-175">Beachten Sie, dass der Code für die Verarbeitung der Details auf niedriger Ebene zum Abrufen der Lease in der separaten Hilfsklasse `BlobLeaseManager` implementiert wird.</span><span class="sxs-lookup"><span data-stu-id="19748-175">Note that the code that handles the low-level details of acquiring the lease is implemented in a separate helper class named `BlobLeaseManager`.</span></span>

```csharp
public class BlobDistributedMutex
{
  ...
  private readonly BlobSettings blobSettings;
  private readonly Func<CancellationToken, Task> taskToRunWhenLeaseAcquired;
  ...

  public BlobDistributedMutex(BlobSettings blobSettings,
           Func<CancellationToken, Task> taskToRunWhenLeaseAquired)
  {
    this.blobSettings = blobSettings;
    this.taskToRunWhenLeaseAquired = taskToRunWhenLeaseAquired;
  }

  public async Task RunTaskWhenMutexAcquired(CancellationToken token)
  {
    var leaseManager = new BlobLeaseManager(blobSettings);
    await this.RunTaskWhenBlobLeaseAcquired(leaseManager, token);
  }
  ...
```

<span data-ttu-id="19748-176">Die `RunTaskWhenMutexAquired`-Methode im obigen Codebeispiel ruft die im folgenden Codebeispiel gezeigte `RunTaskWhenBlobLeaseAcquired`-Methode auf, um die Lease abzurufen.</span><span class="sxs-lookup"><span data-stu-id="19748-176">The `RunTaskWhenMutexAquired` method in the code sample above invokes the `RunTaskWhenBlobLeaseAcquired` method shown in the following code sample to actually acquire the lease.</span></span> <span data-ttu-id="19748-177">Die `RunTaskWhenBlobLeaseAcquired`-Methode wird asynchron ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="19748-177">The `RunTaskWhenBlobLeaseAcquired` method runs asynchronously.</span></span> <span data-ttu-id="19748-178">Nach dem Abruf der Lease wurde die Rolleninstanz zur übergeordneten Instanz gewählt.</span><span class="sxs-lookup"><span data-stu-id="19748-178">If the lease is successfully acquired, the role instance has been elected the leader.</span></span> <span data-ttu-id="19748-179">Der Zweck des Delegaten `taskToRunWhenLeaseAcquired` besteht darin, die Aufgaben für die Koordinierung der anderen Rolleninstanzen auszuführen.</span><span class="sxs-lookup"><span data-stu-id="19748-179">The purpose of the `taskToRunWhenLeaseAcquired` delegate is to perform the work that coordinates the other role instances.</span></span> <span data-ttu-id="19748-180">Wenn die Lease nicht abgerufen wird, wurde eine andere Rolleninstanz zur übergeordneten Instanz gewählt, und die aktuelle Rolleninstanz bleibt untergeordnet.</span><span class="sxs-lookup"><span data-stu-id="19748-180">If the lease isn't acquired, another role instance has been elected as the leader and the current role instance remains a subordinate.</span></span> <span data-ttu-id="19748-181">Beachten Sie, dass die `TryAcquireLeaseOrWait`-Methode eine Hilfsmethode ist, die zum Abrufen der Lease das `BlobLeaseManager`-Objekt verwendet.</span><span class="sxs-lookup"><span data-stu-id="19748-181">Note that the `TryAcquireLeaseOrWait` method is a helper method that uses the `BlobLeaseManager` object to acquire the lease.</span></span>

```csharp
  private async Task RunTaskWhenBlobLeaseAcquired(
    BlobLeaseManager leaseManager, CancellationToken token)
  {
    while (!token.IsCancellationRequested)
    {
      // Try to acquire the blob lease.
      // Otherwise wait for a short time before trying again.
      string leaseId = await this.TryAquireLeaseOrWait(leaseManager, token);

      if (!string.IsNullOrEmpty(leaseId))
      {
        // Create a new linked cancellation token source so that if either the
        // original token is canceled or the lease can't be renewed, the
        // leader task can be canceled.
        using (var leaseCts =
          CancellationTokenSource.CreateLinkedTokenSource(new[] { token }))
        {
          // Run the leader task.
          var leaderTask = this.taskToRunWhenLeaseAquired.Invoke(leaseCts.Token);
          ...
        }
      }
    }
    ...
  }
```

<span data-ttu-id="19748-182">Die von der übergeordneten Instanz gestartete Aufgabe wird ebenfalls asynchron ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="19748-182">The task started by the leader also runs asynchronously.</span></span> <span data-ttu-id="19748-183">Während der Ausführung dieser Aufgabe versucht die im folgenden Codebeispiel gezeigte `RunTaskWhenBlobLeaseAquired`-Methode in regelmäßigen Abständen, die Lease zu verlängern.</span><span class="sxs-lookup"><span data-stu-id="19748-183">While this task is running, the `RunTaskWhenBlobLeaseAquired` method shown in the following code sample periodically attempts to renew the lease.</span></span> <span data-ttu-id="19748-184">Dadurch wird sichergestellt, dass die Rolleninstanz die übergeordnete Instanz bleibt.</span><span class="sxs-lookup"><span data-stu-id="19748-184">This helps to ensure that the role instance remains the leader.</span></span> <span data-ttu-id="19748-185">In der Beispiellösung ist die Verzögerung zwischen Erneuerungsanforderungen kürzer als die als Dauer der Lease angegebene Zeit. Dies verhindert, dass eine andere Rolleninstanz zur übergeordneten Instanz gewählt wird.</span><span class="sxs-lookup"><span data-stu-id="19748-185">In the sample solution, the delay between renewal requests is less than the time specified for the duration of the lease in order to prevent another role instance from being elected the leader.</span></span> <span data-ttu-id="19748-186">Wenn bei der Erneuerung aus irgendeinem Grund ein Fehler auftritt, wird die Aufgabe abgebrochen.</span><span class="sxs-lookup"><span data-stu-id="19748-186">If the renewal fails for any reason, the task is canceled.</span></span>

<span data-ttu-id="19748-187">Wenn die Lease nicht erneuert werden kann oder die Aufgabe abgebrochen wird (möglicherweise aufgrund des Herunterfahrens der Rolleninstanz), wird die Lease freigegeben.</span><span class="sxs-lookup"><span data-stu-id="19748-187">If the lease fails to be renewed or the task is canceled (possibly as a result of the role instance shutting down), the lease is released.</span></span> <span data-ttu-id="19748-188">An diesem Punkt kann diese oder eine andere Rolleninstanz zur übergeordneten Instanz gewählt werden.</span><span class="sxs-lookup"><span data-stu-id="19748-188">At this point, this or another role instance might be elected as the leader.</span></span> <span data-ttu-id="19748-189">Der Codeausschnitt unten zeigt diesen Teil des Vorgangs.</span><span class="sxs-lookup"><span data-stu-id="19748-189">The code extract below shows this part of the process.</span></span>

```csharp
  private async Task RunTaskWhenBlobLeaseAcquired(
    BlobLeaseManager leaseManager, CancellationToken token)
  {
    while (...)
    {
      ...
      if (...)
      {
        ...
        using (var leaseCts = ...)
        {
          ...
          // Keep renewing the lease in regular intervals.
          // If the lease can't be renewed, then the task completes.
          var renewLeaseTask =
            this.KeepRenewingLease(leaseManager, leaseId, leaseCts.Token);

          // When any task completes (either the leader task itself or when it
          // couldn't renew the lease) then cancel the other task.
          await CancelAllWhenAnyCompletes(leaderTask, renewLeaseTask, leaseCts);
        }
      }
    }
  }
  ...
}
```

<span data-ttu-id="19748-190">Die `KeepRenewingLease`-Methode ist eine weitere Hilfsmethode, die das `BlobLeaseManager`-Objekt zum Erneuern der Lease verwendet.</span><span class="sxs-lookup"><span data-stu-id="19748-190">The `KeepRenewingLease` method is another helper method that uses the `BlobLeaseManager` object to renew the lease.</span></span> <span data-ttu-id="19748-191">Die `CancelAllWhenAnyCompletes`-Methode bricht die als die ersten beiden Parameter angegebenen Aufgaben ab.</span><span class="sxs-lookup"><span data-stu-id="19748-191">The `CancelAllWhenAnyCompletes` method cancels the tasks specified as the first two parameters.</span></span> <span data-ttu-id="19748-192">Das folgende Diagramm veranschaulicht, wie mit der `BlobDistributedMutex`-Klasse eine übergeordnete Instanz gewählt und eine Aufgabe ausgeführt wird, die Vorgänge koordiniert.</span><span class="sxs-lookup"><span data-stu-id="19748-192">The following diagram illustrates using the `BlobDistributedMutex` class to elect a leader and run a task that coordinates operations.</span></span>

![Abbildung 1 zeigt die Funktionen der BlobDistributedMutex-Klasse](./_images/leader-election-diagram.png)


<span data-ttu-id="19748-194">Im folgenden Codebeispiel wird veranschaulicht, wie die `BlobDistributedMutex`-Klasse in einer Workerrolle verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="19748-194">The following code example shows how to use the `BlobDistributedMutex` class in a worker role.</span></span> <span data-ttu-id="19748-195">Dieser Code ruft eine Lease für das Blob `MyLeaderCoordinatorTask` im Container der Lease im Entwicklungsspeicher ab und gibt an, dass der in der `MyLeaderCoordinatorTask`-Methode definierte Code immer dann ausgeführt werden soll, wenn die Rolleninstanz als übergeordnete Instanz gewählt wurde.</span><span class="sxs-lookup"><span data-stu-id="19748-195">This code acquires a lease over a blob named `MyLeaderCoordinatorTask` in the lease's container in development storage, and specifies that the code defined in the `MyLeaderCoordinatorTask` method should run if the role instance is elected the leader.</span></span>

```csharp
var settings = new BlobSettings(CloudStorageAccount.DevelopmentStorageAccount,
  "leases", "MyLeaderCoordinatorTask");
var cts = new CancellationTokenSource();
var mutex = new BlobDistributedMutex(settings, MyLeaderCoordinatorTask);
mutex.RunTaskWhenMutexAcquired(this.cts.Token);
...

// Method that runs if the role instance is elected the leader
private static async Task MyLeaderCoordinatorTask(CancellationToken token)
{
  ...
}
```

<span data-ttu-id="19748-196">Beachten Sie die folgenden Punkte bezüglich der Beispiellösung:</span><span class="sxs-lookup"><span data-stu-id="19748-196">Note the following points about the sample solution:</span></span>
- <span data-ttu-id="19748-197">Das Blob ist potenziell ein Single Point of Failure.</span><span class="sxs-lookup"><span data-stu-id="19748-197">The blob is a potential single point of failure.</span></span> <span data-ttu-id="19748-198">Wenn der Blob-Dienst nicht mehr verfügbar ist oder nicht auf ihn zugegriffen werden kann, kann die übergeordnete Instanz die Lease nicht erneuern, und keine andere Rolleninstanz ist in der Lage, die Lease abzurufen.</span><span class="sxs-lookup"><span data-stu-id="19748-198">If the blob service becomes unavailable, or is inaccessible, the leader won't be able to renew the lease and no other role instance will be able to acquire the lease.</span></span> <span data-ttu-id="19748-199">In diesem Fall kann keine Rolleninstanz als übergeordnete Instanz fungieren.</span><span class="sxs-lookup"><span data-stu-id="19748-199">In this case, no role instance will be able to act as the leader.</span></span> <span data-ttu-id="19748-200">Der Blob-Dienst ist jedoch auf Stabilität ausgelegt, daher wird ein vollständiger Ausfall des Blob-Diensts als sehr unwahrscheinlich betrachtet.</span><span class="sxs-lookup"><span data-stu-id="19748-200">However, the blob service is designed to be resilient, so complete failure of the blob service is considered to be extremely unlikely.</span></span>
- <span data-ttu-id="19748-201">Wenn der von der übergeordneten Instanz ausgeführte Task angehalten wird, kann die übergeordnete Instanz die Lease weiterhin erneuern. Dadurch werden alle anderen Rolleninstanzen daran gehindert, die Lease abzurufen und die Rolle der übergeordneten Instanz zu übernehmen, um Aufgaben zu koordinieren.</span><span class="sxs-lookup"><span data-stu-id="19748-201">If the task being performed by the leader stalls, the leader might continue to renew the lease, preventing any other role instance from acquiring the lease and taking over the leader role in order to coordinate tasks.</span></span> <span data-ttu-id="19748-202">In der Praxis sollte die Integrität der übergeordneten Instanz häufig überprüft werden.</span><span class="sxs-lookup"><span data-stu-id="19748-202">In the real world, the health of the leader should be checked at frequent intervals.</span></span>
- <span data-ttu-id="19748-203">Der Wahlvorgang ist nicht deterministisch.</span><span class="sxs-lookup"><span data-stu-id="19748-203">The election process is nondeterministic.</span></span> <span data-ttu-id="19748-204">Es sind keine Prognosen darüber möglich, welche Rolleninstanz die Bloblease abruft und zur übergeordneten Instanz wird.</span><span class="sxs-lookup"><span data-stu-id="19748-204">You can't make any assumptions about which role instance will acquire the blob lease and become the leader.</span></span>
- <span data-ttu-id="19748-205">Das als Ziel für die Bloblease verwendete Blob sollte nicht für andere Zwecke verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="19748-205">The blob used as the target of the blob lease shouldn't be used for any other purpose.</span></span> <span data-ttu-id="19748-206">Wenn eine Rolleninstanz versucht, Daten in diesem Blob zu speichern, kann auf diese Daten nicht zugegriffen werden, es sei denn, die Rolleninstanz ist die übergeordnete Instanz und verfügt über die Bloblease.</span><span class="sxs-lookup"><span data-stu-id="19748-206">If a role instance attempts to store data in this blob, this data won't be accessible unless the role instance is the leader and holds the blob lease.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="19748-207">Zugehörige Muster und Anleitungen</span><span class="sxs-lookup"><span data-stu-id="19748-207">Related patterns and guidance</span></span>

<span data-ttu-id="19748-208">Die folgenden Richtlinien sind unter Umständen beim Implementieren dieses Musters ebenfalls relevant:</span><span class="sxs-lookup"><span data-stu-id="19748-208">The following guidance might also be relevant when implementing this pattern:</span></span>
- <span data-ttu-id="19748-209">Dieses Muster verfügt über eine herunterladbare [Beispielanwendung](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election).</span><span class="sxs-lookup"><span data-stu-id="19748-209">This pattern has a downloadable [sample application](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election).</span></span>
- <span data-ttu-id="19748-210">[Richtlinien für die automatische Skalierung:](https://msdn.microsoft.com/library/dn589774.aspx)</span><span class="sxs-lookup"><span data-stu-id="19748-210">[Autoscaling Guidance](https://msdn.microsoft.com/library/dn589774.aspx).</span></span> <span data-ttu-id="19748-211">Instanzen der Aufgabenhosts können gestartet und beendet werden, wenn sich die Auslastung Anwendung ändert.</span><span class="sxs-lookup"><span data-stu-id="19748-211">It's possible to start and stop instances of the task hosts as the load on the application varies.</span></span> <span data-ttu-id="19748-212">Automatische Skalierung kann dabei helfen, den Durchsatz und die Leistung während Zeiten maximaler Verarbeitung beizubehalten.</span><span class="sxs-lookup"><span data-stu-id="19748-212">Autoscaling can help to maintain throughput and performance during times of peak processing.</span></span>
- <span data-ttu-id="19748-213">[Richtlinien zur Computepartitionierung:](https://msdn.microsoft.com/library/dn589773.aspx)</span><span class="sxs-lookup"><span data-stu-id="19748-213">[Compute Partitioning Guidance](https://msdn.microsoft.com/library/dn589773.aspx).</span></span> <span data-ttu-id="19748-214">In diesen Richtlinien wird beschrieben, wie Aufgaben in einem Clouddienst so Hosts zugewiesen werden, dass die Betriebskosten minimiert und gleichzeitig die Skalierbarkeit, Leistung, Verfügbarkeit und Sicherheit des Diensts beibehalten werden.</span><span class="sxs-lookup"><span data-stu-id="19748-214">This guidance describes how to allocate tasks to hosts in a cloud service in a way that helps to minimize running costs while maintaining the scalability, performance, availability, and security of the service.</span></span>
- <span data-ttu-id="19748-215">Das [aufgabenbasierte asynchrone Muster](https://msdn.microsoft.com/library/hh873175.aspx)</span><span class="sxs-lookup"><span data-stu-id="19748-215">The [Task-based Asynchronous Pattern](https://msdn.microsoft.com/library/hh873175.aspx).</span></span>
- <span data-ttu-id="19748-216">Ein Beispiel zur Veranschaulichung des [Bullyalgorithmus](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html)</span><span class="sxs-lookup"><span data-stu-id="19748-216">An example illustrating the [Bully Algorithm](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html).</span></span>
- <span data-ttu-id="19748-217">Ein Beispiel zur Veranschaulichung des [Ringalgorithmus](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html)</span><span class="sxs-lookup"><span data-stu-id="19748-217">An example illustrating the [Ring Algorithm](http://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span></span>
- <span data-ttu-id="19748-218">[Apache Curator](http://curator.apache.org/), eine Clientbibliothek für Apache ZooKeeper</span><span class="sxs-lookup"><span data-stu-id="19748-218">[Apache Curator](http://curator.apache.org/) a client library for Apache ZooKeeper.</span></span>
- <span data-ttu-id="19748-219">Der Artikel [Leasen eines Blobs (REST-API)](https://msdn.microsoft.com/library/azure/ee691972.aspx) bei MSDN</span><span class="sxs-lookup"><span data-stu-id="19748-219">The article [Lease Blob (REST API)](https://msdn.microsoft.com/library/azure/ee691972.aspx) on MSDN.</span></span>

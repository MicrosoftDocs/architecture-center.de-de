---
title: Trennschalter
description: Behandeln Sie Fehler, deren Behebung beim Herstellen einer Verbindung mit einem Remotedienst oder einer Remoteressource unterschiedlich lange dauern kann.
keywords: Entwurfsmuster
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- resiliency
ms.openlocfilehash: 5a9c8254bf62488b46517ee3582c2323e206df8a
ms.sourcegitcommit: e9d9e214529edd0dc78df5bda29615b8fafd0e56
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 06/28/2018
ms.locfileid: "37090950"
---
# <a name="circuit-breaker-pattern"></a><span data-ttu-id="919dc-104">Trennschalter-Muster</span><span class="sxs-lookup"><span data-stu-id="919dc-104">Circuit Breaker pattern</span></span>

<span data-ttu-id="919dc-105">Behandeln Sie Fehler, deren Behebung beim Herstellen einer Verbindung mit einem Remotedienst oder einer Remoteressource unterschiedlich lange dauern kann.</span><span class="sxs-lookup"><span data-stu-id="919dc-105">Handle faults that might take a variable amount of time to recover from, when connecting to a remote service or resource.</span></span> <span data-ttu-id="919dc-106">Dies kann die Stabilität und Resilienz einer Anwendung verbessern.</span><span class="sxs-lookup"><span data-stu-id="919dc-106">This can improve the stability and resiliency of an application.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="919dc-107">Kontext und Problem</span><span class="sxs-lookup"><span data-stu-id="919dc-107">Context and problem</span></span>

<span data-ttu-id="919dc-108">In einer verteilten Umgebung können bei Aufrufen von Remoteressourcen und -diensten vorübergehende Störungen auftreten, z. B. langsame Netzwerkverbindungen, Timeouts oder überlastete bzw. vorübergehend nicht verfügbare Ressourcen, die zu Fehlern führen können.</span><span class="sxs-lookup"><span data-stu-id="919dc-108">In a distributed environment, calls to remote resources and services can fail due to transient faults, such as slow network connections, timeouts, or the resources being overcommitted or temporarily unavailable.</span></span> <span data-ttu-id="919dc-109">Diese Störungen korrigieren sich typischerweise nach kurzer Zeit selbst, und eine robuste Cloudanwendung sollte bereit sein, sie mit einer Strategie wie dem [Wiederholungsmuster][retry-pattern] zu behandeln.</span><span class="sxs-lookup"><span data-stu-id="919dc-109">These faults typically correct themselves after a short period of time, and a robust cloud application should be prepared to handle them by using a strategy such as the [Retry pattern][retry-pattern].</span></span>

<span data-ttu-id="919dc-110">Es kann aber auch Situationen geben, in denen Störungen bzw. Fehler auf unvorhergesehene Ereignisse zurückzuführen sind, deren Behebung viel länger dauern kann.</span><span class="sxs-lookup"><span data-stu-id="919dc-110">However, there can also be situations where faults are due to unanticipated events, and that might take much longer to fix.</span></span> <span data-ttu-id="919dc-111">Der Schweregrad dieser Störungen kann von einem teilweisen Verlust der Konnektivität bis hin zum vollständigen Ausfall eines Diensts reichen.</span><span class="sxs-lookup"><span data-stu-id="919dc-111">These faults can range in severity from a partial loss of connectivity to the complete failure of a service.</span></span> <span data-ttu-id="919dc-112">In solchen Situationen kann es für eine Anwendung zwecklos sein, einen Vorgang, der unwahrscheinlich ist, ständig zu wiederholen. Stattdessen sollte die Anwendung schnell akzeptieren, dass der Vorgang fehlerhaft ist, und diesen Fehler entsprechend behandeln.</span><span class="sxs-lookup"><span data-stu-id="919dc-112">In these situations it might be pointless for an application to continually retry an operation that is unlikely to succeed, and instead the application should quickly accept that the operation has failed and handle this failure accordingly.</span></span>

<span data-ttu-id="919dc-113">Wenn ein Dienst zudem sehr ausgelastet ist, kann ein Ausfall in einem Teil des Systems zu überlappenden Fehlern führen.</span><span class="sxs-lookup"><span data-stu-id="919dc-113">Additionally, if a service is very busy, failure in one part of the system might lead to cascading failures.</span></span> <span data-ttu-id="919dc-114">Ein Vorgang, der einen Dienst aufruft, könnte z. B. so konfiguriert werden, dass er ein Timeout implementiert und mit einer Fehlermeldung antwortet, wenn der Dienst innerhalb dieses Zeitraums nicht antwortet.</span><span class="sxs-lookup"><span data-stu-id="919dc-114">For example, an operation that invokes a service could be configured to implement a timeout, and reply with a failure message if the service fails to respond within this period.</span></span> <span data-ttu-id="919dc-115">Diese Strategie könnte jedoch dazu führen, dass viele gleichzeitige Anforderungen an denselben Vorgang bis zum Ablauf der Timeoutperiode blockiert werden.</span><span class="sxs-lookup"><span data-stu-id="919dc-115">However, this strategy could cause many concurrent requests to the same operation to be blocked until the timeout period expires.</span></span> <span data-ttu-id="919dc-116">Diese blockierten Anforderungen können kritische Systemressourcen belegen, z. B. Arbeitsspeicher, Threads, Datenbankverbindungen usw.</span><span class="sxs-lookup"><span data-stu-id="919dc-116">These blocked requests might hold critical system resources such as memory, threads, database connections, and so on.</span></span> <span data-ttu-id="919dc-117">Infolgedessen könnten diese Ressourcen ausgelastet werden. Dies könnte zum Ausfall anderer, möglicherweise nicht zusammengehöriger Teile des Systems führen, die dieselben Ressourcen benötigen.</span><span class="sxs-lookup"><span data-stu-id="919dc-117">Consequently, these resources could become exhausted, causing failure of other possibly unrelated parts of the system that need to use the same resources.</span></span> <span data-ttu-id="919dc-118">In solchen Situationen wäre es vorzuziehen, wenn der Vorgang sofort einen Fehler aufweist und nur dann versucht wird, den Dienst aufzurufen, wenn er voraussichtlich erfolgreich sein wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-118">In these situations, it would be preferable for the operation to fail immediately, and only attempt to invoke the service if it's likely to succeed.</span></span> <span data-ttu-id="919dc-119">Beachten Sie, dass das Festlegen eines kürzeren Timeouts zur Lösung dieses Problems beitragen kann, aber der Timeout sollte nicht so kurz sein, dass beim Vorgang die meiste Zeit Fehler auftreten, selbst wenn die Anforderung an den Dienst letztendlich erfolgreich sein sollte.</span><span class="sxs-lookup"><span data-stu-id="919dc-119">Note that setting a shorter timeout might help to resolve this problem, but the timeout shouldn't be so short that the operation fails most of the time, even if the request to the service would eventually succeed.</span></span>

## <a name="solution"></a><span data-ttu-id="919dc-120">Lösung</span><span class="sxs-lookup"><span data-stu-id="919dc-120">Solution</span></span>

<span data-ttu-id="919dc-121">Das Trennschalter-Muster, das von Michael Nygard in seinem Buch [Release It!](https://pragprog.com/book/mnee/release-it) gemeinverständlich dargestellt wurde, kann verhindern, dass eine Anwendung wiederholt versucht einen Vorgang auszuführen, der voraussichtlich nicht erfolgreich sein wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-121">The Circuit Breaker pattern, popularized by Michael Nygard in his book, [Release It!](https://pragprog.com/book/mnee/release-it), can prevent an application from repeatedly trying to execute an operation that's likely to fail.</span></span> <span data-ttu-id="919dc-122">Dabei wird die Fortsetzung des Vorgangs gestattet, ohne auf eine Behebung der Störung zu warten oder CPU-Zyklen zu verschwenden, während ermittelt wird, dass es sich um einen länger anhaltenden Fehler handelt.</span><span class="sxs-lookup"><span data-stu-id="919dc-122">Allowing it to continue without waiting for the fault to be fixed or wasting CPU cycles while it determines that the fault is long lasting.</span></span> <span data-ttu-id="919dc-123">Mithilfe des Trennschalter-Musters kann eine Anwendung auch ermitteln, ob der Fehler behoben wurde.</span><span class="sxs-lookup"><span data-stu-id="919dc-123">The Circuit Breaker pattern also enables an application to detect whether the fault has been resolved.</span></span> <span data-ttu-id="919dc-124">Wenn das Problem scheinbar behoben ist, kann die Anwendung versuchen, den Vorgang aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="919dc-124">If the problem appears to have been fixed, the application can try to invoke the operation.</span></span>

> <span data-ttu-id="919dc-125">Der Zweck des Trennschalter-Musters unterscheidet sich von dem des Wiederholungsmusters.</span><span class="sxs-lookup"><span data-stu-id="919dc-125">The purpose of the Circuit Breaker pattern is different than the Retry pattern.</span></span> <span data-ttu-id="919dc-126">Mithilfe des Wiederholungsmusters kann eine Anwendung einen Vorgang in der Annahme wiederholen, dass er erfolgreich ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-126">The Retry pattern enables an application to retry an operation in the expectation that it'll succeed.</span></span> <span data-ttu-id="919dc-127">Das Trennschalter-Muster verhindert, dass von einer Anwendung ein Vorgang durchgeführt wird, der voraussichtlich nicht erfolgreich sein wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-127">The Circuit Breaker pattern prevents an application from performing an operation that is likely to fail.</span></span> <span data-ttu-id="919dc-128">Eine Anwendung kann diese beiden Muster kombinieren, indem sie das Wiederholungsmuster verwendet, um einen Vorgang über einen Trennschalter aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="919dc-128">An application can combine these two patterns by using the Retry pattern to invoke an operation through a circuit breaker.</span></span> <span data-ttu-id="919dc-129">Die Wiederholungslogik sollte jedoch auf Ausnahmen reagieren, die vom Trennschalter zurückgegeben werden, und Wiederholungsversuche abbrechen, wenn der Trennschalter anzeigt, dass ein Fehler nicht vorübergehend ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-129">However, the retry logic should be sensitive to any exceptions returned by the circuit breaker and abandon retry attempts if the circuit breaker indicates that a fault is not transient.</span></span>

<span data-ttu-id="919dc-130">Ein Trennschalter fungiert als Proxy für Vorgänge, bei denen möglicherweise Fehler auftreten.</span><span class="sxs-lookup"><span data-stu-id="919dc-130">A circuit breaker acts as a proxy for operations that might fail.</span></span> <span data-ttu-id="919dc-131">Der Proxy sollte die Anzahl der kürzlich aufgetretenen Fehler überwachen und anhand dieser Informationen entscheiden, ob der Vorgang fortgesetzt oder sofort eine Ausnahme zurückgegeben werden soll.</span><span class="sxs-lookup"><span data-stu-id="919dc-131">The proxy should monitor the number of recent failures that have occurred, and use this information to decide whether to allow the operation to proceed, or simply return an exception immediately.</span></span>

<span data-ttu-id="919dc-132">Der Proxy kann als Zustandsautomat mit den folgenden Zuständen implementiert werden, die die Funktionalität eines elektrischen Trennschalters simulieren:</span><span class="sxs-lookup"><span data-stu-id="919dc-132">The proxy can be implemented as a state machine with the following states that mimic the functionality of an electrical circuit breaker:</span></span>

- <span data-ttu-id="919dc-133">**Geschlossen**: Die Anforderung der Anwendung wird an den Vorgang weitergeleitet.</span><span class="sxs-lookup"><span data-stu-id="919dc-133">**Closed**: The request from the application is routed to the operation.</span></span> <span data-ttu-id="919dc-134">Der Proxy führt eine Zählung der Anzahl der letzten Fehler durch, und wenn der Aufruf des Vorgangs erfolglos ist, inkrementiert der Proxy diesen Zähler.</span><span class="sxs-lookup"><span data-stu-id="919dc-134">The proxy maintains a count of the number of recent failures, and if the call to the operation is unsuccessful the proxy increments this count.</span></span> <span data-ttu-id="919dc-135">Überschreitet die Anzahl der letzten Fehler innerhalb eines bestimmten Zeitraums einen bestimmten Schwellenwert, wird der Proxy in den Zustand **Geöffnet** versetzt.</span><span class="sxs-lookup"><span data-stu-id="919dc-135">If the number of recent failures exceeds a specified threshold within a given time period, the proxy is placed into the **Open** state.</span></span> <span data-ttu-id="919dc-136">An diesem Punkt startet der Proxy einen Timeout-Timer, und wenn dieser Timer abläuft, wird der Proxy in den Zustand **Halb geöffnet** versetzt.</span><span class="sxs-lookup"><span data-stu-id="919dc-136">At this point the proxy starts a timeout timer, and when this timer expires the proxy is placed into the **Half-Open** state.</span></span>

    > <span data-ttu-id="919dc-137">Der Zweck des Timeout-Timers ist es, dem System Zeit zur Behebung des Problems zu geben, das die Störung verursacht hat, bevor es der Anwendung erlaubt wird, den Vorgang erneut auszuführen.</span><span class="sxs-lookup"><span data-stu-id="919dc-137">The purpose of the timeout timer is to give the system time to fix the problem that caused the failure before allowing the application to try to perform the operation again.</span></span>

- <span data-ttu-id="919dc-138">**Geöffnet**: Die Anforderung der Anwendung schlägt sofort fehl und eine Ausnahme wird an die Anwendung zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="919dc-138">**Open**: The request from the application fails immediately and an exception is returned to the application.</span></span>

- <span data-ttu-id="919dc-139">**Halb geöffnet**: Eine begrenzte Anzahl von Anforderungen aus der Anwendung dürfen den Vorgang durchlaufen und aufrufen.</span><span class="sxs-lookup"><span data-stu-id="919dc-139">**Half-Open**: A limited number of requests from the application are allowed to pass through and invoke the operation.</span></span> <span data-ttu-id="919dc-140">Wenn diese Anforderungen erfolgreich sind, wird davon ausgegangen, dass die Störung, die zuvor den Fehler verursacht hat, behoben wurde und der Trennschalter in den Zustand **Geschlossen** wechselt (der Fehlerzähler wird zurückgesetzt).</span><span class="sxs-lookup"><span data-stu-id="919dc-140">If these requests are successful, it's assumed that the fault that was previously causing the failure has been fixed and the circuit breaker switches to the **Closed** state (the failure counter is reset).</span></span> <span data-ttu-id="919dc-141">Wenn bei einer Anforderung ein Fehler auftritt, geht der Trennschalter davon aus, dass die Störung noch vorhanden ist, sodass er in den Zustand **Geöffnet** zurückkehrt und den Timeout-Timer neu startet, um dem System eine weitere Frist für die Wiederherstellung nach dem Fehler zu geben.</span><span class="sxs-lookup"><span data-stu-id="919dc-141">If any request fails, the circuit breaker assumes that the fault is still present so it reverts back to the **Open** state and restarts the timeout timer to give the system a further period of time to recover from the failure.</span></span>

    > <span data-ttu-id="919dc-142">Mit dem Zustand **Halb geöffnet** kann verhindert werden, dass ein in der Wiederherstellung befindlicher Dienst plötzlich mit Anforderungen überschwemmt wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-142">The **Half-Open** state is useful to prevent a recovering service from suddenly being flooded with requests.</span></span> <span data-ttu-id="919dc-143">Wenn ein Dienst wiederhergestellt wird, kann er möglicherweise eine begrenzte Anzahl von Anforderungen unterstützen, bis die Wiederherstellung abgeschlossen ist. Aber während der Wiederherstellung kann eine Vielzahl an Aufgaben dazu führen, dass der Dienst erneut den Timeout überschreitet oder ausfällt.</span><span class="sxs-lookup"><span data-stu-id="919dc-143">As a service recovers, it might be able to support a limited volume of requests until the recovery is complete, but while recovery is in progress a flood of work can cause the service to time out or fail again.</span></span>

![Trennschalterzustände](./_images/circuit-breaker-diagram.png)

<span data-ttu-id="919dc-145">In der Abbildung ist der vom Zustand **Geschlossen** verwendete Fehlerzähler zeitbasiert.</span><span class="sxs-lookup"><span data-stu-id="919dc-145">In the figure, the failure counter used by the **Closed** state is time based.</span></span> <span data-ttu-id="919dc-146">Er wird in regelmäßigen Abständen automatisch zurückgesetzt.</span><span class="sxs-lookup"><span data-stu-id="919dc-146">It's automatically reset at periodic intervals.</span></span> <span data-ttu-id="919dc-147">Dadurch wird verhindert, dass der Trennschalter bei gelegentlichen Ausfällen in den Zustand **Geöffnet** wechselt.</span><span class="sxs-lookup"><span data-stu-id="919dc-147">This helps to prevent the circuit breaker from entering the **Open** state if it experiences occasional failures.</span></span> <span data-ttu-id="919dc-148">Der Fehlerschwellenwert, der den Trennschalter in den Zustand **Geöffnet** versetzt, wird nur erreicht, wenn innerhalb eines bestimmten Intervalls eine bestimmte Anzahl von Fehlern aufgetreten ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-148">The failure threshold that trips the circuit breaker into the **Open** state is only reached when a specified number of failures have occurred during a specified interval.</span></span> <span data-ttu-id="919dc-149">Der Zähler, der vom Zustand **Halb geöffnet** verwendet wird, zeichnet die Anzahl der erfolgreichen Versuche beim Aufrufen des Vorgangs auf.</span><span class="sxs-lookup"><span data-stu-id="919dc-149">The counter used by the **Half-Open** state records the number of successful attempts to invoke the operation.</span></span> <span data-ttu-id="919dc-150">Der Trennschalter kehrt in den Zustand **Geschlossen** zurück, nachdem eine bestimmte Anzahl aufeinanderfolgender Vorgangsaufrufe erfolgreich durchgeführt wurde.</span><span class="sxs-lookup"><span data-stu-id="919dc-150">The circuit breaker reverts to the **Closed** state after a specified number of consecutive operation invocations have been successful.</span></span> <span data-ttu-id="919dc-151">Wenn bei einem Aufruf ein Fehler auftritt, wechselt der Trennschalter sofort in den Zustand **Geöffnet** und der Erfolgszähler wird zurückgesetzt, wenn er das nächste Mal in den Zustand **Halb geöffnet** wechselt.</span><span class="sxs-lookup"><span data-stu-id="919dc-151">If any invocation fails, the circuit breaker enters the **Open** state immediately and the success counter will be reset the next time it enters the **Half-Open** state.</span></span>

> <span data-ttu-id="919dc-152">Die Wiederherstellung des Systems erfolgt extern, möglicherweise durch Wiederherstellen oder Neustarten einer fehlerhaften Komponente oder durch Reparieren einer Netzwerkverbindung.</span><span class="sxs-lookup"><span data-stu-id="919dc-152">How the system recovers is handled externally, possibly by restoring or restarting a failed component or repairing a network connection.</span></span>

<span data-ttu-id="919dc-153">Das Trennschalter-Muster sorgt für Stabilität, während sich das System nach einem Fehler erholt und die Auswirkungen auf die Leistung minimiert.</span><span class="sxs-lookup"><span data-stu-id="919dc-153">The Circuit Breaker pattern provides stability while the system recovers from a failure and minimizes the impact on performance.</span></span> <span data-ttu-id="919dc-154">Es kann dabei helfen, die Antwortzeit des Systems zu wahren, indem es eine Anforderung für einen Vorgang, der voraussichtlich nicht erfolgreich sein wird, schnell ablehnt, anstatt darauf zu warten, dass der Vorgang abgebrochen wird oder niemals zurückkehrt.</span><span class="sxs-lookup"><span data-stu-id="919dc-154">It can help to maintain the response time of the system by quickly rejecting a request for an operation that's likely to fail, rather than waiting for the operation to time out, or never return.</span></span> <span data-ttu-id="919dc-155">Wenn der Trennschalter bei jeder Zustandsänderung ein Ereignis auslöst, kann diese Information dazu verwendet werden, den Zustand des durch den Trennschalter geschützten Teils des Systems zu überwachen oder einen Administrator zu alarmieren, wenn ein Trennschalter in den Zustand **Geöffnet** wechselt.</span><span class="sxs-lookup"><span data-stu-id="919dc-155">If the circuit breaker raises an event each time it changes state, this information can be used to monitor the health of the part of the system protected by the circuit breaker, or to alert an administrator when a circuit breaker trips to the **Open** state.</span></span>

<span data-ttu-id="919dc-156">Das Muster ist anpassbar und kann je nach Art des möglichen Fehlers geändert werden.</span><span class="sxs-lookup"><span data-stu-id="919dc-156">The pattern is customizable and can be adapted according to the type of the possible failure.</span></span> <span data-ttu-id="919dc-157">So können Sie z. B. einem Trennschalter einen ansteigenden Timeout-Timer zuweisen.</span><span class="sxs-lookup"><span data-stu-id="919dc-157">For example, you can apply an increasing timeout timer to a circuit breaker.</span></span> <span data-ttu-id="919dc-158">Sie könnten den Trennschalter zunächst für ein paar Sekunden in den Zustand **Geöffnet** versetzen. Wenn der Fehler nicht behoben wurde, können Sie den Timeout auf ein paar Minuten erhöhen usw.</span><span class="sxs-lookup"><span data-stu-id="919dc-158">You could place the circuit breaker in the **Open** state for a few seconds initially, and then if the failure hasn't been resolved increase the timeout to a few minutes, and so on.</span></span> <span data-ttu-id="919dc-159">In manchen Fällen kann es sinnvoll sein, anstelle des Zustandes **Geöffnet**, der einen Fehler zurückgibt und eine Ausnahme auslöst, einen Standardwert zurückzugeben, der für die Anwendung relevant ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-159">In some cases, rather than the **Open** state returning failure and raising an exception, it could be useful to return a default value that is meaningful to the application.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="919dc-160">Probleme und Überlegungen</span><span class="sxs-lookup"><span data-stu-id="919dc-160">Issues and considerations</span></span>

<span data-ttu-id="919dc-161">Bei der Entscheidung, wie dieses Muster implementiert werden soll, sind die folgenden Punkte zu beachten:</span><span class="sxs-lookup"><span data-stu-id="919dc-161">You should consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="919dc-162">**Fehlerbehandlung**:</span><span class="sxs-lookup"><span data-stu-id="919dc-162">**Exception Handling**.</span></span> <span data-ttu-id="919dc-163">Eine Anwendung, die einen Vorgang über einen Trennschalter aufruft, muss darauf vorbereitet sein, die aufgetretenen Ausnahmen zu behandeln, wenn der Vorgang nicht verfügbar ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-163">An application invoking an operation through a circuit breaker must be prepared to handle the exceptions raised if the operation is unavailable.</span></span> <span data-ttu-id="919dc-164">Die Art und Weise, wie Ausnahmen behandelt werden, ist anwendungsspezifisch.</span><span class="sxs-lookup"><span data-stu-id="919dc-164">The way exceptions are handled will be application specific.</span></span> <span data-ttu-id="919dc-165">Eine Anwendung könnte z. B. vorübergehend ihre Funktionalität herabsetzen, einen alternativen Vorgang aufrufen, um zu versuchen, dieselbe Aufgabe auszuführen oder dieselben Daten zu erhalten, oder die Ausnahme dem Benutzer melden und ihn auffordern, es später erneut zu versuchen.</span><span class="sxs-lookup"><span data-stu-id="919dc-165">For example, an application could temporarily degrade its functionality, invoke an alternative operation to try to perform the same task or obtain the same data, or report the exception to the user and ask them to try again later.</span></span>

<span data-ttu-id="919dc-166">**Arten von Ausnahmen**:</span><span class="sxs-lookup"><span data-stu-id="919dc-166">**Types of Exceptions**.</span></span> <span data-ttu-id="919dc-167">Eine Anforderung kann aus vielen Gründen fehlerhaft sein, von denen einige auf eine schwerwiegendere Art von Problemen hinweisen können als andere.</span><span class="sxs-lookup"><span data-stu-id="919dc-167">A request might fail for many reasons, some of which might indicate a more severe type of failure than others.</span></span> <span data-ttu-id="919dc-168">Eine Anforderung kann z. B. fehlerhaft sein, weil ein Remotedienst abgestürzt ist und die Wiederherstellung mehrere Minuten dauert, oder weil der Dienst vorübergehend überlastet ist und einen Timeout verursacht hat.</span><span class="sxs-lookup"><span data-stu-id="919dc-168">For example, a request might fail because a remote service has crashed and will take several minutes to recover, or because of a timeout due to the service being temporarily overloaded.</span></span> <span data-ttu-id="919dc-169">Ein Trennschalter könnte in der Lage sein, die Art der aufgetretenen Ausnahmen zu untersuchen und seine Strategie entsprechend der Art dieser Ausnahmen anzupassen.</span><span class="sxs-lookup"><span data-stu-id="919dc-169">A circuit breaker might be able to examine the types of exceptions that occur and adjust its strategy depending on the nature of these exceptions.</span></span> <span data-ttu-id="919dc-170">Es könnte z. B. eine größere Anzahl von Timeoutausnahmen erforderlich sein, um den Trennschalter in den Zustand **Geöffnet** zu versetzen, verglichen mit der Anzahl der Störungen, die durch nicht verfügbare Dienste hervorgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="919dc-170">For example, it might require a larger number of timeout exceptions to trip the circuit breaker to the **Open** state compared to the number of failures due to the service being completely unavailable.</span></span>

<span data-ttu-id="919dc-171">**Protokollierung**:</span><span class="sxs-lookup"><span data-stu-id="919dc-171">**Logging**.</span></span> <span data-ttu-id="919dc-172">Ein Trennschalter sollte alle fehlerhaften Anforderungen (und möglicherweise erfolgreiche Anforderungen) protokollieren, damit ein Administrator die Integrität des Vorgangs überwachen kann.</span><span class="sxs-lookup"><span data-stu-id="919dc-172">A circuit breaker should log all failed requests (and possibly successful requests) to enable an administrator to monitor the health of the operation.</span></span>

<span data-ttu-id="919dc-173">**Wiederherstellbarkeit**:</span><span class="sxs-lookup"><span data-stu-id="919dc-173">**Recoverability**.</span></span> <span data-ttu-id="919dc-174">Sie sollten den Trennschalter so konfigurieren, dass er dem wahrscheinlichen Wiederherstellungsmuster des zu schützenden Vorgangs entspricht.</span><span class="sxs-lookup"><span data-stu-id="919dc-174">You should configure the circuit breaker to match the likely recovery pattern of the operation it's protecting.</span></span> <span data-ttu-id="919dc-175">Wenn sich der Trennschalter z. B. über einen längeren Zeitraum im Zustand **Geöffnet** befindet, kann er Ausnahmen auslösen, auch wenn die Fehlerursache behoben ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-175">For example, if the circuit breaker remains in the **Open** state for a long period, it could raise exceptions even if the reason for the failure has been resolved.</span></span> <span data-ttu-id="919dc-176">Ebenso könnte ein Trennschalter schwanken und die Reaktionszeiten von Anwendungen verkürzen, wenn er zu schnell vom Zustand **Geöffnet** in den Zustand **Halb geöffnet** wechselt.</span><span class="sxs-lookup"><span data-stu-id="919dc-176">Similarly, a circuit breaker could fluctuate and reduce the response times of applications if it switches from the **Open** state to the **Half-Open** state too quickly.</span></span>

<span data-ttu-id="919dc-177">**Testen fehlerhafter Vorgänge**:</span><span class="sxs-lookup"><span data-stu-id="919dc-177">**Testing Failed Operations**.</span></span> <span data-ttu-id="919dc-178">Im Zustand **Geöffnet** kann ein Trennschalter für den Remotedienst oder die Ressource regelmäßig den Ping-Befehl ausführen, um zu ermitteln, ob der Dienst oder die Ressource wieder verfügbar ist, anstatt einen Timer zur Ermittlung zu verwenden, wann in den Zustand **Halb geöffnet** gewechselt werden muss.</span><span class="sxs-lookup"><span data-stu-id="919dc-178">In the **Open** state, rather than using a timer to determine when to switch to the **Half-Open** state, a circuit breaker can instead periodically ping the remote service or resource to determine whether it's become available again.</span></span> <span data-ttu-id="919dc-179">Dieser Ping-Befehl könnte die Form eines Aufrufversuchs für einen Vorgang annehmen, der zuvor fehlerhaft war, oder er könnte einen speziellen Vorgang verwenden, der vom Remotedienst speziell für die Prüfung der Integrität des Dienstes bereitgestellt wird, wie durch das [Muster zur Überwachung des Integritätsendpunkts](health-endpoint-monitoring.md) beschrieben.</span><span class="sxs-lookup"><span data-stu-id="919dc-179">This ping could take the form of an attempt to invoke an operation that had previously failed, or it could use a special operation provided by the remote service specifically for testing the health of the service, as described by the [Health Endpoint Monitoring pattern](health-endpoint-monitoring.md).</span></span>

<span data-ttu-id="919dc-180">**Manuelle Außerkraftsetzung**:</span><span class="sxs-lookup"><span data-stu-id="919dc-180">**Manual Override**.</span></span> <span data-ttu-id="919dc-181">In einem System, in sich dem die Wiederherstellungszeit für einen fehlerhaften Vorgang als extrem variabel erweist, ist es vorteilhaft, eine manuelle Option zum Zurücksetzen bereitzustellen, mit der ein Administrator einen Trennschalter schließen (und den Fehlerzähler zurücksetzen) kann.</span><span class="sxs-lookup"><span data-stu-id="919dc-181">In a system where the recovery time for a failing operation is extremely variable, it's beneficial to provide a manual reset option that enables an administrator to close a circuit breaker (and reset the failure counter).</span></span> <span data-ttu-id="919dc-182">Ebenso könnte ein Administrator einen Trennschalter in den Zustand **Geöffnet** zwingen (und den Timeout-Timer neu starten), wenn der durch den Trennschalter geschützte Vorgang vorübergehend nicht verfügbar ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-182">Similarly, an administrator could force a circuit breaker into the **Open** state (and restart the timeout timer) if the operation protected by the circuit breaker is temporarily unavailable.</span></span>

<span data-ttu-id="919dc-183">**Parallelität**:</span><span class="sxs-lookup"><span data-stu-id="919dc-183">**Concurrency**.</span></span> <span data-ttu-id="919dc-184">Auf denselben Trennschalter kann von einer großen Anzahl gleichzeitiger Instanzen einer Anwendung zugegriffen werden.</span><span class="sxs-lookup"><span data-stu-id="919dc-184">The same circuit breaker could be accessed by a large number of concurrent instances of an application.</span></span> <span data-ttu-id="919dc-185">Die Implementierung sollte keine gleichzeitigen Anforderungen blockieren oder übermäßigen Aufwand für die einzelnen Aufrufe eines Vorgangs verursachen.</span><span class="sxs-lookup"><span data-stu-id="919dc-185">The implementation shouldn't block concurrent requests or add excessive overhead to each call to an operation.</span></span>

<span data-ttu-id="919dc-186">**Ressourcendifferenzierung**:</span><span class="sxs-lookup"><span data-stu-id="919dc-186">**Resource Differentiation**.</span></span> <span data-ttu-id="919dc-187">Seien Sie bei der Verwendung eines einzelnen Trennschalters für einen Ressourcentyp vorsichtig, wenn mehrere unabhängige Anbieter zugrunde liegen.</span><span class="sxs-lookup"><span data-stu-id="919dc-187">Be careful when using a single circuit breaker for one type of resource if there might be multiple underlying independent providers.</span></span> <span data-ttu-id="919dc-188">In einem Datenspeicher, der mehrere Shards enthält, kann z. B. auf einen Shard uneingeschränkt zugegriffen werden, während bei einem anderen Shard ein temporäres Problem auftritt.</span><span class="sxs-lookup"><span data-stu-id="919dc-188">For example, in a data store that contains multiple shards, one shard might be fully accessible while another is experiencing a temporary issue.</span></span> <span data-ttu-id="919dc-189">Wenn die Fehlerreaktionen in diesen Szenarien zusammengeführt werden, könnte eine Anwendung versuchen, auf einige Shards zuzugreifen, selbst wenn ein Fehler sehr wahrscheinlich ist, während der Zugriff auf andere Shards blockiert wird, obwohl er voraussichtlich erfolgreich sein wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-189">If the error responses in these scenarios are merged, an application might try to access some shards even when failure is highly likely, while access to other shards might be blocked even though it's likely to succeed.</span></span>

<span data-ttu-id="919dc-190">**Beschleunigter Abschaltvorgang**:</span><span class="sxs-lookup"><span data-stu-id="919dc-190">**Accelerated Circuit Breaking**.</span></span> <span data-ttu-id="919dc-191">Manchmal kann eine Fehlerreaktion ausreichend Informationen enthalten, damit der Trennschalter sofort und für eine minimale Zeitspanne ausgelöst wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-191">Sometimes a failure response can contain enough information for the circuit breaker to trip immediately and stay tripped for a minimum amount of time.</span></span> <span data-ttu-id="919dc-192">Die Fehlerreaktion einer freigegebenen Ressource, die überlastet ist, könnte z. B. darauf hinweisen, dass eine sofortige Wiederholung nicht empfohlen wird. Stattdessen sollte es die Anwendung in einigen Minuten erneut versuchen.</span><span class="sxs-lookup"><span data-stu-id="919dc-192">For example, the error response from a shared resource that's overloaded could indicate that an immediate retry isn't recommended and that the application should instead try again in a few minutes.</span></span>

> [!NOTE]
> <span data-ttu-id="919dc-193">Ein Dienst kann HTTP 429 (Zu viele Anforderungen) zurückgeben, wenn er den Client beschränkt, oder HTTP 503 (Dienst nicht verfügbar), wenn der Dienst gerade nicht verfügbar ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-193">A service can return HTTP 429 (Too Many Requests) if it is throttling the client, or HTTP 503 (Service Unavailable) if the service is not currently available.</span></span> <span data-ttu-id="919dc-194">Die Antwort kann zusätzliche Informationen enthalten, z. B. die erwartete Dauer der Verzögerung.</span><span class="sxs-lookup"><span data-stu-id="919dc-194">The response can include additional information, such as the anticipated duration of the delay.</span></span>

<span data-ttu-id="919dc-195">**Wiedergeben fehlerhafter Anforderungen**:</span><span class="sxs-lookup"><span data-stu-id="919dc-195">**Replaying Failed Requests**.</span></span> <span data-ttu-id="919dc-196">Im Zustand **Geöffnet** könnte ein Trennschalter auch die Details jeder Anforderung in einem Journal aufzeichnen und dafür sorgen, dass diese Anforderungen wiedergegeben werden, wenn die Remoteressource oder der Remotedienst verfügbar wird, anstatt einfach nur schnell auszufallen.</span><span class="sxs-lookup"><span data-stu-id="919dc-196">In the **Open** state, rather than simply failing quickly, a circuit breaker could also record the details of each request to a journal and arrange for these requests to be replayed when the remote resource or service becomes available.</span></span>

<span data-ttu-id="919dc-197">**Ungeeignete Timeouts für externe Dienste**:</span><span class="sxs-lookup"><span data-stu-id="919dc-197">**Inappropriate Timeouts on External Services**.</span></span> <span data-ttu-id="919dc-198">Ein Trennschalter kann Anwendungen möglicherweise nicht vollständig vor fehlerhaften Vorgängen in externen Diensten schützen, die mit einer langen Timeoutperiode konfiguriert sind.</span><span class="sxs-lookup"><span data-stu-id="919dc-198">A circuit breaker might not be able to fully protect applications from operations that fail in external services that are configured with a lengthy timeout period.</span></span> <span data-ttu-id="919dc-199">Wenn der Timeout zu lang ist, kann es vorkommen, dass ein Thread, der einen Trennschalter ausführt, für längere Zeit blockiert wird, bevor der Trennschalter anzeigt, dass der Vorgang fehlerhaft ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-199">If the timeout is too long, a thread running a circuit breaker might be blocked for an extended period before the circuit breaker indicates that the operation has failed.</span></span> <span data-ttu-id="919dc-200">In dieser Zeit könnten viele andere Anwendungsinstanzen ebenfalls versuchen, den Dienst über den Trennschalter aufzurufen und eine beträchtliche Anzahl von Threads zu binden, bevor sie alle ausfallen.</span><span class="sxs-lookup"><span data-stu-id="919dc-200">In this time, many other application instances might also try to invoke the service through the circuit breaker and tie up a significant number of threads before they all fail.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="919dc-201">Verwendung dieses Musters</span><span class="sxs-lookup"><span data-stu-id="919dc-201">When to use this pattern</span></span>

<span data-ttu-id="919dc-202">Verwenden Sie dieses Muster in folgenden Fällen:</span><span class="sxs-lookup"><span data-stu-id="919dc-202">Use this pattern:</span></span>

- <span data-ttu-id="919dc-203">Damit verhindert wird, dass eine Anwendung versucht, einen Remotedienst aufzurufen oder auf eine freigegebene Ressource zuzugreifen, wenn sich dieser Vorgang höchstwahrscheinlich als fehlerhaft erweist.</span><span class="sxs-lookup"><span data-stu-id="919dc-203">To prevent an application from trying to invoke a remote service or access a shared resource if this operation is highly likely to fail.</span></span>

<span data-ttu-id="919dc-204">Verwenden Sie dieses Muster in folgenden Fällen nicht:</span><span class="sxs-lookup"><span data-stu-id="919dc-204">This pattern isn't recommended:</span></span>

- <span data-ttu-id="919dc-205">Für die Verwaltung des Zugriffs auf lokale private Ressourcen in einer Anwendung, z. B. die In-Memory-Datenstruktur.</span><span class="sxs-lookup"><span data-stu-id="919dc-205">For handling access to local private resources in an application, such as in-memory data structure.</span></span> <span data-ttu-id="919dc-206">In dieser Umgebung würde die Verwendung eines Trennschalters zu einem zusätzlichen Aufwand für Ihr System führen.</span><span class="sxs-lookup"><span data-stu-id="919dc-206">In this environment, using a circuit breaker would add overhead to your system.</span></span>
- <span data-ttu-id="919dc-207">Als Ersatz für die Behandlung von Ausnahmen in der Geschäftslogik Ihrer Anwendungen.</span><span class="sxs-lookup"><span data-stu-id="919dc-207">As a substitute for handling exceptions in the business logic of your applications.</span></span>

## <a name="example"></a><span data-ttu-id="919dc-208">Beispiel</span><span class="sxs-lookup"><span data-stu-id="919dc-208">Example</span></span>

<span data-ttu-id="919dc-209">In einer Webanwendung werden mehrere Seiten mit Daten gefüllt, die von einem externen Dienst abgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="919dc-209">In a web application, several of the pages are populated with data retrieved from an external service.</span></span> <span data-ttu-id="919dc-210">Wenn das System minimales Caching implementiert, führen die meisten Zugriffe auf diese Seiten zu einem Roundtrip zum Dienst.</span><span class="sxs-lookup"><span data-stu-id="919dc-210">If the system implements minimal caching, most hits to these pages will cause a round trip to the service.</span></span> <span data-ttu-id="919dc-211">Verbindungen von der Webanwendung zum Dienst können mit einer Timeoutperiode konfiguriert werden (normalerweise 60 Sekunden). Wenn der Dienst in dieser Zeit nicht antwortet, wird die Logik der einzelnen Webseiten davon ausgehen, dass der Dienst nicht verfügbar ist und eine Ausnahme auslösen.</span><span class="sxs-lookup"><span data-stu-id="919dc-211">Connections from the web application to the service could be configured with a timeout period (typically 60 seconds), and if the service doesn't respond in this time the logic in each web page will assume that the service is unavailable and throw an exception.</span></span>

<span data-ttu-id="919dc-212">Wenn der Dienst jedoch fehlerhaft und das System sehr ausgelastet ist, könnten Benutzer gezwungen sein, bis zu 60 Sekunden zu warten, bevor eine Ausnahme auftritt.</span><span class="sxs-lookup"><span data-stu-id="919dc-212">However, if the service fails and the system is very busy, users could be forced to wait for up to 60 seconds before an exception occurs.</span></span> <span data-ttu-id="919dc-213">Schließlich könnten Ressourcen wie Arbeitsspeicher, Verbindungen und Threads ausgelastet sein. Dadurch könnten andere Benutzer daran gehindert werden, sich mit dem System zu verbinden, selbst wenn sie nicht auf Seiten zugreifen, die Daten aus dem Dienst abrufen.</span><span class="sxs-lookup"><span data-stu-id="919dc-213">Eventually resources such as memory, connections, and threads could be exhausted, preventing other users from connecting to the system, even if they aren't accessing pages that retrieve data from the service.</span></span>

<span data-ttu-id="919dc-214">Die Skalierung des Systems durch Hinzufügen weiterer Webserver und die Implementierung eines Lastausgleichs könnte sich verzögern, wenn die Ressourcen ausgelastet sind. Es wird das Problem jedoch nicht lösen, da die Benutzeranforderungen immer noch nicht reagieren und allen Webservern eventuell immer noch keine Ressourcen zur Verfügung stehen.</span><span class="sxs-lookup"><span data-stu-id="919dc-214">Scaling the system by adding further web servers and implementing load balancing might delay when resources become exhausted, but it won't resolve the issue because user requests will still be unresponsive and all web servers could still eventually run out of resources.</span></span>

<span data-ttu-id="919dc-215">Ein Umschließen der Logik, die sich mit dem Dienst verbindet und die Daten in einem Trennschalter abruft, könnte helfen, dieses Problem zu lösen und den Dienstfehler eleganter zu handhaben.</span><span class="sxs-lookup"><span data-stu-id="919dc-215">Wrapping the logic that connects to the service and retrieves the data in a circuit breaker could help to solve this problem and handle the service failure more elegantly.</span></span> <span data-ttu-id="919dc-216">Benutzeranforderungen werden weiterhin fehlerhaft sein, aber sie werden schneller als fehlerhaft erkannt und Ressourcen werden daher nicht blockiert.</span><span class="sxs-lookup"><span data-stu-id="919dc-216">User requests will still fail, but they'll fail more quickly and the resources won't be blocked.</span></span>

<span data-ttu-id="919dc-217">Die Klasse `CircuitBreaker` verwaltet Zustandsinformationen zu einem Trennschalter in einem Objekt, das die im folgenden Code gezeigte `ICircuitBreakerStateStore`-Schnittstelle implementiert.</span><span class="sxs-lookup"><span data-stu-id="919dc-217">The `CircuitBreaker` class maintains state information about a circuit breaker in an object that implements the `ICircuitBreakerStateStore` interface shown in the following code.</span></span>

```csharp
interface ICircuitBreakerStateStore
{
  CircuitBreakerStateEnum State { get; }

  Exception LastException { get; }

  DateTime LastStateChangedDateUtc { get; }

  void Trip(Exception ex);

  void Reset();

  void HalfOpen();

  bool IsClosed { get; }
}
```

<span data-ttu-id="919dc-218">Die `State`-Eigenschaft gibt den aktuellen Zustand des Trennschalters an, der gemäß der `CircuitBreakerStateEnum`-Enumeration entweder **Geöffnet**, **Halb geöffnet** oder **Geschlossen** ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-218">The `State` property indicates the current state of the circuit breaker, and will be either **Open**, **HalfOpen**, or **Closed** as defined by the `CircuitBreakerStateEnum` enumeration.</span></span> <span data-ttu-id="919dc-219">Die `IsClosed`-Eigenschaft sollte „true“ sein, wenn der Trennschalter geschlossen ist, aber „false“, wenn er geöffnet oder halb geöffnet ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-219">The `IsClosed` property should be true if the circuit breaker is closed, but false if it's open or half open.</span></span> <span data-ttu-id="919dc-220">Die Methode `Trip` schaltet den Zustand des Trennschalters in den Zustand „Geöffnet“ und zeichnet die Ausnahme auf, die zur Zustandsänderung geführt hat, sowie das Datum und die Uhrzeit, zu der die Ausnahme aufgetreten ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-220">The `Trip` method switches the state of the circuit breaker to the open state and records the exception that caused the change in state, together with the date and time that the exception occurred.</span></span> <span data-ttu-id="919dc-221">Die Eigenschaften `LastException` und `LastStateChangedDateUtc` geben diese Informationen zurück.</span><span class="sxs-lookup"><span data-stu-id="919dc-221">The `LastException` and the `LastStateChangedDateUtc` properties return this information.</span></span> <span data-ttu-id="919dc-222">Die Methode `Reset` schließt den Trennschalter und die Methode `HalfOpen` legt den Trennschalter auf „Halb geöffnet“ fest.</span><span class="sxs-lookup"><span data-stu-id="919dc-222">The `Reset` method closes the circuit breaker, and the `HalfOpen` method sets the circuit breaker to half open.</span></span>

<span data-ttu-id="919dc-223">Die Klasse `InMemoryCircuitBreakerStateStore` enthält in diesem Beispiel eine Implementierung der Schnittstelle `ICircuitBreakerStateStore`.</span><span class="sxs-lookup"><span data-stu-id="919dc-223">The `InMemoryCircuitBreakerStateStore` class in the example contains an implementation of the `ICircuitBreakerStateStore` interface.</span></span> <span data-ttu-id="919dc-224">Die Klasse `CircuitBreaker` erstellt eine Instanz dieser Klasse, um den Zustand des Trennschalters aufzunehmen.</span><span class="sxs-lookup"><span data-stu-id="919dc-224">The `CircuitBreaker` class creates an instance of this class to hold the state of the circuit breaker.</span></span>

<span data-ttu-id="919dc-225">Die `ExecuteAction`-Methode in der `CircuitBreaker`-Klasse dient als Wrapper für einen Vorgang, der als `Action`-Delegat angegeben ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-225">The `ExecuteAction` method in the `CircuitBreaker` class wraps an operation, specified as an `Action` delegate.</span></span> <span data-ttu-id="919dc-226">Wenn der Trennschalter geschlossen ist, ruft `ExecuteAction` den Delegat `Action` auf.</span><span class="sxs-lookup"><span data-stu-id="919dc-226">If the circuit breaker is closed, `ExecuteAction` invokes the `Action` delegate.</span></span> <span data-ttu-id="919dc-227">Wenn der Vorgang fehlerhaft ist, ruft ein Ausnahmehandler `TrackException` auf, wodurch der Trennschalter in den Zustand „Geöffnet“ versetzt wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-227">If the operation fails, an exception handler calls `TrackException`, which sets the circuit breaker state to open.</span></span> <span data-ttu-id="919dc-228">Im folgende Codebeispiel wird dieser Ablauf hervorgehoben.</span><span class="sxs-lookup"><span data-stu-id="919dc-228">The following code example highlights this flow.</span></span>

```csharp
public class CircuitBreaker
{
  private readonly ICircuitBreakerStateStore stateStore =
    CircuitBreakerStateStoreFactory.GetCircuitBreakerStateStore();

  private readonly object halfOpenSyncObject = new object ();
  ...
  public bool IsClosed { get { return stateStore.IsClosed; } }

  public bool IsOpen { get { return !IsClosed; } }

  public void ExecuteAction(Action action)
  {
    ...
    if (IsOpen)
    {
      // The circuit breaker is Open.
      ... (see code sample below for details)
    }

    // The circuit breaker is Closed, execute the action.
    try
    {
      action();
    }
    catch (Exception ex)
    {
      // If an exception still occurs here, simply
      // retrip the breaker immediately.
      this.TrackException(ex);

      // Throw the exception so that the caller can tell
      // the type of exception that was thrown.
      throw;
    }
  }

  private void TrackException(Exception ex)
  {
    // For simplicity in this example, open the circuit breaker on the first exception.
    // In reality this would be more complex. A certain type of exception, such as one
    // that indicates a service is offline, might trip the circuit breaker immediately.
    // Alternatively it might count exceptions locally or across multiple instances and
    // use this value over time, or the exception/success ratio based on the exception
    // types, to open the circuit breaker.
    this.stateStore.Trip(ex);
  }
}
```

<span data-ttu-id="919dc-229">Das folgende Beispiel zeigt den Code (im vorherigen Beispiel ausgelassen), der ausgeführt wird, wenn der Trennschalter nicht geschlossen ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-229">The following example shows the code (omitted from the previous example) that is executed if the circuit breaker isn't closed.</span></span> <span data-ttu-id="919dc-230">Zuerst wird geprüft, ob der Trennschalter für einen längeren Zeitraum als die durch das lokale Feld `OpenToHalfOpenWaitTime` in der Klasse `CircuitBreaker` vorgegebene Zeit geöffnet war.</span><span class="sxs-lookup"><span data-stu-id="919dc-230">It first checks if the circuit breaker has been open for a period longer than the time specified by the local `OpenToHalfOpenWaitTime` field in the `CircuitBreaker` class.</span></span> <span data-ttu-id="919dc-231">In diesem Fall legt die `ExecuteAction`-Methode den Trennschalter auf „Halb geöffnet“ fest und versucht dann, den vom Delegaten `Action` angegebenen Vorgang auszuführen.</span><span class="sxs-lookup"><span data-stu-id="919dc-231">If this is the case, the `ExecuteAction` method sets the circuit breaker to half open, then tries to perform the operation specified by the `Action` delegate.</span></span>

<span data-ttu-id="919dc-232">Wenn der Vorgang erfolgreich ist, wird der Trennschalter in den Zustand „Geschlossen“ zurückgesetzt.</span><span class="sxs-lookup"><span data-stu-id="919dc-232">If the operation is successful, the circuit breaker is reset to the closed state.</span></span> <span data-ttu-id="919dc-233">Wenn der Vorgang fehlerhaft ist, wird er in den Zustand „Geöffnet“ zurückversetzt und der Zeitpunkt, zu dem die Ausnahme aufgetreten ist, wird aktualisiert, sodass der Trennschalter eine weitere Zeitspanne wartet, bevor er erneut versucht, den Vorgang auszuführen.</span><span class="sxs-lookup"><span data-stu-id="919dc-233">If the operation fails, it is tripped back to the open state and the time the exception occurred is updated so that the circuit breaker will wait for a further period before trying to perform the operation again.</span></span>

<span data-ttu-id="919dc-234">Wenn der Trennschalter nur kurzzeitig geöffnet war (kürzer als durch den Wert `OpenToHalfOpenWaitTime` angegeben), löst die Methode `ExecuteAction` einfach eine `CircuitBreakerOpenException`-Ausnahme aus und gibt den Fehler zurück, der den Übergang des Trennschalters in den Zustand „Geöffnet“ verursacht hat.</span><span class="sxs-lookup"><span data-stu-id="919dc-234">If the circuit breaker has only been open for a short time, less than the `OpenToHalfOpenWaitTime` value, the `ExecuteAction` method simply throws a `CircuitBreakerOpenException` exception and returns the error that caused the circuit breaker to transition to the open state.</span></span>

<span data-ttu-id="919dc-235">Darüber hinaus verwendet er eine Sperre, um zu verhindern, dass der Trennschalter versucht, gleichzeitige Aufrufe des Vorgangs durchzuführen, während er halb geöffnet ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-235">Additionally, it uses a lock to prevent the circuit breaker from trying to perform concurrent calls to the operation while it's half open.</span></span> <span data-ttu-id="919dc-236">Ein gleichzeitiger Versuch zum Aufrufen des Vorgangs wird so behandelt, als ob der Trennschalter geöffnet wäre, und er wird mit einer Ausnahme fehlerhaft beendet, wie später beschrieben.</span><span class="sxs-lookup"><span data-stu-id="919dc-236">A concurrent attempt to invoke the operation will be handled as if the circuit breaker was open, and it'll fail with an exception as described later.</span></span>

```csharp
    ...
    if (IsOpen)
    {
      // The circuit breaker is Open. Check if the Open timeout has expired.
      // If it has, set the state to HalfOpen. Another approach might be to
      // check for the HalfOpen state that had be set by some other operation.
      if (stateStore.LastStateChangedDateUtc + OpenToHalfOpenWaitTime < DateTime.UtcNow)
      {
        // The Open timeout has expired. Allow one operation to execute. Note that, in
        // this example, the circuit breaker is set to HalfOpen after being
        // in the Open state for some period of time. An alternative would be to set
        // this using some other approach such as a timer, test method, manually, and
        // so on, and check the state here to determine how to handle execution
        // of the action.
        // Limit the number of threads to be executed when the breaker is HalfOpen.
        // An alternative would be to use a more complex approach to determine which
        // threads or how many are allowed to execute, or to execute a simple test
        // method instead.
        bool lockTaken = false;
        try
        {
          Monitor.TryEnter(halfOpenSyncObject, ref lockTaken);
          if (lockTaken)
          {
            // Set the circuit breaker state to HalfOpen.
            stateStore.HalfOpen();

            // Attempt the operation.
            action();

            // If this action succeeds, reset the state and allow other operations.
            // In reality, instead of immediately returning to the Closed state, a counter
            // here would record the number of successful operations and return the
            // circuit breaker to the Closed state only after a specified number succeed.
            this.stateStore.Reset();
            return;
          }
        }
        catch (Exception ex)
        {
          // If there's still an exception, trip the breaker again immediately.
          this.stateStore.Trip(ex);

          // Throw the exception so that the caller knows which exception occurred.
          throw;
        }
        finally
        {
          if (lockTaken)
          {
            Monitor.Exit(halfOpenSyncObject);
          }
        }
      }
      // The Open timeout hasn't yet expired. Throw a CircuitBreakerOpen exception to
      // inform the caller that the call was not actually attempted,
      // and return the most recent exception received.
      throw new CircuitBreakerOpenException(stateStore.LastException);
    }
    ...
```

<span data-ttu-id="919dc-237">Wenn Sie ein `CircuitBreaker`-Objekt zum Schutz eines Vorgangs verwenden möchten, erstellt eine Anwendung eine Instanz der Klasse `CircuitBreaker` und ruft die Methode `ExecuteAction` auf, wobei der auszuführende Vorgang als Parameter angegeben wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-237">To use a `CircuitBreaker` object to protect an operation, an application creates an instance of the `CircuitBreaker` class and invokes the `ExecuteAction` method, specifying the operation to be performed as the parameter.</span></span> <span data-ttu-id="919dc-238">Die Anwendung sollte darauf vorbereitet sein, die Ausnahme `CircuitBreakerOpenException` abzufangen, wenn der Vorgang fehlerhaft beendet wird, da der Trennschalter geöffnet ist.</span><span class="sxs-lookup"><span data-stu-id="919dc-238">The application should be prepared to catch the `CircuitBreakerOpenException` exception if the operation fails because the circuit breaker is open.</span></span> <span data-ttu-id="919dc-239">Der folgende Code zeigt ein Beispiel:</span><span class="sxs-lookup"><span data-stu-id="919dc-239">The following code shows an example:</span></span>

```csharp
var breaker = new CircuitBreaker();

try
{
  breaker.ExecuteAction(() =>
  {
    // Operation protected by the circuit breaker.
    ...
  });
}
catch (CircuitBreakerOpenException ex)
{
  // Perform some different action when the breaker is open.
  // Last exception details are in the inner exception.
  ...
}
catch (Exception ex)
{
  ...
}
```

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="919dc-240">Zugehörige Muster und Anleitungen</span><span class="sxs-lookup"><span data-stu-id="919dc-240">Related patterns and guidance</span></span>

<span data-ttu-id="919dc-241">Die folgenden Muster können für die Implementierung dieses Musters relevant sein:</span><span class="sxs-lookup"><span data-stu-id="919dc-241">The following patterns might also be useful when implementing this pattern:</span></span>

- <span data-ttu-id="919dc-242">[Wiederholungsmuster][retry-pattern]:</span><span class="sxs-lookup"><span data-stu-id="919dc-242">[Retry Pattern][retry-pattern].</span></span> <span data-ttu-id="919dc-243">Beschreibt, wie eine Anwendung beim Herstellen einer Verbindung mit einem Dienst oder einer Netzwerkressource antizipierte, temporäre Fehler behandeln kann, indem ein zuvor nicht erfolgreich durchgeführter Vorgang transparent wiederholt wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-243">Describes how an application can handle anticipated temporary failures when it tries to connect to a service or network resource by transparently retrying an operation that has previously failed.</span></span>

- <span data-ttu-id="919dc-244">[Muster für Überwachung des Integritätsendpunkts](health-endpoint-monitoring.md):</span><span class="sxs-lookup"><span data-stu-id="919dc-244">[Health Endpoint Monitoring Pattern](health-endpoint-monitoring.md).</span></span> <span data-ttu-id="919dc-245">Ein Trennschalter könnte in der Lage sein, den Zustand eines Diensts zu testen, indem er eine Anforderung an einen Endpunkt sendet, der durch den Dienst exponiert wird.</span><span class="sxs-lookup"><span data-stu-id="919dc-245">A circuit breaker might be able to test the health of a service by sending a request to an endpoint exposed by the service.</span></span> <span data-ttu-id="919dc-246">Der Dienst sollte Informationen über seinen Zustand zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="919dc-246">The service should return information indicating its status.</span></span>


[retry-pattern]: ./retry.md

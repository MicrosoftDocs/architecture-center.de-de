---
title: Arbeiten mit anspruchsbasierten Identitäten in mehrinstanzenfähigen Anwendungen
description: Hier erfahren Sie, wie Sie Ansprüche zur Ausstellerüberprüfung und Autorisierung verwenden.
author: MikeWasson
ms.date: 07/21/2017
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: authenticate
pnp.series.next: signup
ms.openlocfilehash: 8b8cbd2b857493d94103e80f53f187207feaa11e
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 01/23/2019
ms.locfileid: "54486504"
---
# <a name="work-with-claims-based-identities"></a><span data-ttu-id="b21e9-103">Arbeiten mit anspruchsbasierten Identitäten</span><span class="sxs-lookup"><span data-stu-id="b21e9-103">Work with claims-based identities</span></span>

<span data-ttu-id="b21e9-104">[![GitHub](../_images/github.png)-Beispielcode][sample application]</span><span class="sxs-lookup"><span data-stu-id="b21e9-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

## <a name="claims-in-azure-ad"></a><span data-ttu-id="b21e9-105">Ansprüche in Azure AD</span><span class="sxs-lookup"><span data-stu-id="b21e9-105">Claims in Azure AD</span></span>

<span data-ttu-id="b21e9-106">Wenn sich ein Benutzer anmeldet, sendet Azure AD ein ID-Token, das einen Satz mit Ansprüchen des Benutzers enthält.</span><span class="sxs-lookup"><span data-stu-id="b21e9-106">When a user signs in, Azure AD sends an ID token that contains a set of claims about the user.</span></span> <span data-ttu-id="b21e9-107">Ein Anspruch ist eine einfache Information, die als Schlüssel-Wert-Paar ausgedrückt wird.</span><span class="sxs-lookup"><span data-stu-id="b21e9-107">A claim is simply a piece of information, expressed as a key/value pair.</span></span> <span data-ttu-id="b21e9-108">Beispiel: `email`=`bob@contoso.com`</span><span class="sxs-lookup"><span data-stu-id="b21e9-108">For example, `email`=`bob@contoso.com`.</span></span>  <span data-ttu-id="b21e9-109">Ansprüche haben einen Aussteller &mdash; in diesem Fall Azure AD &mdash;, bei dem es sich um die Entität handelt, die den Benutzer authentifiziert und die Ansprüche erstellt.</span><span class="sxs-lookup"><span data-stu-id="b21e9-109">Claims have an issuer &mdash; in this case, Azure AD &mdash; which is the entity that authenticates the user and creates the claims.</span></span> <span data-ttu-id="b21e9-110">Sie vertrauen den Ansprüchen, da Sie dem Aussteller vertrauen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-110">You trust the claims because you trust the issuer.</span></span> <span data-ttu-id="b21e9-111">(Wenn Sie umgekehrt dem Aussteller nicht trauen, vertrauen Sie nicht den Ansprüchen!)</span><span class="sxs-lookup"><span data-stu-id="b21e9-111">(Conversely, if you don't trust the issuer, don't trust the claims!)</span></span>

<span data-ttu-id="b21e9-112">Allgemeines:</span><span class="sxs-lookup"><span data-stu-id="b21e9-112">At a high level:</span></span>

1. <span data-ttu-id="b21e9-113">Der Benutzer wird authentifiziert.</span><span class="sxs-lookup"><span data-stu-id="b21e9-113">The user authenticates.</span></span>
2. <span data-ttu-id="b21e9-114">Der Identitätsanbieter sendet einen Satz von Ansprüchen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-114">The IDP sends a set of claims.</span></span>
3. <span data-ttu-id="b21e9-115">Die App normalisiert oder ergänzt die Ansprüche (optional).</span><span class="sxs-lookup"><span data-stu-id="b21e9-115">The app normalizes or augments the claims (optional).</span></span>
4. <span data-ttu-id="b21e9-116">Die App verwendet die Ansprüche, um Autorisierungsentscheidungen zu treffen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-116">The app uses the claims to make authorization decisions.</span></span>

<span data-ttu-id="b21e9-117">In OpenID Connect wird der Satz von Ansprüchen, den Sie erhalten, durch den [Bereichsparameter] der Authentifizierungsanforderung gesteuert.</span><span class="sxs-lookup"><span data-stu-id="b21e9-117">In OpenID Connect, the set of claims that you get is controlled by the [scope parameter] of the authentication request.</span></span> <span data-ttu-id="b21e9-118">Azure AD gibt jedoch einen eingeschränkten Satz von Ansprüchen über OpenID Connect aus. Informationen dazu finden Sie unter [Unterstützte Token- und Anspruchstypen].</span><span class="sxs-lookup"><span data-stu-id="b21e9-118">However, Azure AD issues a limited set of claims through OpenID Connect; see [Supported Token and Claim Types].</span></span> <span data-ttu-id="b21e9-119">Wenn Sie mehr Informationen über den Benutzer wünschen, müssen Sie die Azure AD Graph-API verwenden.</span><span class="sxs-lookup"><span data-stu-id="b21e9-119">If you want more information about the user, you'll need to use the Azure AD Graph API.</span></span>

<span data-ttu-id="b21e9-120">Hier sind einige der Ansprüche aus AAD, die eine App in der Regel interessieren:</span><span class="sxs-lookup"><span data-stu-id="b21e9-120">Here are some of the claims from AAD that an app might typically care about:</span></span>

| <span data-ttu-id="b21e9-121">Typ des Anspruchs im ID-Token</span><span class="sxs-lookup"><span data-stu-id="b21e9-121">Claim type in ID token</span></span> | <span data-ttu-id="b21e9-122">BESCHREIBUNG</span><span class="sxs-lookup"><span data-stu-id="b21e9-122">Description</span></span> |
| --- | --- |
| <span data-ttu-id="b21e9-123">aud</span><span class="sxs-lookup"><span data-stu-id="b21e9-123">aud</span></span> |<span data-ttu-id="b21e9-124">Der Empfänger, für den das Token ausgestellt wurde.</span><span class="sxs-lookup"><span data-stu-id="b21e9-124">Who the token was issued for.</span></span> <span data-ttu-id="b21e9-125">Dies ist die Client-ID der Anwendung.</span><span class="sxs-lookup"><span data-stu-id="b21e9-125">This will be the application's client ID.</span></span> <span data-ttu-id="b21e9-126">Im Allgemeinen müssen Sie sich nicht um diesen Anspruch kümmern, da er von der Middleware automatisch überprüft wird.</span><span class="sxs-lookup"><span data-stu-id="b21e9-126">Generally, you shouldn't need to worry about this claim, because the middleware automatically validates it.</span></span> <span data-ttu-id="b21e9-127">Beispiel: `"91464657-d17a-4327-91f3-2ed99386406f"`</span><span class="sxs-lookup"><span data-stu-id="b21e9-127">Example:  `"91464657-d17a-4327-91f3-2ed99386406f"`</span></span> |
| <span data-ttu-id="b21e9-128">groups</span><span class="sxs-lookup"><span data-stu-id="b21e9-128">groups</span></span> |<span data-ttu-id="b21e9-129">Eine Liste mit AAD-Gruppen, deren Mitglied der Benutzer ist.</span><span class="sxs-lookup"><span data-stu-id="b21e9-129">A list of AAD groups of which the user is a member.</span></span> <span data-ttu-id="b21e9-130">Beispiel: `["93e8f556-8661-4955-87b6-890bc043c30f", "fc781505-18ef-4a31-a7d5-7d931d7b857e"]`</span><span class="sxs-lookup"><span data-stu-id="b21e9-130">Example: `["93e8f556-8661-4955-87b6-890bc043c30f", "fc781505-18ef-4a31-a7d5-7d931d7b857e"]`</span></span> |
| <span data-ttu-id="b21e9-131">iss</span><span class="sxs-lookup"><span data-stu-id="b21e9-131">iss</span></span> |<span data-ttu-id="b21e9-132">Der [Aussteller] des OIDC-Tokens.</span><span class="sxs-lookup"><span data-stu-id="b21e9-132">The [issuer] of the OIDC token.</span></span> <span data-ttu-id="b21e9-133">Beispiel: `https://sts.windows.net/b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4/`</span><span class="sxs-lookup"><span data-stu-id="b21e9-133">Example: `https://sts.windows.net/b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4/`</span></span> |
| <span data-ttu-id="b21e9-134">name</span><span class="sxs-lookup"><span data-stu-id="b21e9-134">name</span></span> |<span data-ttu-id="b21e9-135">Anzeigename des Benutzers.</span><span class="sxs-lookup"><span data-stu-id="b21e9-135">The user's display name.</span></span> <span data-ttu-id="b21e9-136">Beispiel: `"Alice A."`</span><span class="sxs-lookup"><span data-stu-id="b21e9-136">Example: `"Alice A."`</span></span> |
| <span data-ttu-id="b21e9-137">oid</span><span class="sxs-lookup"><span data-stu-id="b21e9-137">oid</span></span> |<span data-ttu-id="b21e9-138">Der Objektbezeichner des Benutzers im AAD.</span><span class="sxs-lookup"><span data-stu-id="b21e9-138">The object identifier for the user in AAD.</span></span> <span data-ttu-id="b21e9-139">Dieser Wert ist der unveränderliche und nicht wiederverwendbare Bezeichner des Benutzers.</span><span class="sxs-lookup"><span data-stu-id="b21e9-139">This value is the immutable and non-reusable identifier of the user.</span></span> <span data-ttu-id="b21e9-140">Verwenden Sie diesen Wert, nicht „email“, als eindeutigen Bezeichner für Benutzer, denn E-Mail-Adressen können sich ändern.</span><span class="sxs-lookup"><span data-stu-id="b21e9-140">Use this value, not email, as a unique identifier for users; email addresses can change.</span></span> <span data-ttu-id="b21e9-141">Wenn Sie die Azure AD Graph-API in Ihrer App verwenden, ist die Objekt-ID der Wert, der zum Abfragen von Profilinformationen verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="b21e9-141">If you use the Azure AD Graph API in your app, object ID is that value used to query profile information.</span></span> <span data-ttu-id="b21e9-142">Beispiel: `"59f9d2dc-995a-4ddf-915e-b3bb314a7fa4"`</span><span class="sxs-lookup"><span data-stu-id="b21e9-142">Example: `"59f9d2dc-995a-4ddf-915e-b3bb314a7fa4"`</span></span> |
| <span data-ttu-id="b21e9-143">roles</span><span class="sxs-lookup"><span data-stu-id="b21e9-143">roles</span></span> |<span data-ttu-id="b21e9-144">Eine Liste der App-Rollen des Benutzers.</span><span class="sxs-lookup"><span data-stu-id="b21e9-144">A list of app roles for the user.</span></span>    <span data-ttu-id="b21e9-145">Beispiel: `["SurveyCreator"]`</span><span class="sxs-lookup"><span data-stu-id="b21e9-145">Example: `["SurveyCreator"]`</span></span> |
| <span data-ttu-id="b21e9-146">tid</span><span class="sxs-lookup"><span data-stu-id="b21e9-146">tid</span></span> |<span data-ttu-id="b21e9-147">Mandanten-ID.</span><span class="sxs-lookup"><span data-stu-id="b21e9-147">Tenant ID.</span></span> <span data-ttu-id="b21e9-148">Dieser Wert ist ein eindeutiger Bezeichner für den Mandanten in Azure AD.</span><span class="sxs-lookup"><span data-stu-id="b21e9-148">This value is a unique identifier for the tenant in Azure AD.</span></span> <span data-ttu-id="b21e9-149">Beispiel: `"b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4"`</span><span class="sxs-lookup"><span data-stu-id="b21e9-149">Example: `"b9bd2162-77ac-4fb2-8254-5c36e9c0a9c4"`</span></span> |
| <span data-ttu-id="b21e9-150">unique_name</span><span class="sxs-lookup"><span data-stu-id="b21e9-150">unique_name</span></span> |<span data-ttu-id="b21e9-151">Ein vom Menschen lesbarer Anzeigename des Benutzers.</span><span class="sxs-lookup"><span data-stu-id="b21e9-151">A human readable display name of the user.</span></span> <span data-ttu-id="b21e9-152">Beispiel: `"alice@contoso.com"`</span><span class="sxs-lookup"><span data-stu-id="b21e9-152">Example: `"alice@contoso.com"`</span></span> |
| <span data-ttu-id="b21e9-153">upn</span><span class="sxs-lookup"><span data-stu-id="b21e9-153">upn</span></span> |<span data-ttu-id="b21e9-154">Benutzerprinzipalname.</span><span class="sxs-lookup"><span data-stu-id="b21e9-154">User principal name.</span></span> <span data-ttu-id="b21e9-155">Beispiel: `"alice@contoso.com"`</span><span class="sxs-lookup"><span data-stu-id="b21e9-155">Example: `"alice@contoso.com"`</span></span> |

<span data-ttu-id="b21e9-156">Diese Tabelle enthält die Anspruchstypen, wie sie im ID-Token angezeigt werden.</span><span class="sxs-lookup"><span data-stu-id="b21e9-156">This table lists the claim types as they appear in the ID token.</span></span> <span data-ttu-id="b21e9-157">In ASP.NET Core konvertiert die OpenID Connect-Middleware einige der Anspruchstypen, wenn die „Claims“-Auflistung für den Benutzerprinzipal aufgefüllt wird:</span><span class="sxs-lookup"><span data-stu-id="b21e9-157">In ASP.NET Core, the OpenID Connect middleware converts some of the claim types when it populates the Claims collection for the user principal:</span></span>

* <span data-ttu-id="b21e9-158">oid > `http://schemas.microsoft.com/identity/claims/objectidentifier`</span><span class="sxs-lookup"><span data-stu-id="b21e9-158">oid > `http://schemas.microsoft.com/identity/claims/objectidentifier`</span></span>
* <span data-ttu-id="b21e9-159">tid > `http://schemas.microsoft.com/identity/claims/tenantid`</span><span class="sxs-lookup"><span data-stu-id="b21e9-159">tid > `http://schemas.microsoft.com/identity/claims/tenantid`</span></span>
* <span data-ttu-id="b21e9-160">unique_name > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`</span><span class="sxs-lookup"><span data-stu-id="b21e9-160">unique_name > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`</span></span>
* <span data-ttu-id="b21e9-161">upn > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn`</span><span class="sxs-lookup"><span data-stu-id="b21e9-161">upn > `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn`</span></span>

## <a name="claims-transformations"></a><span data-ttu-id="b21e9-162">Transformationen von Ansprüchen</span><span class="sxs-lookup"><span data-stu-id="b21e9-162">Claims transformations</span></span>

<span data-ttu-id="b21e9-163">Während des Authentifizierungsvorgangs empfiehlt es sich, die Ansprüche zu ändern, die Sie vom Identitätsanbieter erhalten.</span><span class="sxs-lookup"><span data-stu-id="b21e9-163">During the authentication flow, you might want to modify the claims that you get from the IDP.</span></span> <span data-ttu-id="b21e9-164">In ASP.NET Core können Sie eine Transformation von Ansprüchen innerhalb des **AuthenticationValidated**-Ereignisses von der OpenID Connect-Middleware ausführen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-164">In ASP.NET Core, you can perform claims transformation inside of the **AuthenticationValidated** event from the OpenID Connect middleware.</span></span> <span data-ttu-id="b21e9-165">(Informationen finden Sie unter [Authentifizierungsereignisse].)</span><span class="sxs-lookup"><span data-stu-id="b21e9-165">(See [Authentication events].)</span></span>

<span data-ttu-id="b21e9-166">Alle Ansprüche, die Sie während des **AuthenticationValidated** -Ereignisses hinzufügen, werden im Authentifizierungscookie der Sitzung gespeichert.</span><span class="sxs-lookup"><span data-stu-id="b21e9-166">Any claims that you add during **AuthenticationValidated** are stored in the session authentication cookie.</span></span> <span data-ttu-id="b21e9-167">Sie werden nicht per Push zurück an Azure AD übertragen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-167">They don't get pushed back to Azure AD.</span></span>

<span data-ttu-id="b21e9-168">Hier einige Beispiele für die Transformation von Ansprüchen:</span><span class="sxs-lookup"><span data-stu-id="b21e9-168">Here are some examples of claims transformation:</span></span>

* <span data-ttu-id="b21e9-169">**Normalisierung von Ansprüchen** oder Schaffung konsistenter Ansprüche für alle Benutzer.</span><span class="sxs-lookup"><span data-stu-id="b21e9-169">**Claims normalization**, or making claims consistent across users.</span></span> <span data-ttu-id="b21e9-170">Dies trifft insbesondere zu, wenn Sie Ansprüche von mehreren Identitätsanbietern erhalten, die möglicherweise unterschiedliche Anspruchstypen für ähnliche Informationen verwenden.</span><span class="sxs-lookup"><span data-stu-id="b21e9-170">This is particularly relevant if you are getting claims from multiple IDPs, which might use different claim types for similar information.</span></span> <span data-ttu-id="b21e9-171">Beispielsweise sendet Azure AD einen „upn“-Anspruch, der die E-Mail-Adresse des Benutzers enthält.</span><span class="sxs-lookup"><span data-stu-id="b21e9-171">For example, Azure AD sends a "upn" claim that contains the user's email.</span></span> <span data-ttu-id="b21e9-172">Andere Identitätsanbieter senden möglicherweise einen „email“-Anspruch.</span><span class="sxs-lookup"><span data-stu-id="b21e9-172">Other IDPs might send an "email" claim.</span></span> <span data-ttu-id="b21e9-173">Der folgende Code konvertiert den „upn“-Anspruch in einen „email“-Anspruch:</span><span class="sxs-lookup"><span data-stu-id="b21e9-173">The following code converts the "upn" claim into an "email" claim:</span></span>

  ```csharp
  var email = principal.FindFirst(ClaimTypes.Upn)?.Value;
  if (!string.IsNullOrWhiteSpace(email))
  {
      identity.AddClaim(new Claim(ClaimTypes.Email, email));
  }
  ```

* <span data-ttu-id="b21e9-174">Hinzufügen **standardmäßiger Anspruchswerte** für Ansprüche, die nicht vorhanden sind, z. B. Zuweisen eines Benutzers zu einer Standardrolle.</span><span class="sxs-lookup"><span data-stu-id="b21e9-174">Add **default claim values** for claims that aren't present &mdash; for example, assigning a user to a default role.</span></span> <span data-ttu-id="b21e9-175">In einigen Fällen kann dies die Autorisierungslogik vereinfachen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-175">In some cases this can simplify authorization logic.</span></span>
* <span data-ttu-id="b21e9-176">Hinzufügen **benutzerdefinierter Anspruchstypen** mit anwendungsspezifischen Informationen über den Benutzer.</span><span class="sxs-lookup"><span data-stu-id="b21e9-176">Add **custom claim types** with application-specific information about the user.</span></span> <span data-ttu-id="b21e9-177">Beispielsweise können Sie einige Informationen über den Benutzer in einer Datenbank speichern und</span><span class="sxs-lookup"><span data-stu-id="b21e9-177">For example, you might store some information about the user in a database.</span></span> <span data-ttu-id="b21e9-178">einen benutzerdefinierten Anspruch mit diesen Informationen zum Authentifizierungsticket hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-178">You could add a custom claim with this information to the authentication ticket.</span></span> <span data-ttu-id="b21e9-179">Der Anspruch wird in einem Cookie gespeichert, sodass Sie ihn nur einmal pro Anmeldesitzung aus der Datenbank abrufen müssen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-179">The claim is stored in a cookie, so you only need to get it from the database once per login session.</span></span> <span data-ttu-id="b21e9-180">Andererseits sollte auch die Erstellung übermäßig großer Cookies verhindert werden, sodass Sie zwischen Cookiegröße und Datenbanksuchen abwägen müssen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-180">On the other hand, you also want to avoid creating excessively large cookies, so you need to consider the trade-off between cookie size versus database lookups.</span></span>

<span data-ttu-id="b21e9-181">Nach Abschluss des Authentifizierungsvorgangs stehen die Ansprüche in `HttpContext.User`zur Verfügung.</span><span class="sxs-lookup"><span data-stu-id="b21e9-181">After the authentication flow is complete, the claims are available in `HttpContext.User`.</span></span> <span data-ttu-id="b21e9-182">An diesem Punkt sollten Sie sie als eine schreibgeschützte Auflistung behandeln und z. B. zum Treffen von Autorisierungsentscheidungen verwenden.</span><span class="sxs-lookup"><span data-stu-id="b21e9-182">At that point, you should treat them as a read-only collection &mdash; e.g., use them to make authorization decisions.</span></span>

## <a name="issuer-validation"></a><span data-ttu-id="b21e9-183">Überprüfung des Ausstellers</span><span class="sxs-lookup"><span data-stu-id="b21e9-183">Issuer validation</span></span>

<span data-ttu-id="b21e9-184">In OpenID Connect (OIDC) identifiziert der Ausstelleranspruch (iss) den Identitätsanbieter, der das ID-Token ausgestellt hat.</span><span class="sxs-lookup"><span data-stu-id="b21e9-184">In OpenID Connect, the issuer claim ("iss") identifies the IDP that issued the ID token.</span></span> <span data-ttu-id="b21e9-185">Im Rahmen des OIDC-Authentifizierungsvorgangs muss überprüft werden, ob der Ausstelleranspruch dem tatsächlichen Aussteller entspricht.</span><span class="sxs-lookup"><span data-stu-id="b21e9-185">Part of the OIDC authentication flow is to verify that the issuer claim matches the actual issuer.</span></span> <span data-ttu-id="b21e9-186">Dies übernimmt die OIDC-Middleware für Sie.</span><span class="sxs-lookup"><span data-stu-id="b21e9-186">The OIDC middleware handles this for you.</span></span>

<span data-ttu-id="b21e9-187">In Azure AD ist der „issuer“-Wert pro AD-Mandant eindeutig (`https://sts.windows.net/<tenantID>`).</span><span class="sxs-lookup"><span data-stu-id="b21e9-187">In Azure AD, the issuer value is unique per AD tenant (`https://sts.windows.net/<tenantID>`).</span></span> <span data-ttu-id="b21e9-188">Deshalb sollte eine Anwendung eine zusätzliche Prüfung vornehmen, um sicherzustellen, dass der Aussteller einen Mandanten darstellt, der sich bei der App anmelden darf.</span><span class="sxs-lookup"><span data-stu-id="b21e9-188">Therefore, an application should do an additional check, to make sure the issuer represents a tenant that is allowed to sign in to the app.</span></span>

<span data-ttu-id="b21e9-189">Bei einer Anwendung mit nur einem Mandanten können Sie prüfen, ob der Aussteller Ihr eigener Mandant ist.</span><span class="sxs-lookup"><span data-stu-id="b21e9-189">For a single-tenant application, you can just check that the issuer is your own tenant.</span></span> <span data-ttu-id="b21e9-190">Diesen Schritt führt die OIDC-Middleware standardmäßig automatisch aus.</span><span class="sxs-lookup"><span data-stu-id="b21e9-190">In fact, the OIDC middleware does this automatically by default.</span></span> <span data-ttu-id="b21e9-191">Bei einer App mit mehreren Mandanten müssen Sie entsprechend den verschiedenen Mandanten mehrere Aussteller zulassen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-191">In a multi-tenant app, you need to allow for multiple issuers, corresponding to the different tenants.</span></span> <span data-ttu-id="b21e9-192">Es folgt eine empfohlene Vorgehensweise:</span><span class="sxs-lookup"><span data-stu-id="b21e9-192">Here is a general approach to use:</span></span>

* <span data-ttu-id="b21e9-193">Legen Sie in den Optionen der OIDC-Middleware **ValidateIssuer** auf „false“ fest.</span><span class="sxs-lookup"><span data-stu-id="b21e9-193">In the OIDC middleware options, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="b21e9-194">Dadurch wird die automatische Prüfung deaktiviert.</span><span class="sxs-lookup"><span data-stu-id="b21e9-194">This turns off the automatic check.</span></span>
* <span data-ttu-id="b21e9-195">Wenn sich ein Mandant anmeldet, speichern Sie den Mandanten und den Aussteller in der Benutzerdatenbank.</span><span class="sxs-lookup"><span data-stu-id="b21e9-195">When a tenant signs up, store the tenant and the issuer in your user DB.</span></span>
* <span data-ttu-id="b21e9-196">Wenn sich ein Benutzer anmeldet, schlagen Sie den Aussteller in der Datenbank nach.</span><span class="sxs-lookup"><span data-stu-id="b21e9-196">Whenever a user signs in, look up the issuer in the database.</span></span> <span data-ttu-id="b21e9-197">Wenn der Aussteller nicht gefunden wird, bedeutet dies, dass sich dieser Mandant nicht registriert hat.</span><span class="sxs-lookup"><span data-stu-id="b21e9-197">If the issuer isn't found, it means that tenant hasn't signed up.</span></span> <span data-ttu-id="b21e9-198">Sie können ihn zu einer Registrierungsseite umleiten.</span><span class="sxs-lookup"><span data-stu-id="b21e9-198">You can redirect them to a sign up page.</span></span>
* <span data-ttu-id="b21e9-199">Sie können auch bestimmte Mandanten auf eine Blockliste setzen, z. B. für Kunden, die ihr Abonnement nicht bezahlt haben.</span><span class="sxs-lookup"><span data-stu-id="b21e9-199">You could also blacklist certain tenants; for example, for customers that didn't pay their subscription.</span></span>

<span data-ttu-id="b21e9-200">Eine ausführlichere Beschreibung finden Sie unter [Registrierung und Onboarding von Mandanten in einer mehrmandantenfähigen Anwendung][signup].</span><span class="sxs-lookup"><span data-stu-id="b21e9-200">For a more detailed discussion, see [Sign-up and tenant onboarding in a multitenant application][signup].</span></span>

## <a name="using-claims-for-authorization"></a><span data-ttu-id="b21e9-201">Verwenden von Ansprüchen für die Autorisierung</span><span class="sxs-lookup"><span data-stu-id="b21e9-201">Using claims for authorization</span></span>

<span data-ttu-id="b21e9-202">Mit Ansprüchen ist die Identität eines Benutzers keine monolithische Entität mehr.</span><span class="sxs-lookup"><span data-stu-id="b21e9-202">With claims, a user's identity is no longer a monolithic entity.</span></span> <span data-ttu-id="b21e9-203">Für einen Benutzer können z. B. E-Mail-Adresse, Telefonnummer, Geburtstag, Geschlecht usw. angegeben sein. Möglicherweise speichert der Identitätsanbieter des Benutzers alle diese Informationen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-203">For example, a user might have an email address, phone number, birthday, gender, etc. Maybe the user's IDP stores all of this information.</span></span> <span data-ttu-id="b21e9-204">Wenn Sie aber den Benutzer authentifizieren, erhalten Sie in der Regel eine Teilmenge dieser Angaben als Ansprüche.</span><span class="sxs-lookup"><span data-stu-id="b21e9-204">But when you authenticate the user, you'll typically get a subset of these as claims.</span></span> <span data-ttu-id="b21e9-205">In diesem Modell ist die Identität des Benutzers einfach ein Bündel von Ansprüchen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-205">In this model, the user's identity is simply a bundle of claims.</span></span> <span data-ttu-id="b21e9-206">Wenn Sie Autorisierungsentscheidungen für einen Benutzer treffen, suchen Sie nach bestimmten Sätzen von Ansprüchen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-206">When you make authorization decisions about a user, you will look for particular sets of claims.</span></span> <span data-ttu-id="b21e9-207">Das heißt, die Frage „Kann Benutzer X die Aktion Y ausführen“ wird letztlich zur Frage „Verfügt Benutzer X über Anspruch Z“.</span><span class="sxs-lookup"><span data-stu-id="b21e9-207">In other words, the question "Can user X perform action Y" ultimately becomes "Does user X have claim Z".</span></span>

<span data-ttu-id="b21e9-208">Es folgen einige grundlegende Muster für die Überprüfung von Ansprüchen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-208">Here are some basic patterns for checking claims.</span></span>

* <span data-ttu-id="b21e9-209">So überprüfen Sie, ob der Benutzer einen bestimmten Anspruch mit einem bestimmten Wert hat:</span><span class="sxs-lookup"><span data-stu-id="b21e9-209">To check that the user has a particular claim with a particular value:</span></span>

   ```csharp
   if (User.HasClaim(ClaimTypes.Role, "Admin")) { ... }
   ```

   <span data-ttu-id="b21e9-210">Dieser Code prüft, ob der Benutzer einen Rollenanspruch mit dem Wert „Admin“ hat.</span><span class="sxs-lookup"><span data-stu-id="b21e9-210">This code checks whether the user has a Role claim with the value "Admin".</span></span> <span data-ttu-id="b21e9-211">Er verarbeitet ordnungsgemäß den Fall, bei dem der Benutzer keine oder mehrere Rollenansprüche hat.</span><span class="sxs-lookup"><span data-stu-id="b21e9-211">It correctly handles the case where the user has no Role claim or multiple Role claims.</span></span>
  
   <span data-ttu-id="b21e9-212">Die **ClaimTypes** -Klasse definiert Konstanten für häufig verwendete Anspruchstypen.</span><span class="sxs-lookup"><span data-stu-id="b21e9-212">The **ClaimTypes** class defines constants for commonly-used claim types.</span></span> <span data-ttu-id="b21e9-213">Dennoch können Sie einen beliebigen Zeichenfolgenwert für den Anspruchstyp verwenden.</span><span class="sxs-lookup"><span data-stu-id="b21e9-213">However, you can use any string value for the claim type.</span></span>
* <span data-ttu-id="b21e9-214">So rufen Sie einen einzelnen Wert für einen Anspruchstyp ab, wenn Sie mindestens einen Wert erwarten:</span><span class="sxs-lookup"><span data-stu-id="b21e9-214">To get a single value for a claim type, when you expect there to be at most one value:</span></span>

  ```csharp
  string email = User.FindFirst(ClaimTypes.Email)?.Value;
  ```

* <span data-ttu-id="b21e9-215">So rufen Sie alle Werte für einen Anspruchstyp ab:</span><span class="sxs-lookup"><span data-stu-id="b21e9-215">To get all the values for a claim type:</span></span>

  ```csharp
  IEnumerable<Claim> groups = User.FindAll("groups");
  ```

<span data-ttu-id="b21e9-216">Weitere Informationen finden Sie unter [Rollen- und ressourcenbasierte Autorisierung in mehrinstanzenfähigen Anwendungen][authorization].</span><span class="sxs-lookup"><span data-stu-id="b21e9-216">For more information, see [Role-based and resource-based authorization in multitenant applications][authorization].</span></span>

<span data-ttu-id="b21e9-217">[**Weiter**][signup]</span><span class="sxs-lookup"><span data-stu-id="b21e9-217">[**Next**][signup]</span></span>

<!-- links -->

[Bereichsparameter]: https://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/
[scope parameter]: https://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/
[Unterstützte Token- und Anspruchstypen]: /azure/active-directory/active-directory-token-and-claims/
[Supported Token and Claim Types]: /azure/active-directory/active-directory-token-and-claims/
[Aussteller]: https://openid.net/specs/openid-connect-core-1_0.html#IDToken
[issuer]: https://openid.net/specs/openid-connect-core-1_0.html#IDToken
[Authentifizierungsereignisse]: authenticate.md#authentication-events
[Authentication events]: authenticate.md#authentication-events
[signup]: signup.md
[Claims-Based Authorization]: /aspnet/core/security/authorization/claims
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
[authorization]: authorize.md

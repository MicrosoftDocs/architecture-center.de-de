---
title: Batchbewertung in Azure für Deep Learning-Modelle
description: Diese Referenzarchitektur zeigt, wie Sie mit Azure Batch AI neuronale Stilübertragung in einem Video ausführen.
author: jiata
ms.date: 10/02/2018
ms.author: jiata
ms.openlocfilehash: 1f3f3d3882b2b30eb29acd26c9eab9ff128028e2
ms.sourcegitcommit: 9eecff565392273d11b8702f1fcecb4d75e27a15
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 10/03/2018
ms.locfileid: "48243730"
---
# <a name="batch-scoring-on-azure-for-deep-learning-models"></a><span data-ttu-id="d2e33-103">Batchbewertung in Azure für Deep Learning-Modelle</span><span class="sxs-lookup"><span data-stu-id="d2e33-103">Batch scoring on Azure for deep learning models</span></span>

<span data-ttu-id="d2e33-104">Diese Referenzarchitektur zeigt, wie Sie mit Azure Batch AI neuronale Stilübertragung in einem Video ausführen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-104">This reference architecture shows how to apply neural style transfer to a video, using Azure Batch AI.</span></span> <span data-ttu-id="d2e33-105">*Stilübertragung* ist eine Deep Learning-Technik, bei der ein vorhandenes Bild im Stil eines anderen Bildes erstellt wird.</span><span class="sxs-lookup"><span data-stu-id="d2e33-105">*Style transfer* is a deep learning technique that composes an existing image in the style of another image.</span></span> <span data-ttu-id="d2e33-106">Diese Architektur kann generell für jedes Szenario für Batchbewertung mit Deep Learning verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-106">This architecture can be generalized for any scenario that uses batch scoring with deep learning.</span></span> <span data-ttu-id="d2e33-107">[**Stellen Sie diese Lösung bereit**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="d2e33-107">[**Deploy this solution**](#deploy-the-solution).</span></span>
 
![](./_images/batch-ai-deep-learning.png)

<span data-ttu-id="d2e33-108">**Szenario**: Ein Medienunternehmen möchte den Stil eines Videos so ändern, dass er dem eines bestimmten Gemäldes entspricht.</span><span class="sxs-lookup"><span data-stu-id="d2e33-108">**Scenario**: A media organization has a video whose style they want to change to look like a specific painting.</span></span> <span data-ttu-id="d2e33-109">Das Unternehmen möchte diesen Stil schnell und automatisiert auf alle Videoframes anwenden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-109">The organization wants to be able to apply this style to all frames of the video in a timely manner and in an automated fashion.</span></span> <span data-ttu-id="d2e33-110">Weitere Informationen zu Algorithmen für die neuronale Stilübertragung finden Sie unter [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] („Bildstilübertragung mit Convolutional Neural Networks“, PDF).</span><span class="sxs-lookup"><span data-stu-id="d2e33-110">For more background about neural style transfer algorithms, see [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span></span>

| <span data-ttu-id="d2e33-111">Stilbild:</span><span class="sxs-lookup"><span data-stu-id="d2e33-111">Style image:</span></span> | <span data-ttu-id="d2e33-112">Eingabe-/Inhaltsvideo:</span><span class="sxs-lookup"><span data-stu-id="d2e33-112">Input/content video:</span></span> | <span data-ttu-id="d2e33-113">Ausgabevideo:</span><span class="sxs-lookup"><span data-stu-id="d2e33-113">Output video:</span></span> | 
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | <span data-ttu-id="d2e33-114">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Eingabevideo") *Zum Wiedergeben klicken*</span><span class="sxs-lookup"><span data-stu-id="d2e33-114">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Input Video") *click to view video*</span></span> | <span data-ttu-id="d2e33-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Ausgabevideo") *Zur Wiedergeben klicken*</span><span class="sxs-lookup"><span data-stu-id="d2e33-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Output Video") *click to view video*</span></span> |

<span data-ttu-id="d2e33-116">Diese Referenzarchitektur ist für Workloads konzipiert, die durch das Vorhandensein neuer Medien im Azure-Speicher ausgelöst werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-116">This reference architecture is designed for workloads that are triggered by the presence of new media in Azure storage.</span></span> <span data-ttu-id="d2e33-117">Die Verarbeitung umfasst die folgenden Schritte:</span><span class="sxs-lookup"><span data-stu-id="d2e33-117">Processing involves the following steps:</span></span>

1. <span data-ttu-id="d2e33-118">Laden Sie ein Bild im gewünschten Stil (z.B. ein Gemälde von van Gogh) und ein Skript für die Stilübertragung in Blob Storage hoch.</span><span class="sxs-lookup"><span data-stu-id="d2e33-118">Upload a selected style image (like a Van Gogh painting) and a style transfer script to Blob Storage.</span></span>
1. <span data-ttu-id="d2e33-119">Erstellen Sie einen einsatzbereiten Batch AI-Cluster für die automatische Skalierung.</span><span class="sxs-lookup"><span data-stu-id="d2e33-119">Create an autoscaling Batch AI cluster that is ready to start taking work.</span></span>
1. <span data-ttu-id="d2e33-120">Teilen Sie die Videodatei in einzelne Frames, und laden Sie diese in Blob Storage hoch.</span><span class="sxs-lookup"><span data-stu-id="d2e33-120">Split the video file into individual frames and upload those frames into Blob Storage.</span></span>
1. <span data-ttu-id="d2e33-121">Wenn alle Frames hochgeladen wurden, laden Sie eine Triggerdatei in Blob Storage hoch.</span><span class="sxs-lookup"><span data-stu-id="d2e33-121">Once all frames are uploaded, upload a trigger file to Blob Storage.</span></span>
1. <span data-ttu-id="d2e33-122">Diese Datei löst eine Logik-App aus, die einen Container erstellt, der in Azure Container Instances ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="d2e33-122">This file triggers a Logic App that creates a container running in Azure Container Instances.</span></span>
1. <span data-ttu-id="d2e33-123">Der Container führt ein Skript aus, das Batch AI-Aufträge erstellt.</span><span class="sxs-lookup"><span data-stu-id="d2e33-123">The container runs a script that creates the Batch AI jobs.</span></span> <span data-ttu-id="d2e33-124">Jeder Auftrag wendet die neuronale Stilübertragung parallel auf die Knoten des Batch AI-Clusters an.</span><span class="sxs-lookup"><span data-stu-id="d2e33-124">Each job applies the neural style transfer in parallel across the nodes of the Batch AI cluster.</span></span>
1. <span data-ttu-id="d2e33-125">Wenn die Bilder generiert wurden, werden sie wieder in Blob Storage gespeichert.</span><span class="sxs-lookup"><span data-stu-id="d2e33-125">Once the images are generated, they are saved back to Blob Storage.</span></span>
1. <span data-ttu-id="d2e33-126">Laden Sie die generierten Frames herunter, und fügen Sie sie wieder zu einem Video zusammen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-126">Download the generated frames, and stitch back the images into a video.</span></span>

## <a name="architecture"></a><span data-ttu-id="d2e33-127">Architektur</span><span class="sxs-lookup"><span data-stu-id="d2e33-127">Architecture</span></span>
<span data-ttu-id="d2e33-128">Diese Architektur umfasst die folgenden Komponenten.</span><span class="sxs-lookup"><span data-stu-id="d2e33-128">This architecture consists of the following components.</span></span>

### <a name="compute"></a><span data-ttu-id="d2e33-129">Compute</span><span class="sxs-lookup"><span data-stu-id="d2e33-129">Compute</span></span>

<span data-ttu-id="d2e33-130">**[Azure Batch AI][batch-ai]** wird verwendet, um den Algorithmus der neuronalen Stilübertragung auszuführen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-130">**[Azure Batch AI][batch-ai]** is used to run the neural style transfer algorithm.</span></span> <span data-ttu-id="d2e33-131">Batch AI unterstützt Deep Learning-Workloads durch die Bereitstellung von Containerumgebungen, die für Deep Learning-Frameworks auf GPU-fähigen VMs vorkonfiguriert sind.</span><span class="sxs-lookup"><span data-stu-id="d2e33-131">Batch AI supports deep learning workloads by providing containerized environments that are pre-configured for deep learning frameworks, on GPU-enabled VMs.</span></span> <span data-ttu-id="d2e33-132">Der Dienst kann auch den Computecluster mit Blob Storage verbinden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-132">Batch AI can also connect the compute cluster to Blob storage.</span></span>

### <a name="storage"></a><span data-ttu-id="d2e33-133">Speicher</span><span class="sxs-lookup"><span data-stu-id="d2e33-133">Storage</span></span>

<span data-ttu-id="d2e33-134">**[Blob Storage][blob-storage]** wird verwendet, um alle Bilder (Eingabebilder, Stilbilder und Ausgabebilder) und alle von Batch AI erzeugten Protokolle zu speichern.</span><span class="sxs-lookup"><span data-stu-id="d2e33-134">**[Blob storage][blob-storage]** is used to store all images (input images, style images, and output images) as well as all logs produced from Batch AI.</span></span> <span data-ttu-id="d2e33-135">Die Blob Storage-Integration in Batch AI wird über [blobfuse][blobfuse] ermöglicht, ein virtuelles Open Source-Dateisystem, das in Blob Storage gesichert wird.</span><span class="sxs-lookup"><span data-stu-id="d2e33-135">Blob storage integrates with Batch AI via [blobfuse][blobfuse], an open-source virtual filesystem that is backed by Blob storage.</span></span> <span data-ttu-id="d2e33-136">Blob Storage ist außerdem sehr kostengünstig für die Leistung, die diese Workload erfordert.</span><span class="sxs-lookup"><span data-stu-id="d2e33-136">Blob storage is also very cost-effective for the performance that this workload requires.</span></span>

### <a name="trigger--scheduling"></a><span data-ttu-id="d2e33-137">Trigger/Planung</span><span class="sxs-lookup"><span data-stu-id="d2e33-137">Trigger / scheduling</span></span>

<span data-ttu-id="d2e33-138">**[Azure Logic Apps][logic-apps]** löst den Workflow aus.</span><span class="sxs-lookup"><span data-stu-id="d2e33-138">**[Azure Logic Apps][logic-apps]** is used to trigger the workflow.</span></span> <span data-ttu-id="d2e33-139">Wenn die Logik-App erkennt, dass dem Container ein Blob hinzugefügt wurde, löst sie den Batch AI-Prozess aus.</span><span class="sxs-lookup"><span data-stu-id="d2e33-139">When the Logic App detects that a blob has been added to the container, it triggers the Batch AI process.</span></span> <span data-ttu-id="d2e33-140">Logic Apps passt gut zu dieser Referenzarchitektur, da mit dem Dienst Änderungen an Blob Storage einfach erkannt und Trigger leicht geändert werden können.</span><span class="sxs-lookup"><span data-stu-id="d2e33-140">Logic Apps is a good fit for this reference architecture because it's an easy way to detect changes to blob storage and provides an easy process for changing the trigger.</span></span>

<span data-ttu-id="d2e33-141">**[Azure Container Instances][container-instances]** führt die Python-Skripts aus, die die Batch AI-Aufträge erstellen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-141">**[Azure Container Instances][container-instances]** is used to run the Python scripts that create the Batch AI jobs.</span></span> <span data-ttu-id="d2e33-142">Das Ausführen dieser Skripts in einem Docker-Container ist eine praktische Option, um sie bedarfsabhängig auszuführen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-142">Running these scripts inside a Docker container is a convenient way to run them on demand.</span></span> <span data-ttu-id="d2e33-143">Für diese Architektur wird Container Instances verwendet, weil es einen vorgefertigten Logic Apps-Connector gibt, mit dem die Logik-App den Batch AI-Auftrag auslösen kann.</span><span class="sxs-lookup"><span data-stu-id="d2e33-143">For this architecture, we use Container Instances because there is a pre-built Logic App connector for it, which allows the Logic App to trigger the Batch AI job.</span></span> <span data-ttu-id="d2e33-144">Container Instances kann zustandslose Prozesse schnell erstellen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-144">Container Instances can spin up stateless processes quickly.</span></span>

<span data-ttu-id="d2e33-145">**[Docker Hub][dockerhub]** wird verwendet, um das Docker-Bild zu speichern, mit dem Container Instances den Auftrag erstellt.</span><span class="sxs-lookup"><span data-stu-id="d2e33-145">**[DockerHub][dockerhub]** is used to store the Docker image that Container Instances uses to execute the job creation process.</span></span> <span data-ttu-id="d2e33-146">Docker Hub wurde für diese Architektur aufgrund der Benutzerfreundlichkeit ausgewählt, und weil es sich dabei um das Standardbildrepository für Docker-Benutzer handelt.</span><span class="sxs-lookup"><span data-stu-id="d2e33-146">DockerHub was chosen for this architecture because it's easy to use and is the default image repository for Docker users.</span></span> <span data-ttu-id="d2e33-147">[Azure Container Registry][container-registry] kann ebenfalls verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-147">[Azure Container Registry][container-registry] can also be used.</span></span>

### <a name="data-preparation"></a><span data-ttu-id="d2e33-148">Vorbereitung der Daten</span><span class="sxs-lookup"><span data-stu-id="d2e33-148">Data preparation</span></span>

<span data-ttu-id="d2e33-149">Diese Referenzarchitektur verwendet Videomaterial von einem Orang-Utan auf einem Baum.</span><span class="sxs-lookup"><span data-stu-id="d2e33-149">This reference architecture uses video footage of an orangutan in a tree.</span></span> <span data-ttu-id="d2e33-150">Sie können das Videomaterial [hier][source-video] herunterladen und es folgendermaßen für den Workflow verarbeiten:</span><span class="sxs-lookup"><span data-stu-id="d2e33-150">You can download the footage from [here][source-video] and process it for the workflow by following these steps:</span></span>

1. <span data-ttu-id="d2e33-151">Laden Sie mit [AzCopy][azcopy] das Video aus dem öffentlichen Blob herunter.</span><span class="sxs-lookup"><span data-stu-id="d2e33-151">Use [AzCopy][azcopy] to download the video from the public blob.</span></span>
2. <span data-ttu-id="d2e33-152">Verwenden Sie [FFmpeg][ffmpeg], um die Audiodatei zu extrahieren, damit sie später wieder im Ausgabevideo zusammengefügt werden kann.</span><span class="sxs-lookup"><span data-stu-id="d2e33-152">Use [FFmpeg][ffmpeg] to extract the audio file, so that the audio file can be stitched back into the output video later.</span></span>
3. <span data-ttu-id="d2e33-153">Teilen Sie das Video mithilfe von FFmpeg in einzelne Frames auf.</span><span class="sxs-lookup"><span data-stu-id="d2e33-153">Use FFmpeg to break the video into individual frames.</span></span> <span data-ttu-id="d2e33-154">Die Frames werden unabhängig voneinander parallel verarbeitet.</span><span class="sxs-lookup"><span data-stu-id="d2e33-154">The frames will be processed independently, in parallel.</span></span>
4. <span data-ttu-id="d2e33-155">Kopieren Sie mit AzCopy die einzelnen Frames in Ihren Blobcontainer.</span><span class="sxs-lookup"><span data-stu-id="d2e33-155">Use AzCopy to copy the individual frames into your blob container.</span></span>

<span data-ttu-id="d2e33-156">Zu diesem Zeitpunkt liegt das Videomaterial in einer Form vor, die für die neuronale Stilübertragung verwendet werden kann.</span><span class="sxs-lookup"><span data-stu-id="d2e33-156">At this stage, the video footage is in a form that can be used for neural style transfer.</span></span> 

## <a name="performance-considerations"></a><span data-ttu-id="d2e33-157">Überlegungen zur Leistung</span><span class="sxs-lookup"><span data-stu-id="d2e33-157">Performance considerations</span></span>

### <a name="gpu-vs-cpu"></a><span data-ttu-id="d2e33-158">Vergleich zwischen GPU und CPU</span><span class="sxs-lookup"><span data-stu-id="d2e33-158">GPU vs CPU</span></span>

<span data-ttu-id="d2e33-159">Bei Deep Learning-Workloads bieten GPUs eine deutlich bessere Leistung als CPUs, sodass in der Regel ein großer Cluster von CPUs benötigt wird, um eine vergleichbare Leistung zu erzielen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-159">For deep learning workloads, GPUs will generally out-perform CPUs by a considerable amount, to the extent that a sizeable cluster of CPUs is usually needed to get comparable performance.</span></span> <span data-ttu-id="d2e33-160">Obwohl die Option besteht, in dieser Architektur nur CPUs zu verwenden, bieten GPUs ein viel besseres Preis-Leistungs-Verhältnis.</span><span class="sxs-lookup"><span data-stu-id="d2e33-160">While it's an option to use only CPUs in this architecture, GPUs will provide a much better cost/performance profile.</span></span> <span data-ttu-id="d2e33-161">Es wird empfohlen, die neueste GPU-optimierte VM-Größe (NCv3-Serie) zu verwenden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-161">We recommend using the latest [NCv3 series]vm-sizes-gpu of GPU optimized VMs.</span></span>

<span data-ttu-id="d2e33-162">GPUs sind nicht in allen Regionen standardmäßig aktiviert.</span><span class="sxs-lookup"><span data-stu-id="d2e33-162">GPUs are not enabled by default in all regions.</span></span> <span data-ttu-id="d2e33-163">Wählen Sie deshalb eine Region aus, in der GPUs aktiviert sind.</span><span class="sxs-lookup"><span data-stu-id="d2e33-163">Make sure to select a region with GPUs enabled.</span></span> <span data-ttu-id="d2e33-164">Darüber hinaus haben Abonnements ein Standardkontingent von null Kernen für GPU-optimierte VMs.</span><span class="sxs-lookup"><span data-stu-id="d2e33-164">In addition, subscriptions have a default quota of zero cores for GPU-optimized VMs.</span></span> <span data-ttu-id="d2e33-165">Sie können dieses Kontingent erhöhen, indem Sie eine Supportanfrage stellen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-165">You can raise this quota by opening a support request.</span></span> <span data-ttu-id="d2e33-166">Stellen Sie sicher, dass Ihr Abonnement über ausreichend Kontingent verfügt, um Ihre Workload auszuführen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-166">Make sure that your subscription has enough quota to run your workload.</span></span>

### <a name="parallelizing-across-vms-vs-cores"></a><span data-ttu-id="d2e33-167">Vergleich zwischen Parallelisieren auf VMs und Kernen</span><span class="sxs-lookup"><span data-stu-id="d2e33-167">Parallelizing across VMs vs cores</span></span>

<span data-ttu-id="d2e33-168">Wenn eine Stilübertragung als Batchauftrag ausgeführt wird, müssen die Aufträge, die hauptsächlich auf GPUs ausgeführt werden, über VMs hinweg parallelisiert werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-168">When running a style transfer process as a batch job, the jobs that run primarily on GPUs will have to be parallelized across VMs.</span></span> <span data-ttu-id="d2e33-169">Zwei Ansätze sind möglich: Sie können einen größeren Cluster mit VMs erstellen, die eine einzelne GPU haben, oder einen kleineren Cluster mit VMs mit vielen GPUs.</span><span class="sxs-lookup"><span data-stu-id="d2e33-169">Two approaches are possible: You can create a larger cluster using VMs that have a single GPU, or create a smaller cluster using VMs with many GPUs.</span></span> 

<span data-ttu-id="d2e33-170">Die beiden Optionen bieten für diese Workload eine vergleichbare Leistung.</span><span class="sxs-lookup"><span data-stu-id="d2e33-170">For this workload, these two options will have comparable performance.</span></span> <span data-ttu-id="d2e33-171">Die Verwendung von weniger VMs mit mehr GPUs pro VM kann dazu beitragen, die Datenverschiebung zu reduzieren.</span><span class="sxs-lookup"><span data-stu-id="d2e33-171">Using fewer VMs with more GPUs per VM can help to reduce data movement.</span></span> <span data-ttu-id="d2e33-172">Das Datenvolumen pro Auftrag für diese Workload ist jedoch nicht sehr groß, sodass Blob Storage keine umfangreiche Drosselung vornehmen wird.</span><span class="sxs-lookup"><span data-stu-id="d2e33-172">However, the data volume per job for this workload is not very big, so you won't observe much throttling by blob storage.</span></span>

### <a name="images-batch-size-per-batch-ai-job"></a><span data-ttu-id="d2e33-173">Batchgröße für Bilder pro Batch AI-Auftrag</span><span class="sxs-lookup"><span data-stu-id="d2e33-173">Images batch size per Batch AI job</span></span>

<span data-ttu-id="d2e33-174">Ein weiterer Parameter, der konfiguriert werden muss, ist die Anzahl von zu verarbeitenden Bildern pro Batch AI-Auftrag.</span><span class="sxs-lookup"><span data-stu-id="d2e33-174">Another parameter that must be configured is the number of images to process per Batch AI job.</span></span> <span data-ttu-id="d2e33-175">Einerseits möchten Sie Aufträge auf mehrere Knoten verteilen, damit beim Fehlschlagen eines Auftrags, Vorgänge nicht für zu viele Bilder wiederholt werden müssen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-175">On the one hand, you want to ensure that work is spread broadly across the nodes and that if a job fails, you don't have to retry too many images.</span></span> <span data-ttu-id="d2e33-176">Das deutet auf viele Batch AI-Aufträge und somit eine geringe Anzahl von Bildern hin, die pro Auftrag verarbeitet werden müssen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-176">That points to having many Batch AI jobs and thus a low number of images to process per job.</span></span> <span data-ttu-id="d2e33-177">Werden hingegen zu wenige Bilder pro Auftrag verarbeitet, sind die Setup- und Startupzeit überproportional lang.</span><span class="sxs-lookup"><span data-stu-id="d2e33-177">On the other hand, if too few images are processed per job, the setup/startup time becomes disproportionately large.</span></span> <span data-ttu-id="d2e33-178">Sie können die Anzahl von Aufträgen so festlegen, dass sie der maximalen Anzahl von Knoten im Cluster entspricht.</span><span class="sxs-lookup"><span data-stu-id="d2e33-178">You can set the number of jobs to equal the maximum number of nodes in the cluster.</span></span> <span data-ttu-id="d2e33-179">Die ideale Annahme ist, dass keine Aufträge fehlschlagen, da dadurch die Setup- und Startupkosten minimiert werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-179">This will be the most performant assuming that no jobs fail, because it minimizes the amount of setup/startup cost.</span></span> <span data-ttu-id="d2e33-180">Wenn ein Auftrag jedoch fehlschlägt, muss ggf. eine große Anzahl von Bildern erneut verarbeitet werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-180">However, if a job fails, a large number of images might need to be reprocessed.</span></span>

### <a name="file-servers"></a><span data-ttu-id="d2e33-181">Dateiserver</span><span class="sxs-lookup"><span data-stu-id="d2e33-181">File servers</span></span>

<span data-ttu-id="d2e33-182">Wenn Sie Batch AI verwenden, können Sie je nach Durchsatz, der für Ihr Szenario erforderlich ist, mehrere Speicheroptionen auswählen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-182">When using Batch AI, you can choose multiple storage options depending on the throughput needed for your scenario.</span></span> <span data-ttu-id="d2e33-183">Für Workloads mit geringem Durchsatz sollte die Verwendung von Blob Storage (über blobfuse) ausreichen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-183">For workloads with low throughput requirements, using blob storage (via blobfuse) should be enough.</span></span> <span data-ttu-id="d2e33-184">Alternativ unterstützt Batch AI auch einen Batch AI-Dateiserver, ein verwaltetes NFS mit einem Knoten, das automatisch auf Clusterknoten bereitgestellt werden kann, um Aufträgen einen zentral zugänglichen Speicherort zur Verfügung zu stellen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-184">Alternatively, Batch AI also supports a Batch AI File Server, a managed single-node NFS, which can be automatically mounted on cluster nodes to provide a centrally accessible storage location for jobs.</span></span> <span data-ttu-id="d2e33-185">In der Regel wird in einem Arbeitsbereich nur ein Dateiserver benötigt. Sie können dann Daten für Ihre Trainingsaufträge in verschiedenen Verzeichnissen speichern.</span><span class="sxs-lookup"><span data-stu-id="d2e33-185">For most cases, only one file server is needed in a workspace, and you can separate data for your training jobs into different directories.</span></span> <span data-ttu-id="d2e33-186">Wenn das NFS mit einem Knoten nicht für Ihre Workloads geeignet ist, unterstützt Batch AI andere Speicheroptionen, z.B. Azure Files oder benutzerdefinierte Lösungen wie ein Gluster- oder Lustre-Dateisystem.</span><span class="sxs-lookup"><span data-stu-id="d2e33-186">If a single-node NFS isn't appropriate for your workloads, Batch AI supports other storage options, including Azure Files or custom solutions such as a Gluster or Lustre file system.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="d2e33-187">Sicherheitshinweise</span><span class="sxs-lookup"><span data-stu-id="d2e33-187">Security considerations</span></span>

### <a name="restricting-access-to-azure-blob-storage"></a><span data-ttu-id="d2e33-188">Einschränken des Zugriffs auf Azure Blob Storage</span><span class="sxs-lookup"><span data-stu-id="d2e33-188">Restricting access to Azure blob storage</span></span>

<span data-ttu-id="d2e33-189">In dieser Referenzarchitektur ist Azure Blob Storage die wichtigste Speicherkomponente, die geschützt werden muss.</span><span class="sxs-lookup"><span data-stu-id="d2e33-189">In this reference architecture, Azure blob storage is the main storage component that needs to be protected.</span></span> <span data-ttu-id="d2e33-190">Die im GitHub-Repository angezeigte Baselinebereitstellung verwendet Speicherkontoschlüssel für den Zugriff auf Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="d2e33-190">The baseline deployment shown in the GitHub repo uses storage account keys to access the blob storage.</span></span> <span data-ttu-id="d2e33-191">Für noch mehr Kontrolle und Schutz sollten Sie stattdessen Shared Access Signatur (SAS) verwenden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-191">For further control and protection, consider using a shared access signature (SAS) instead.</span></span> <span data-ttu-id="d2e33-192">Dadurch wird eingeschränkter Zugriff auf die gespeicherten Objekte gewährt, ohne dass die Kontoschlüssel hartcodiert oder im Klartext gespeichert werden müssen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-192">This grants limited access to objects in storage, without needing to hard code the account keys or save them in plaintext.</span></span> <span data-ttu-id="d2e33-193">Dieser Ansatz ist besonders nützlich, weil Kontoschlüssel im Klartext der Logik-App-Designerschnittstelle sichtbar sind.</span><span class="sxs-lookup"><span data-stu-id="d2e33-193">This approach is especially useful because account keys are visible in plaintext inside of Logic App's designer interface.</span></span> <span data-ttu-id="d2e33-194">Mit SAS können Sie außerdem sicherstellen, dass das Speicherkonto über eine ordnungsgemäße Governance verfügt und der Zugriff nur ausgewählten Personen gewährt wird.</span><span class="sxs-lookup"><span data-stu-id="d2e33-194">Using an SAS also helps to ensure that the storage account has proper governance, and that access is granted only to the people intended to have it.</span></span>

<span data-ttu-id="d2e33-195">Stellen Sie in Szenarien mit sensibleren Daten sicher, dass alle Ihre Speicherschlüssel geschützt sind, weil diese Schlüssel den Vollzugriff auf alle Ein- und Ausgabedaten der Workload ermöglichen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-195">For scenarios with more sensitive data, make sure that all of your storage keys are protected, because these keys grant full access to all input and output data from the workload.</span></span>

### <a name="data-encryption-and-data-movement"></a><span data-ttu-id="d2e33-196">Datenverschlüsselung und Datenverschiebung</span><span class="sxs-lookup"><span data-stu-id="d2e33-196">Data encryption and data movement</span></span>

<span data-ttu-id="d2e33-197">Diese Referenzarchitektur verwendet Stilübertragung als Beispiel für einen Batchbewertungsvorgang.</span><span class="sxs-lookup"><span data-stu-id="d2e33-197">This reference architecture uses style transfer as an example of a batch scoring process.</span></span> <span data-ttu-id="d2e33-198">Für Szenarien mit noch sensibleren Daten sollten die gespeicherten Daten im Ruhezustand verschlüsselt werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-198">For more data-sensitive scenarios, the data in storage should be encrypted at rest.</span></span> <span data-ttu-id="d2e33-199">Sichern Sie die Datenübertragung jedes Mal mit SSL, wenn Daten von einem Ort an einen anderen verschoben werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-199">Each time data is moved from one location to the next, use SSL to secure the data transfer.</span></span> <span data-ttu-id="d2e33-200">Weitere Informationen finden Sie im [Azure Storage-Sicherheitsleitfaden][storage-security].</span><span class="sxs-lookup"><span data-stu-id="d2e33-200">For more information, see [Azure Storage security guide][storage-security].</span></span> 

### <a name="securing-data-in-a-virtual-network"></a><span data-ttu-id="d2e33-201">Sichern von Daten in einem virtuellen Netzwerk</span><span class="sxs-lookup"><span data-stu-id="d2e33-201">Securing data in a virtual network</span></span>

<span data-ttu-id="d2e33-202">Beim Bereitstellen Ihres Batch AI-Clusters können Sie ihn so konfigurieren, dass er im Subnetz eines virtuellen Netzwerks bereitgestellt wird.</span><span class="sxs-lookup"><span data-stu-id="d2e33-202">When deploying your Batch AI cluster, you can configure your cluster to be provisioned inside a subnet of a virtual network.</span></span> <span data-ttu-id="d2e33-203">Dadurch können die Computeknoten im Cluster sicher mit anderen VMs oder sogar mit einem lokalen Netzwerk kommunizieren.</span><span class="sxs-lookup"><span data-stu-id="d2e33-203">This allows the compute nodes in the cluster to communicate securely with other virtual machines, or even with an on-premises network.</span></span> <span data-ttu-id="d2e33-204">Sie können auch [Dienstendpunkte][service-endpoints] mit Blob Storage verwenden, um Zugriff aus einem virtuellen Netzwerk zu gewähren, oder ein NFS mit einem Knoten im VNET mit Batch AI zu verwenden, um den permanenten Schutz von Daten sicherzustellen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-204">You can also use [service endpoints][service-endpoints] with blob storage to grant access from a virtual network or use a single-node NFS inside the VNET with Batch AI to ensure that the data is always protected.</span></span>

### <a name="protecting-against-malicious-activity"></a><span data-ttu-id="d2e33-205">Schützen vor schädlichen Aktivitäten</span><span class="sxs-lookup"><span data-stu-id="d2e33-205">Protecting against malicious activity</span></span>

<span data-ttu-id="d2e33-206">Stellen Sie in Szenarien mit mehreren Benutzern sicher, dass sensible Daten vor schädlichen Aktivitäten geschützt sind.</span><span class="sxs-lookup"><span data-stu-id="d2e33-206">In scenarios where there are multiple users, make sure that sensitive data is protected against malicious activity.</span></span> <span data-ttu-id="d2e33-207">Wenn Sie anderen Benutzern Zugriff auf diese Bereitstellung gewähren, um die Eingabedaten anzupassen, beachten Sie die folgenden Vorsichtsmaßnahmen und Überlegungen:</span><span class="sxs-lookup"><span data-stu-id="d2e33-207">If other users are given access to this deployment to customize the input data, take note of the following precautions and considerations:</span></span>

- <span data-ttu-id="d2e33-208">Verwenden Sie die rollenbasierte Zugriffssteuerung (RBAC), um den Zugriff von Benutzern auf die Ressourcen zu beschränken, die sie benötigen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-208">Use RBAC to limit users' access to only the resources they need.</span></span>
- <span data-ttu-id="d2e33-209">Stellen Sie zwei separate Speicherkonten bereit.</span><span class="sxs-lookup"><span data-stu-id="d2e33-209">Provision two separate storage accounts.</span></span> <span data-ttu-id="d2e33-210">Speichern Sie Eingabe-und Ausgabedaten im ersten Konto.</span><span class="sxs-lookup"><span data-stu-id="d2e33-210">Store input and output data in the first account.</span></span> <span data-ttu-id="d2e33-211">Externen Benutzern kann Zugriff auf dieses Konto gewährt werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-211">External users can be given access to this account.</span></span> <span data-ttu-id="d2e33-212">Speichern Sie ausführbare Skripts und ausgegebene Protokolldateien im anderen Konto.</span><span class="sxs-lookup"><span data-stu-id="d2e33-212">Store executable scripts and output log files in the other account.</span></span> <span data-ttu-id="d2e33-213">Externe Benutzer sollten keinen Zugriff auf dieses Konto haben.</span><span class="sxs-lookup"><span data-stu-id="d2e33-213">External users should not have access to this account.</span></span> <span data-ttu-id="d2e33-214">So wird sichergestellt, dass externe Benutzer keine ausführbaren Dateien ändern (um schädlichen Code einzufügen) und keinen Zugriff auf Protokolldateien haben, die ggf. vertrauliche Informationen enthalten.</span><span class="sxs-lookup"><span data-stu-id="d2e33-214">This will ensure that external users cannot modify any executable files (to inject malicious code), and don't have access to logfiles, which could hold sensitive information.</span></span>
- <span data-ttu-id="d2e33-215">Böswillige Benutzer können einen DDoS auf die Auftragswarteschlange starten oder ungültige, nicht verarbeitbare Nachrichten in die Auftragswarteschlange einfügen, wodurch Systemsperren und Fehler beim Entfernen aus der Warteschlange entstehen können.</span><span class="sxs-lookup"><span data-stu-id="d2e33-215">Malicious users can DDOS the job queue or inject malformed poison messages in the job queue, causing the system to lock up or causing dequeuing errors.</span></span> 

## <a name="monitoring-and-logging"></a><span data-ttu-id="d2e33-216">Überwachung und Protokollierung</span><span class="sxs-lookup"><span data-stu-id="d2e33-216">Monitoring and logging</span></span>

### <a name="monitoring-batch-ai-jobs"></a><span data-ttu-id="d2e33-217">Überwachen von Batch AI-Aufträgen</span><span class="sxs-lookup"><span data-stu-id="d2e33-217">Monitoring Batch AI jobs</span></span>

<span data-ttu-id="d2e33-218">Beim Ausführen Ihres Auftrags ist es wichtig, den Fortschritt zu überwachen und zu überprüfen, ob alles wie erwartet funktioniert.</span><span class="sxs-lookup"><span data-stu-id="d2e33-218">While running your job, it's important to monitor the progress and make sure that things are working as expected.</span></span> <span data-ttu-id="d2e33-219">Es kann jedoch eine Herausforderung sein, über einen Cluster von aktiven Knoten hinweg zu überwachen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-219">However, it can be a challenge to monitor across a cluster of active nodes.</span></span> 

<span data-ttu-id="d2e33-220">Um einen Eindruck vom Gesamtzustand des Clusters zu bekommen, navigieren Sie im Azure-Portal zum Blatt „Batch AI“, um den Zustand der Knoten im Cluster zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-220">To get a sense of the overall state of the cluster, go to the Batch AI blade of the Azure Portal to inspect the state of the nodes in the cluster.</span></span> <span data-ttu-id="d2e33-221">Wenn ein Knoten inaktiv oder ein Auftrag fehlgeschlagen ist, werden die Fehlerprotokolle in Blob Storage gespeichert und sind auch im Azure-Portal auf dem Blatt „Aufträge“ verfügbar.</span><span class="sxs-lookup"><span data-stu-id="d2e33-221">If a node is inactive or a job has failed, the error logs are saved to blob storage, and are also accessible in the Jobs blade in the Azure Portal.</span></span> 

<span data-ttu-id="d2e33-222">Die Überwachung kann durch Verbinden von Protokollen mit Application Insights oder durch das Ausführen separater Prozesse zum Abrufen des Zustands des Batch AI-Clusters und seiner Aufträge verbessert werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-222">Monitoring can be further enriched by connecting logs to Application Insights or by running separate processes to poll for the state of the Batch AI cluster and its jobs.</span></span>

### <a name="logging-in-batch-ai"></a><span data-ttu-id="d2e33-223">Protokollierung in Batch AI</span><span class="sxs-lookup"><span data-stu-id="d2e33-223">Logging in Batch AI</span></span>

<span data-ttu-id="d2e33-224">Batch AI protokolliert automatisch alle StdOut/STDERR-Ereignisse im entsprechenden Blob Storage-Konto.</span><span class="sxs-lookup"><span data-stu-id="d2e33-224">Batch AI will automatically log all stdout/stderr to the associate blob storage account.</span></span> <span data-ttu-id="d2e33-225">Speichernavigationstools wie der Speicher-Explorer vereinfachen die Navigation durch Protokolldateien erheblich.</span><span class="sxs-lookup"><span data-stu-id="d2e33-225">Using a storage navigation tool such as Storage Explorer will provide a much easier experience for navigating log files.</span></span> 

<span data-ttu-id="d2e33-226">Die Schritte zum Bereitstellen für diese Referenzarchitektur zeigen auch, wie Sie ein einfacheres Protokollierungssystem einrichten, damit alle Protokolle für die verschiedenen Aufträge im gleichen Verzeichnis in Ihrem Blobcontainer gespeichert werden (siehe unten).</span><span class="sxs-lookup"><span data-stu-id="d2e33-226">The deployment steps for this reference architecture also shows how to set up a more simple logging system, such that all the logs across the different jobs are saved to the same directory in your blob container, as shown below.</span></span>
<span data-ttu-id="d2e33-227">Verwenden Sie diese Protokolle, um zu überwachen, wie lange die Verarbeitung jedes Auftrags und jedes Bildes dauert.</span><span class="sxs-lookup"><span data-stu-id="d2e33-227">Use these logs to monitor how long it takes for each job and each image to process.</span></span> <span data-ttu-id="d2e33-228">So können Sie besser beurteilen, wie Sie den Prozess weiter optimieren können.</span><span class="sxs-lookup"><span data-stu-id="d2e33-228">This will give you a better sense of how to optimize the process even further.</span></span>

![](./_images/batch-ai-logging.png)

## <a name="cost-considerations"></a><span data-ttu-id="d2e33-229">Kostenbetrachtung</span><span class="sxs-lookup"><span data-stu-id="d2e33-229">Cost considerations</span></span>

<span data-ttu-id="d2e33-230">Im Vergleich zu den Speicher- und Planungskomponenten fallen für die in dieser Referenzarchitektur verwendeten Computeressourcen bei Weitem die meisten Kosten an.</span><span class="sxs-lookup"><span data-stu-id="d2e33-230">Compared to the storage and scheduling components, the compute resources used in this reference architecture by far dominate in terms of costs.</span></span> <span data-ttu-id="d2e33-231">Eine der größten Herausforderungen besteht darin, Aufträge über ein Cluster von GPU-fähigen VMs hinweg effektiv zu parallelisieren.</span><span class="sxs-lookup"><span data-stu-id="d2e33-231">One of the main challenges is effectively parallelizing the work across a cluster of GPU-enabled machines.</span></span>

<span data-ttu-id="d2e33-232">Die Größe des Batch AI-Clusters kann je nach Auftrag in der Warteschlange automatisch zentral hoch- und herunterskaliert werden.</span><span class="sxs-lookup"><span data-stu-id="d2e33-232">The Batch AI cluster size can automatically scale up and down depending on the jobs in the queue.</span></span> <span data-ttu-id="d2e33-233">Es gibt zwei Möglichkeiten für die automatische Skalierung mit Batch AI.</span><span class="sxs-lookup"><span data-stu-id="d2e33-233">You can enable auto-scale with Batch AI in one of two ways.</span></span> <span data-ttu-id="d2e33-234">Bei der programmgesteuerten Variante wird sie in der Datei `.env` konfiguriert, die Teil der [Bereitstellungsschritte][deployment] ist. Alternativ können Sie die Skalierungsformel direkt im Portal ändern, nachdem der Cluster erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="d2e33-234">You can do so programmatically, which can be configured in the `.env` file that is part of the [deployment steps][deployment], or you can change the scale formula directly in the portal after the cluster is created.</span></span>

<span data-ttu-id="d2e33-235">Konfigurieren Sie für Aufträge, die nicht direkt verarbeitet werden müssen, die Formel für die automatische Skalierung so, dass der Standardzustand (Minimum) ein Cluster von null Knoten ist.</span><span class="sxs-lookup"><span data-stu-id="d2e33-235">For work that doesn't require immediate processing, configure the auto-scale formula so the default state (minimum) is a cluster of zero nodes.</span></span> <span data-ttu-id="d2e33-236">Bei dieser Konfiguration hat der Cluster anfangs null Knoten. Er skaliert nur dann zentral hoch, wenn er Aufträge in der Warteschlange erkennt.</span><span class="sxs-lookup"><span data-stu-id="d2e33-236">With this configuration, the cluster starts with zero nodes and only scales up when it detects jobs in the queue.</span></span> <span data-ttu-id="d2e33-237">Wenn die Batchbewertung maximal einige Male am Tag ausgeführt wird, können Sie mithilfe dieser Einstellung erheblich Kosten sparen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-237">If the batch scoring process only happens a few times a day or less, this setting enables significant cost savings.</span></span>

<span data-ttu-id="d2e33-238">Die automatische Skalierung ist ggf. nicht für Batchaufträge geeignet, die zeitlich zu nahe beieinander liegen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-238">Auto-scaling may not be appropriate for batch jobs that happen too close to each other.</span></span> <span data-ttu-id="d2e33-239">Für die benötigte Zeit zum Erstellen und Entfernen eines Cluster fallen ebenfalls Kosten an. Das heißt, wenn eine Batchworkload nur wenige Minuten nach dem Ende des vorherigen Auftrags startet, ist es ggf. kostengünstiger den Cluster permanent, also auch zwischen den Aufträgen, auszuführen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-239">The time that it takes for a cluster to spin up and spin down also incur a cost, so if a batch workload begins only a few minutes after the previous job ends, it might be more cost effective to keep the cluster running between jobs.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="d2e33-240">Bereitstellen der Lösung</span><span class="sxs-lookup"><span data-stu-id="d2e33-240">Deploy the solution</span></span>

<span data-ttu-id="d2e33-241">Befolgen Sie die Schritte im Abschnitt [GitHub-Repository][deployment], um diese Referenzarchitektur bereitzustellen.</span><span class="sxs-lookup"><span data-stu-id="d2e33-241">To deploy this reference architecture, follow the steps described in the [GitHub repo][deployment].</span></span>

[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[batch-ai]: /azure/batch-ai/
[blobfuse]: https://github.com/Azure/azure-storage-fuse
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/batch-scoring-for-dl-models
[dockerhub]: https://hub.docker.com/
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[service-endpoints]: /azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu
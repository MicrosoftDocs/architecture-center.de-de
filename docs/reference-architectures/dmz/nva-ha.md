---
title: Bereitstellen hochverfügbarer virtueller Netzwerkgeräte
titleSuffix: Azure Reference Architectures
description: Stellen Sie virtuelle Netzwerkgeräte mit hoher Verfügbarkeit bereit.
author: telmosampaio
ms.date: 12/08/2018
ms.custom: seodec18
ms.openlocfilehash: d3f9017db1bbf9741b10db16eb5a3dbab78f1160
ms.sourcegitcommit: 7d21aec9d9de0004ac777c1d1e364f53aac2350d
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 12/09/2018
ms.locfileid: "53120751"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="c0cbd-103">Bereitstellen hochverfügbarer virtueller Netzwerkgeräte</span><span class="sxs-lookup"><span data-stu-id="c0cbd-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="c0cbd-104">In diesem Artikel erfahren Sie, wie eine Reihe virtueller Netzwerkgeräte (NVAs) für hohe Verfügbarkeit in Azure bereitgestellt wird.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="c0cbd-105">Ein NVA wird normalerweise verwendet, um den Netzwerkdatenverkehrsfluss von einem Umkreisnetzwerk (auch als DMZ bekannt) zu anderen Netzwerken oder Subnetzen zu steuern.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="c0cbd-106">Informationen zum Implementieren einer DMZ in Azure finden Sie unter [Microsoft-Clouddienste und Netzwerksicherheit][cloud-security].</span><span class="sxs-lookup"><span data-stu-id="c0cbd-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="c0cbd-107">Der Artikel enthält Beispielarchitekturen für nur eingehenden, nur ausgehenden sowie ein- und ausgehenden Datenverkehr.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="c0cbd-108">**Voraussetzungen:** In diesem Artikel werden grundlegende Kenntnisse über Azure-Netzwerke, [Azure-Lastenausgleichsmodule][lb-overview] und [benutzerdefinierte Routen][udr-overview] (User-Defined Routes, UDRs) vorausgesetzt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="c0cbd-109">Architekturdiagramme</span><span class="sxs-lookup"><span data-stu-id="c0cbd-109">Architecture diagrams</span></span>

<span data-ttu-id="c0cbd-110">Ein NVA kann in einer DMZ in vielen verschiedenen Architekturen bereitgestellt werden.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="c0cbd-111">Die folgende Abbildung veranschaulicht beispielsweise die Verwendung eines [einzelnen NVA][nva-scenario] für eingehenden Datenverkehr.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="c0cbd-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="c0cbd-112">![[0]][0]</span></span>

<span data-ttu-id="c0cbd-113">In dieser Architektur stellt das NVA eine sichere Netzwerkgrenze dar, indem der gesamte eingehende und ausgehende Netzwerkdatenverkehr überprüft und nur der Datenverkehr weitergeleitet wird, der die Netzwerksicherheitsregeln erfüllt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="c0cbd-114">Aufgrund der Tatsache, dass der gesamte Netzwerkdatenverkehr über das NVA erfolgen muss, stellt das NVA eine einzelne Fehlerquelle (Single Point of Failure) im Netzwerk dar.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="c0cbd-115">Tritt beim NVA ein Fehler auf, steht kein anderer Pfad für den Netzwerkdatenverkehr bereit und keines der Back-End-Subnetze ist verfügbar.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="c0cbd-116">Um Hochverfügbarkeit für ein NVA zu gewährleisten, stellen Sie mehrere NCAs in einer Verfügbarkeitsgruppe bereit.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="c0cbd-117">In den folgenden Architekturen sind die für hochverfügbare NVAs erforderlichen Ressourcen und die Konfiguration angegeben:</span><span class="sxs-lookup"><span data-stu-id="c0cbd-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

| <span data-ttu-id="c0cbd-118">Lösung</span><span class="sxs-lookup"><span data-stu-id="c0cbd-118">Solution</span></span> | <span data-ttu-id="c0cbd-119">Vorteile</span><span class="sxs-lookup"><span data-stu-id="c0cbd-119">Benefits</span></span> | <span data-ttu-id="c0cbd-120">Überlegungen</span><span class="sxs-lookup"><span data-stu-id="c0cbd-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="c0cbd-121">[Eingehender Datenverkehr mit Layer-7-NVAs][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="c0cbd-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="c0cbd-122">Alle NVA-Knoten sind aktiv.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-122">All NVA nodes are active</span></span> |<span data-ttu-id="c0cbd-123">Erfordert ein NVA, das Verbindungen beenden und SNAT verwenden kann.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="c0cbd-124">Erfordert eine separate Gruppe von NVAs für den Datenverkehr aus dem Internet und von Azure.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="c0cbd-125">Kann nur für Datenverkehr verwendet werden, dessen Ursprung außerhalb von Azure liegt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="c0cbd-126">[Ausgehender Datenverkehr mit Layer-7-NVAs][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="c0cbd-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="c0cbd-127">Alle NVA-Knoten sind aktiv.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-127">All NVA nodes are active</span></span> | <span data-ttu-id="c0cbd-128">Erfordert ein NVA, das Verbindungen beenden kann und die Übersetzung der Quellnetzwerkadresse (SNAT) implementiert.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="c0cbd-129">[Eingehender/ausgehender Datenverkehr mit Layer-7-NVAs][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="c0cbd-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="c0cbd-130">Alle Knoten sind aktiv.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-130">All nodes are active</span></span><br/><span data-ttu-id="c0cbd-131">Kann den aus Azure stammenden Datenverkehr abwickeln.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="c0cbd-132">Erfordert ein NVA, das Verbindungen beenden und SNAT verwenden kann.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="c0cbd-133">Erfordert eine separate Gruppe von NVAs für den Datenverkehr aus dem Internet und von Azure.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="c0cbd-134">[PIP/UDR-Switch][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="c0cbd-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="c0cbd-135">Einzelne Gruppe von NVAs für den gesamten Datenverkehr.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="c0cbd-136">Kann den gesamten Datenverkehr abwickeln (keine Beschränkung für Portregeln).</span><span class="sxs-lookup"><span data-stu-id="c0cbd-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="c0cbd-137">Aktiv/Passiv</span><span class="sxs-lookup"><span data-stu-id="c0cbd-137">Active-passive</span></span><br/><span data-ttu-id="c0cbd-138">Erfordert einen Failoverprozess.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-138">Requires a failover process</span></span> |
| [<span data-ttu-id="c0cbd-139">PIP/UDR ohne SNAT</span><span class="sxs-lookup"><span data-stu-id="c0cbd-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="c0cbd-140">Einzelne Gruppe von NVAs für den gesamten Datenverkehr.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="c0cbd-141">Kann den gesamten Datenverkehr abwickeln (keine Beschränkung für Portregeln).</span><span class="sxs-lookup"><span data-stu-id="c0cbd-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="c0cbd-142">Erfordert keine SNAT-Konfiguration für eingehende Anforderungen.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="c0cbd-143">Aktiv/Passiv</span><span class="sxs-lookup"><span data-stu-id="c0cbd-143">Active-passive</span></span><br/><span data-ttu-id="c0cbd-144">Erfordert einen Failoverprozess.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-144">Requires a failover process</span></span><br/><span data-ttu-id="c0cbd-145">Sondierung und Failoverlogik werden außerhalb des virtuellen Netzwerks ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-145">Probing and failover logic run outside the virtual network</span></span> |

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="c0cbd-146">Eingehender Datenverkehr mit Layer-7-NVAs</span><span class="sxs-lookup"><span data-stu-id="c0cbd-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="c0cbd-147">Die folgende Abbildung zeigt eine Hochverfügbarkeitsarchitektur, die eine DMZ für eingehenden Datenverkehr hinter einem Lastenausgleich mit Internetzugriff implementiert.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="c0cbd-148">Diese Architektur bietet Konnektivität für Azure-Workloads für den Layer-7-Datenverkehr, z. B. HTTP oder HTTPS:</span><span class="sxs-lookup"><span data-stu-id="c0cbd-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="c0cbd-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="c0cbd-149">![[1]][1]</span></span>

<span data-ttu-id="c0cbd-150">Der Vorteil dieser Architektur ist, dass alle NVAs aktiv sind, und bei Ausfall eines NVA wird der Netzwerkdatenverkehr durch den Lastenausgleich an das andere NVA weitergeleitet.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="c0cbd-151">Beide NVAs leiten den Datenverkehr an den internen Lastenausgleich, sodass der Datenverkehr weiter fließt, solange ein NVA aktiv ist.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="c0cbd-152">Die NVAs sind erforderlich, um den für virtuelle Computer der Webebene vorgesehenen SSL-Datenverkehr zu beenden.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="c0cbd-153">Diese NVAs können nicht auf die Handhabung des lokalen Datenverkehrs ausgeweitet werden, da für den lokalen Datenverkehr eine andere dedizierte Gruppe von NVAs mit eigenen Netzwerkrouten erforderlich ist.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="c0cbd-154">Diese Architektur wird in der Referenzarchitektur für die [DMZ zwischen Azure und Ihrem lokalen Rechenzentrum][dmz-on-prem] und der Referenzarchitektur für die [DMZ zwischen Azure und dem Internet][dmz-internet] verwendet.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="c0cbd-155">Jede dieser Referenzarchitekturen umfasst eine Bereitstellungslösung, die Sie verwenden können.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="c0cbd-156">Weitere Informationen stehen über die Links bereit.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="c0cbd-157">Ausgehender Datenverkehr mit Layer-7-NVAs</span><span class="sxs-lookup"><span data-stu-id="c0cbd-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="c0cbd-158">Die vorherige Architektur kann so erweitert werden, dass sie eine ausgehende DMZ für Anforderungen umfasst, die aus der Azure-Workload stammen.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="c0cbd-159">Die folgende Architektur bietet Hochverfügbarkeit der NVAs in der DMZ für den Layer-7-Datenverkehr, z. B. HTTP oder HTTPS:</span><span class="sxs-lookup"><span data-stu-id="c0cbd-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="c0cbd-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="c0cbd-160">![[2]][2]</span></span>

<span data-ttu-id="c0cbd-161">In dieser Architektur wird der gesamte aus Azure stammende Datenverkehr an einen internen Lastenausgleich weitergeleitet.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="c0cbd-162">Der Lastenausgleich verteilt ausgehende Anforderungen auf eine Gruppe von NVAs.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="c0cbd-163">Diese NVAs leiten den Datenverkehr über ihre jeweiligen öffentlichen IP-Adressen an das Internet weiter.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="c0cbd-164">Diese Architektur wird in der Referenzarchitektur für die [DMZ zwischen Azure und Ihrem lokalen Rechenzentrum][dmz-on-prem] und der Referenzarchitektur für die [DMZ zwischen Azure und dem Internet][dmz-internet] verwendet.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="c0cbd-165">Jede dieser Referenzarchitekturen umfasst eine Bereitstellungslösung, die Sie verwenden können.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="c0cbd-166">Weitere Informationen stehen über die Links bereit.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="c0cbd-167">Eingehender/ausgehender Datenverkehr mit Layer-7-NVAs</span><span class="sxs-lookup"><span data-stu-id="c0cbd-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="c0cbd-168">Bei den beiden vorherigen Architekturen gab es eine separate DMZ für eingehenden und ausgehenden Datenverkehr.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="c0cbd-169">Die folgende Architektur veranschaulicht das Erstellen einer DMZ, die sowohl für eingehenden als auch ausgehenden Layer-7-Datenverkehr, z. B. HTTP oder HTTPS, verwendet werden kann:</span><span class="sxs-lookup"><span data-stu-id="c0cbd-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="c0cbd-171">In dieser Architektur verarbeiten die NVAs eingehende Anforderungen vom Anwendungsgateway.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="c0cbd-172">Die NVAs verarbeiten auch ausgehende Anforderungen von den Workload-VMs im Back-End-Pool des Lastenausgleichs.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="c0cbd-173">Da eingehender Datenverkehr mit einem Anwendungsgateway und ausgehender Datenverkehr mit einem Lastenausgleich weitergeleitet wird, sind die NVAs für die Bewahrung der Sitzungsaffinität zuständig.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="c0cbd-174">Das heißt, dass das Anwendungsgateway eine Zuordnung von eingehenden und ausgehenden Anforderungen verwaltet, damit es die richtige Antwort an den ursprünglichen Anforderer weiterleiten kann.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="c0cbd-175">Der interne Lastenausgleich hat jedoch keinen Zugriff auf die Zuordnungen des Anwendungsgateways und verwendet eine eigene Logik zum Senden von Antworten an die NVAs.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="c0cbd-176">Es ist möglich, dass der Lastenausgleich eine Antwort an ein NVA sendet, das die Anforderung nicht ursprünglich vom Anwendungsgateway empfangen hat.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="c0cbd-177">In diesem Fall müssen die NVAs kommunizieren und die Antwort untereinander übertragen, damit das richtige NVA die Antwort an das Anwendungsgateway weiterleiten kann.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="c0cbd-178">Sie können das Problem des asymmetrischen Routings auch beheben, indem Sie sicherstellen, dass die NVAs eine eingehende Übersetzung der Quellnetzwerkadresse (SNAT) ausführen.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="c0cbd-179">Dadurch wird die ursprüngliche Quell-IP des Anforderers durch eine der IP-Adressen des NVA ersetzt, der für den eingehenden Datenfluss verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="c0cbd-180">Auf diese Weise ist sichergestellt, dass Sie mehrere NVAs gleichzeitig verwenden und dabei die Routensymmetrie beibehalten können.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="c0cbd-181">PIP/UDR-Switch mit Layer-4-NVAs</span><span class="sxs-lookup"><span data-stu-id="c0cbd-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="c0cbd-182">Die folgende Architektur weist ein aktives und ein passives NVA auf.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="c0cbd-183">Diese Architektur verarbeitet sowohl eingehenden als auch ausgehenden Layer-4-Datenverkehr:</span><span class="sxs-lookup"><span data-stu-id="c0cbd-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="c0cbd-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="c0cbd-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="c0cbd-185">Eine vollständige Lösung für diese Architektur ist auf [GitHub][pnp-ha-nva] verfügbar.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="c0cbd-186">Diese Architektur ähnelt der ersten in diesem Artikel erläuterten Architektur.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="c0cbd-187">Die erste Architektur enthielt ein einzelnes NVA zum Akzeptieren und Filtern eingehender Layer-4-Anforderungen.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="c0cbd-188">Bei dieser Architektur wird nun ein zweites passives NVA zur Bereitstellung von hoher Verfügbarkeit hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="c0cbd-189">Wenn beim aktiven NVA ein Fehler auftritt, wird das passive NVA aktiviert, und UDR und PIP werden so geändert, dass sie auf die NICs auf dem jetzt aktiven NVA verweisen.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="c0cbd-190">Diese Änderungen von UDR und PIP können entweder manuell erfolgen oder mithilfe eines automatisierten Prozesses.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="c0cbd-191">Bei dem automatisierten Prozess handelt es sich in der Regel um einen Daemon oder einen anderen Überwachungsdienst, der in Azure ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="c0cbd-192">Er fragt einen Integritätstest für das aktive NVA ab und führt den UDR- und PIP-Switch aus, wenn er einen Fehler beim NVA entdeckt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="c0cbd-193">Die Abbildung oben zeigt einen [ZooKeeper][zookeeper]-Beispielcluster mit einem Daemon für hohe Verfügbarkeit.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="c0cbd-194">Innerhalb des ZooKeeper-Clusters wählt ein Quorum von Knoten einen übergeordneten Knoten.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="c0cbd-195">Wenn bei diesem ein Fehler auftritt, wählen die übrigen Knoten einen neuen übergeordneten Knoten.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="c0cbd-196">Bei dieser Architektur führt der übergeordnete Knoten den Daemon aus, der den Integritätsendpunkt auf dem NVA abfragt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="c0cbd-197">Wenn das NVA nicht auf den Integritätstest reagiert, aktiviert der Daemon das passive NVA.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="c0cbd-198">Der Daemon ruft dann die Azure-REST-API auf, um den PIP vom fehlerhaften NVA zu entfernen, und fügt diesen an das neu aktivierte NVA an.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="c0cbd-199">Dann ändert der Daemon die UDR so, dass sie auf die interne IP-Adresse des neu aktivierten NVA verweist.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="c0cbd-200">Schließen Sie die ZooKeeper-Knoten nicht in ein Subnetz ein, auf das nur über eine Route zugegriffen werden kann, die das NVA enthält.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="c0cbd-201">Andernfalls kann bei einem Fehler des NVA nicht auf die ZooKeeper-Knoten zugegriffen werden.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="c0cbd-202">Sollte aus irgendeinem Grund ein Fehler beim Daemon auftreten, können Sie auf keinen der ZooKeeper-Knoten zugreifen, um das Problem zu diagnostizieren.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="c0cbd-203">Die vollständige Lösung einschließlich Beispielcode finden Sie in den Dateien im [GitHub-Repository][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="c0cbd-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="c0cbd-204">PIP/UDR-NVAs ohne SNAT</span><span class="sxs-lookup"><span data-stu-id="c0cbd-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="c0cbd-205">Bei dieser Architektur werden zwei virtuelle Azure-Computer verwendet, um die NVA-Firewall in einer Aktiv/Passiv-Konfiguration zu hosten, die automatische Failovervorgänge unterstützt, aber keine Übersetzung der Quellnetzwerkadresse (Source Network Address Translation, SNAT) benötigt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![Architektur mit PIP/UDR-NVAs ohne SNAT](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="c0cbd-207">Eine vollständige Lösung für diese Architektur ist auf [GitHub][ha-nva-fo] verfügbar.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="c0cbd-208">Diese Lösung ist für Azure-Kunden konzipiert, die SNAT nicht für eingehende Anforderungen in Ihrer NVA-Firewall konfigurieren können.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="c0cbd-209">SNAT blendet die ursprüngliche Quellclient-IP-Adresse aus.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="c0cbd-210">Wenn Sie die ursprünglichen IP-Adressen protokollieren oder innerhalb anderer mehrstufiger Sicherheitskomponenten hinter Ihren NVAs verwenden möchten, ist diese Lösung grundsätzlich geeignet.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="c0cbd-211">Das Failover von UDR-Tabelleneinträgen wird mittels einer Adresse für den nächsten Hop automatisiert, die auf die IP-Adresse einer Schnittstelle des virtuellen Computers mit der aktiven NVA-Firewall festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="c0cbd-212">Die Logik für das automatische Failover wird in einer Funktions-App gehostet, die Sie mithilfe von [Azure Functions](/azure/azure-functions/) erstellen.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="c0cbd-213">Der Failovercode wird als serverlose Funktion in Azure Functions ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="c0cbd-214">Die Bereitstellung ist unkompliziert und kostengünstig und lässt sich einfach verwalten und anpassen.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="c0cbd-215">Und da die Funktions-App in Azure Functions gehostet wird, ist sie nicht vom virtuellen Netzwerk abhängig.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="c0cbd-216">Wenn sich Änderungen am virtuellen Netzwerk auf die NVA-Firewalls auswirken, wird die Funktions-App weiterhin unabhängig ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="c0cbd-217">Auch Tests sind genauer, da sie außerhalb des virtuellen Netzwerks und unter Verwendung der gleichen Route ausgeführt werden, die auch für eingehende Clientanforderungen verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="c0cbd-218">Die Verfügbarkeit der NVA-Firewall wird vom Code der Funktions-App auf zwei Arten überprüft:</span><span class="sxs-lookup"><span data-stu-id="c0cbd-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="c0cbd-219">Überwachen des Zustands der virtuellen Azure-Computer, die die NVA-Firewall hosten</span><span class="sxs-lookup"><span data-stu-id="c0cbd-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="c0cbd-220">Testen, ob in der Firewall ein offener Port zum Back-End-Webserver vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="c0cbd-221">Für diese Option muss das virtuelle Netzwerkgerät über PIP einen Socket verfügbar machen, den der Code der Funktions-App testen kann.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="c0cbd-222">Der gewünschte Test wird beim Konfigurieren der Funktions-App ausgewählt.</span><span class="sxs-lookup"><span data-stu-id="c0cbd-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="c0cbd-223">Die vollständige Lösung einschließlich Beispielcode finden Sie in den Dateien im [GitHub-Repository][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="c0cbd-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="c0cbd-224">Nächste Schritte</span><span class="sxs-lookup"><span data-stu-id="c0cbd-224">Next steps</span></span>

- <span data-ttu-id="c0cbd-225">Erfahren Sie, wie Sie mithilfe von Layer-7-NVAs [eine DMZ zwischen Azure und Ihrem lokalen Rechenzentrum implementieren][dmz-on-prem].</span><span class="sxs-lookup"><span data-stu-id="c0cbd-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-prem] using layer-7 NVAs.</span></span>
- <span data-ttu-id="c0cbd-226">Erfahren Sie, wie Sie mithilfe von Layer-7-NVAs [eine DMZ zwischen Azure und dem Internet implementieren][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="c0cbd-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="c0cbd-227">Behandeln von Problemen mit virtuellen Netzwerkappliances in Azure</span><span class="sxs-lookup"><span data-stu-id="c0cbd-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "Architektur mit einzelnem NVA"
[1]: ./images/nva-ha/l7-ingress.png "Eingehender Layer-7-Datenverkehr"
[2]: ./images/nva-ha/l7-ingress-egress.png "Ausgehender Layer-7-Datenverkehr"
[3]: ./images/nva-ha/active-passive.png "Aktiv/Passiv-Cluster"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png

---
title: Protokollieren und Überwachen in Microservices
description: Protokollieren und Überwachen in Microservices
author: MikeWasson
ms.date: 10/23/2018
ms.openlocfilehash: 9d385a141edb34b2b0f4badb7dfcaf53baac2666
ms.sourcegitcommit: 1b5411f07d74f0a0680b33c266227d24014ba4d1
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 11/26/2018
ms.locfileid: "52305909"
---
# <a name="designing-microservices-logging-and-monitoring"></a><span data-ttu-id="02975-103">Entwerfen von Microservices: Protokollieren und Überwachen</span><span class="sxs-lookup"><span data-stu-id="02975-103">Designing microservices: Logging and monitoring</span></span>

<span data-ttu-id="02975-104">In jeder komplexen Anwendung geht irgendwann etwas schief.</span><span class="sxs-lookup"><span data-stu-id="02975-104">In any complex application, at some point something will go wrong.</span></span> <span data-ttu-id="02975-105">In einer Microserviceanwendung ist es erforderlich, dass Sie nachverfolgen, was für Dutzende oder sogar Hunderte von Diensten passiert.</span><span class="sxs-lookup"><span data-stu-id="02975-105">In a microservices application, you need to track what's happening across dozens or even hundreds of services.</span></span> <span data-ttu-id="02975-106">Die Protokollierung und die Überwachung sind von entscheidender Bedeutung, damit Sie sich einen ganzheitlichen Überblick über das System verschaffen können.</span><span class="sxs-lookup"><span data-stu-id="02975-106">Logging and monitoring are critically important to give you a holistic view of the system.</span></span> 

![](./images/monitoring.png)

<span data-ttu-id="02975-107">In einer Microservices-Architektur kann es eine besondere Herausforderung darstellen, die genaue Ursache von Fehlern oder Leistungsengpässen zu ermitteln.</span><span class="sxs-lookup"><span data-stu-id="02975-107">In a microservices architecture, it can be especially challenging to pinpoint the exact cause of errors or performance bottlenecks.</span></span> <span data-ttu-id="02975-108">Ein einzelner Benutzervorgang kann mehrere Dienste betreffen.</span><span class="sxs-lookup"><span data-stu-id="02975-108">A single user operation might span multiple services.</span></span> <span data-ttu-id="02975-109">Dienste können im Cluster an Netzwerk-E/A-Grenzen stoßen.</span><span class="sxs-lookup"><span data-stu-id="02975-109">Services may hit network I/O limits inside the cluster.</span></span> <span data-ttu-id="02975-110">Eine Kette von übergreifenden Aufrufen für Dienste kann im System zu Rückstaus und somit zu langen Wartezeiten oder kaskadierenden Fehlern führen.</span><span class="sxs-lookup"><span data-stu-id="02975-110">A chain of calls across services may cause backpressure in the system, resulting in high latency or cascading failures.</span></span> <span data-ttu-id="02975-111">Außerdem wissen Sie im Allgemeinen nicht, auf welchem Knoten ein bestimmter Container ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="02975-111">Moreover, you generally don't know which node a particular container will run in.</span></span> <span data-ttu-id="02975-112">Container, die auf demselben Knoten angeordnet sind, konkurrieren ggf. um begrenzte CPU- oder Arbeitsspeicherkapazität.</span><span class="sxs-lookup"><span data-stu-id="02975-112">Containers placed on the same node may be competing for limited CPU or memory.</span></span> 

<span data-ttu-id="02975-113">Damit ermittelt werden kann, was vor sich geht, müssen Sie Telemetriedaten aus der Anwendung erfassen.</span><span class="sxs-lookup"><span data-stu-id="02975-113">To make sense of what's happening, you must collect telemetry from the application.</span></span>  <span data-ttu-id="02975-114">Telemetrie kann in *Protokolle* und *Metriken* unterteilt werden.</span><span class="sxs-lookup"><span data-stu-id="02975-114">Telemetry can be divided into *logs* and *metrics*.</span></span> <span data-ttu-id="02975-115">[Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview) erfasst sowohl Protokolle als auch Metriken aus der gesamten Azure-Plattform.</span><span class="sxs-lookup"><span data-stu-id="02975-115">[Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview) collects both logs and metrics across the Azure platform.</span></span>

<span data-ttu-id="02975-116">**Protokolle** sind textbasierte Datensätze mit Ereignissen, die eintreten, während die Anwendung ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="02975-116">**Logs** are text-based records of events that occur while the application is running.</span></span> <span data-ttu-id="02975-117">Sie enthalten Dinge wie Anwendungsprotokolle (Überwachungsanweisungen) oder Webserverprotokolle.</span><span class="sxs-lookup"><span data-stu-id="02975-117">They include things like application logs (trace statements) or web server logs.</span></span> <span data-ttu-id="02975-118">Protokolle sind hauptsächlich für forensische Zwecke und die Analyse der Grundursache hilfreich.</span><span class="sxs-lookup"><span data-stu-id="02975-118">Logs are primarily useful for forensics and root cause analysis.</span></span> 

<span data-ttu-id="02975-119">**Metriken** sind numerische Werte, die analysiert werden können.</span><span class="sxs-lookup"><span data-stu-id="02975-119">**Metrics** are numerical values that can be analyzed.</span></span> <span data-ttu-id="02975-120">Sie können sie verwenden, um das System in Echtzeit (bzw. nahezu in Echtzeit) zu beobachten oder Leistungstrends im Zeitverlauf zu analysieren.</span><span class="sxs-lookup"><span data-stu-id="02975-120">You can use them to observe the system in real time (or close to real time), or to analyze performance trends over time.</span></span> <span data-ttu-id="02975-121">Metriken lassen sich in folgende Unterkategorien weiter unterteilen:</span><span class="sxs-lookup"><span data-stu-id="02975-121">Metrics can be further subcategorized as follows:</span></span>

- <span data-ttu-id="02975-122">Metriken auf **Knotenebene**, z.B. Auslastung von CPU, Arbeitsspeicher, Netzwerk, Datenträger und Dateisystem.</span><span class="sxs-lookup"><span data-stu-id="02975-122">**Node-level** metrics, including CPU, memory, network, disk, and file system usage.</span></span> <span data-ttu-id="02975-123">Systemmetriken fördern das Verständnis der Ressourcenzuteilung für die einzelnen Knoten im Cluster und ermöglichen die Problembehandlung bei Ausreißern.</span><span class="sxs-lookup"><span data-stu-id="02975-123">System metrics help you to understand resource allocation for each node in the cluster, and troubleshoot outliers.</span></span>

- <span data-ttu-id="02975-124">**Containermetriken**</span><span class="sxs-lookup"><span data-stu-id="02975-124">**Container** metrics.</span></span> <span data-ttu-id="02975-125">Wenn Dienste innerhalb von Containern ausgeführt werden, müssen Sie Metriken nicht nur auf der VM-Ebene, sondern auch auf der Containerebene sammeln.</span><span class="sxs-lookup"><span data-stu-id="02975-125">If services are run inside containers, you need to collect metrics at the container level, not just at the VM level.</span></span> <span data-ttu-id="02975-126">Sie können Azure Monitor für die Überwachung von Containerworkloads in Azure Kubernetes Service (AKS) einrichten.</span><span class="sxs-lookup"><span data-stu-id="02975-126">You can set up Azure Monitor to monitor container workloads in Azure Kubernetes Service (AKS).</span></span> <span data-ttu-id="02975-127">Weitere Informationen finden Sie unter [Azure Monitor für Container – Übersicht](/azure/monitoring/monitoring-container-insights-overview).</span><span class="sxs-lookup"><span data-stu-id="02975-127">For more information, see [Azure Monitor for containers overview](/azure/monitoring/monitoring-container-insights-overview).</span></span> <span data-ttu-id="02975-128">Verwenden Sie für andere Containerorchestratoren die [Containerüberwachungslösung in Log Analytics](/azure/log-analytics/log-analytics-containers).</span><span class="sxs-lookup"><span data-stu-id="02975-128">For other container orchestrators, use the [Container Monitoring solution in Log Analytics](/azure/log-analytics/log-analytics-containers).</span></span>

- <span data-ttu-id="02975-129">**Anwendungsmetriken**.</span><span class="sxs-lookup"><span data-stu-id="02975-129">**Application** metrics.</span></span> <span data-ttu-id="02975-130">Hierzu gehören alle Metriken, die für das Verständnis des Verhaltens eines Diensts relevant sind.</span><span class="sxs-lookup"><span data-stu-id="02975-130">This includes any metrics that are relevant to understanding the behavior of a service.</span></span> <span data-ttu-id="02975-131">Beispiele hierfür sind die Anzahl von in die Warteschlange eingereihten eingehenden HTTP-Anforderungen, die Anforderungswartezeit oder die Länge der Nachrichtenwarteschlange.</span><span class="sxs-lookup"><span data-stu-id="02975-131">Examples include the number of queued inbound HTTP requests, request latency, or message queue length.</span></span> <span data-ttu-id="02975-132">Anwendungen können auch benutzerdefinierte Metriken für die jeweilige Domäne erstellen, z.B. die Anzahl der pro Minute verarbeiteten Geschäftstransaktionen.</span><span class="sxs-lookup"><span data-stu-id="02975-132">Applications can also create custom metrics that are specific to the domain, such as the number of business transactions processed per minute.</span></span> <span data-ttu-id="02975-133">Aktivieren Sie Anwendungsmetriken mithilfe von [Application Insights](/azure/application-insights/app-insights-overview).</span><span class="sxs-lookup"><span data-stu-id="02975-133">Use [Application Insights](/azure/application-insights/app-insights-overview) to enable application metrics.</span></span> 

- <span data-ttu-id="02975-134">Metriken **abhängiger Dienste**.</span><span class="sxs-lookup"><span data-stu-id="02975-134">**Dependent service** metrics.</span></span> <span data-ttu-id="02975-135">Dienste können externe Dienste oder Endpunkte aufrufen, z.B. verwaltete PaaS-Dienste oder SaaS-Dienste.</span><span class="sxs-lookup"><span data-stu-id="02975-135">Services may call external services or endpoints, such as managed PaaS services or SaaS services.</span></span> <span data-ttu-id="02975-136">Von Drittanbieterdiensten werden Metriken bereitgestellt oder auch nicht.</span><span class="sxs-lookup"><span data-stu-id="02975-136">Third-party services may or may not provide any metrics.</span></span> <span data-ttu-id="02975-137">Falls nicht, müssen Sie Ihre eigenen Anwendungsmetriken verwenden, um Statistiken in Bezug auf die Wartezeit und Fehlerrate nachzuverfolgen.</span><span class="sxs-lookup"><span data-stu-id="02975-137">If not, you'll have to rely on your own application metrics to track statistics for latency and error rate.</span></span>

## <a name="considerations"></a><span data-ttu-id="02975-138">Überlegungen</span><span class="sxs-lookup"><span data-stu-id="02975-138">Considerations</span></span>

<span data-ttu-id="02975-139">Im Artikel [Überwachung und Diagnose](../best-practices/monitoring.md) werden allgemeine Methoden zur Überwachung einer Anwendung beschrieben.</span><span class="sxs-lookup"><span data-stu-id="02975-139">The article [Monitoring and diagnostics](../best-practices/monitoring.md) describes general best practices for monitoring an application.</span></span> <span data-ttu-id="02975-140">Im Folgenden sind einige Aspekte aufgeführt, die im Zusammenhang mit einer Microservices-Architektur bedacht werden sollten.</span><span class="sxs-lookup"><span data-stu-id="02975-140">Here are some particular things to think about in the context of a microservices architecture.</span></span>

<span data-ttu-id="02975-141">**Konfiguration und Verwaltung**:</span><span class="sxs-lookup"><span data-stu-id="02975-141">**Configuration and management**.</span></span> <span data-ttu-id="02975-142">Verwenden Sie einen verwalteten Dienst für die Protokollierung und Überwachung, oder stellen Sie Protokollierungs- und Überwachungskomponenten als Container im Cluster bereit?</span><span class="sxs-lookup"><span data-stu-id="02975-142">Will you use a managed service for logging and monitoring, or deploy logging and monitoring components as containers inside the cluster?</span></span> <span data-ttu-id="02975-143">Eine nähere Beschreibung dieser Optionen finden Sie unten im Abschnitt [Technologieoptionen](#technology-options).</span><span class="sxs-lookup"><span data-stu-id="02975-143">For more discussion of these options, see the section [Technology Options](#technology-options) below.</span></span>

<span data-ttu-id="02975-144">**Erfassungsrate**:</span><span class="sxs-lookup"><span data-stu-id="02975-144">**Ingestion rate**.</span></span> <span data-ttu-id="02975-145">Wie hoch ist der Durchsatz, mit dem das System Telemetrieereignisse erfassen kann?</span><span class="sxs-lookup"><span data-stu-id="02975-145">What is the throughput at which the system can ingest telemetry events?</span></span> <span data-ttu-id="02975-146">Was passiert, wenn diese Rate überschritten wird?</span><span class="sxs-lookup"><span data-stu-id="02975-146">What happens if that rate is exceeded?</span></span> <span data-ttu-id="02975-147">Vom System können beispielsweise Clients gedrosselt werden, sodass Telemetriedaten verloren gehen, oder für die Daten kann das Downsampling durchgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="02975-147">For example, the system may throttle clients, in which case telemetry data is lost, or it may downsample the data.</span></span> <span data-ttu-id="02975-148">In einigen Fällen können Sie dieses Problem lösen, indem Sie die gesammelte Datenmenge reduzieren:</span><span class="sxs-lookup"><span data-stu-id="02975-148">Sometimes you can mitigate this problem by reducing the amount of data that you collect:</span></span>

  - <span data-ttu-id="02975-149">Aggregieren Sie Metriken, indem Sie Statistiken berechnen, z.B. die mittlere und die Standardabweichung, und diese statistischen Daten an das Überwachungssystem senden.</span><span class="sxs-lookup"><span data-stu-id="02975-149">Aggregate metrics by calculating statistics, such as average and standard deviation, and send that statistical data to the monitoring system.</span></span>  

  - <span data-ttu-id="02975-150">Führen Sie für die Daten das Downsampling durch – verarbeiten Sie also nur einen bestimmten Prozentsatz der Daten.</span><span class="sxs-lookup"><span data-stu-id="02975-150">Downsample the data &mdash; that is, process only a percentage of the events.</span></span>

  - <span data-ttu-id="02975-151">Ordnen Sie die Daten in Batches an, um die Anzahl von Netzwerkaufrufen des Überwachungsdiensts zu reduzieren.</span><span class="sxs-lookup"><span data-stu-id="02975-151">Batch the data to reduce the number of network calls to the monitoring service.</span></span>

<span data-ttu-id="02975-152">**Kosten**:</span><span class="sxs-lookup"><span data-stu-id="02975-152">**Cost**.</span></span> <span data-ttu-id="02975-153">Die Kosten für das Erfassen und Speichern von Telemetriedaten können, vor allem bei hohen Volumen, hoch sein.</span><span class="sxs-lookup"><span data-stu-id="02975-153">The cost of ingesting and storing telemetry data may be high, especially at high volumes.</span></span> <span data-ttu-id="02975-154">Manchmal kann dies sogar die Kosten für die Ausführung der Anwendung übersteigen.</span><span class="sxs-lookup"><span data-stu-id="02975-154">In some cases it could even exceed the cost of running the application.</span></span> <span data-ttu-id="02975-155">In diesem Fall müssen Sie das Telemetrievolumen unter Umständen verringern, indem Sie für die Daten wie oben beschrieben eine Aggregierung, das Downsampling oder die Anordnung in Batches durchführen.</span><span class="sxs-lookup"><span data-stu-id="02975-155">In that case, you may need to reduce the volume of telemetry by aggregating, downsampling, or batching the data, as described above.</span></span> 
        
<span data-ttu-id="02975-156">**Datengenauigkeit**:</span><span class="sxs-lookup"><span data-stu-id="02975-156">**Data fidelity**.</span></span> <span data-ttu-id="02975-157">Wie genau sind die Metriken?</span><span class="sxs-lookup"><span data-stu-id="02975-157">How accurate are the metrics?</span></span> <span data-ttu-id="02975-158">Durchschnittswerte können Ausreißer überdecken, vor allem bei einem größeren Umfang.</span><span class="sxs-lookup"><span data-stu-id="02975-158">Averages can hide outliers, especially at scale.</span></span> <span data-ttu-id="02975-159">Wenn die Rate für die Stichprobenentnahme zu niedrig ist, kann dies zu einer Glättung von Fluktuationen in den Daten führen.</span><span class="sxs-lookup"><span data-stu-id="02975-159">Also, if the sampling rate is too low, it can smooth out fluctuations in the data.</span></span> <span data-ttu-id="02975-160">Unter Umständen entsteht so der Eindruck, dass alle Anforderungen über die gleiche End-to-End-Wartezeit verfügen, während ein signifikanter Teil der Anforderungen tatsächlich deutlich mehr Zeit benötigt.</span><span class="sxs-lookup"><span data-stu-id="02975-160">It may appear that all requests have about the same end-to-end latency, when in fact a significant fraction of requests are taking much longer.</span></span> 

<span data-ttu-id="02975-161">**Wartezeit**:</span><span class="sxs-lookup"><span data-stu-id="02975-161">**Latency**.</span></span> <span data-ttu-id="02975-162">Zur Ermöglichung von Überwachung und Warnungen in Echtzeit sollten Telemetriedaten schnell verfügbar sein.</span><span class="sxs-lookup"><span data-stu-id="02975-162">To enable real-time monitoring and alerts, telemetry data should be available quickly.</span></span> <span data-ttu-id="02975-163">Wie nah an der Echtzeit sind die Daten, die im Dashboard für die Überwachung angezeigt werden?</span><span class="sxs-lookup"><span data-stu-id="02975-163">How "real-time" is the data that appears on the monitoring dashboard?</span></span> <span data-ttu-id="02975-164">Sind sie einige Sekunden alt?</span><span class="sxs-lookup"><span data-stu-id="02975-164">A few seconds old?</span></span> <span data-ttu-id="02975-165">Mehr als eine Minute?</span><span class="sxs-lookup"><span data-stu-id="02975-165">More than a minute?</span></span>

<span data-ttu-id="02975-166">**Speicher**:</span><span class="sxs-lookup"><span data-stu-id="02975-166">**Storage.**</span></span> <span data-ttu-id="02975-167">Für Protokolle ist es ggf. am effizientesten, die Protokollereignisse im Cluster in flüchtigen Speicher zu schreiben und einen Agent zu konfigurieren, mit dem die Protokolldateien in beständigeren Speicher übertragen werden.</span><span class="sxs-lookup"><span data-stu-id="02975-167">For logs, it may be most efficient to write the log events to ephemeral storage in the cluster, and configure an agent to ship the log files to more persistent storage.</span></span>  <span data-ttu-id="02975-168">Daten sollten letztendlich in langfristigen Speicher verschoben werden, damit sie für retrospektive Analysen verfügbar sind.</span><span class="sxs-lookup"><span data-stu-id="02975-168">Data should eventually be moved to long-term storage so that it's available for retrospective analysis.</span></span> <span data-ttu-id="02975-169">Da in einer Microservices-Architektur ein hohes Volumen von Telemetriedaten generiert werden kann, stellen die Kosten für die Speicherung dieser Daten einen wichtigen Aspekt dar.</span><span class="sxs-lookup"><span data-stu-id="02975-169">A microservices architecture can generate a large volume of telemetry data, so the cost of storing that data is an important consideration.</span></span> <span data-ttu-id="02975-170">Berücksichtigen Sie auch, wie die Daten abgefragt werden sollen.</span><span class="sxs-lookup"><span data-stu-id="02975-170">Also consider how you will query the data.</span></span> 

<span data-ttu-id="02975-171">**Dashboard und Visualisierung**:</span><span class="sxs-lookup"><span data-stu-id="02975-171">**Dashboard and visualization.**</span></span> <span data-ttu-id="02975-172">Können Sie sich einen ganzheitlichen Überblick über das System und alle Dienste verschaffen – sowohl im Cluster als auch für externe Dienste?</span><span class="sxs-lookup"><span data-stu-id="02975-172">Do you get a holistic view of the system, across all of the services, both within the cluster and external services?</span></span> <span data-ttu-id="02975-173">Können im Dashboard alle Daten angezeigt und korreliert werden, wenn Sie Telemetriedaten und Protokolle an mehr als einem Speicherort schreiben?</span><span class="sxs-lookup"><span data-stu-id="02975-173">If you are writing telemetry data and logs to more than one location, can the dashboard show all of them and correlate?</span></span> <span data-ttu-id="02975-174">Im Dashboard für die Überwachung sollten mindestens die folgenden Informationen angezeigt werden:</span><span class="sxs-lookup"><span data-stu-id="02975-174">The monitoring dashboard should show at least the following information:</span></span>

- <span data-ttu-id="02975-175">Allgemeine Ressourcenzuteilung in Bezug auf Kapazität und Wachstum.</span><span class="sxs-lookup"><span data-stu-id="02975-175">Overall resource allocation for capacity and growth.</span></span> <span data-ttu-id="02975-176">Dies umfasst die Zuteilung der Anzahl von Containern, der Dateisystemmetriken, des Netzwerks und der Kerne.</span><span class="sxs-lookup"><span data-stu-id="02975-176">This includes the number of containers, file system metrics, network, and core allocation.</span></span>
- <span data-ttu-id="02975-177">Auf Dienstebene korrelierte Containermetriken</span><span class="sxs-lookup"><span data-stu-id="02975-177">Container metrics correlated at the service level.</span></span>
- <span data-ttu-id="02975-178">Mit Containern korrelierte Systemmetriken</span><span class="sxs-lookup"><span data-stu-id="02975-178">System metrics correlated with containers.</span></span>
- <span data-ttu-id="02975-179">Dienstfehler und Ausreißer</span><span class="sxs-lookup"><span data-stu-id="02975-179">Service errors and outliers.</span></span>
    

## <a name="distributed-tracing"></a><span data-ttu-id="02975-180">Verteilte Ablaufverfolgung</span><span class="sxs-lookup"><span data-stu-id="02975-180">Distributed tracing</span></span>

<span data-ttu-id="02975-181">Wie bereits erwähnt, besteht bei Microservices eine Herausforderung darin, den Fluss der Ereignisse über Dienste hinweg zu verstehen.</span><span class="sxs-lookup"><span data-stu-id="02975-181">As mentioned, one challenge in microservices is understanding the flow of events across services.</span></span> <span data-ttu-id="02975-182">Ein einzelner Vorgang bzw. eine Transaktion kann Aufrufe mehrerer Dienste umfassen.</span><span class="sxs-lookup"><span data-stu-id="02975-182">A single operation or transaction may involve calls to multiple services.</span></span> <span data-ttu-id="02975-183">Um die gesamte Schrittsequenz neu zu erstellen, sollte jeder Dienst eine *Korrelations-ID* verteilen, die als eindeutiger Bezeichner für diesen Vorgang dient.</span><span class="sxs-lookup"><span data-stu-id="02975-183">To reconstruct the entire sequence of steps, each service should propagate a *correlation ID* that acts as a unique identifier for that operation.</span></span> <span data-ttu-id="02975-184">Die Korrelations-ID ermöglicht die [verteilte Ablaufverfolgung](https://microservices.io/patterns/observability/distributed-tracing.html) über Dienste hinweg.</span><span class="sxs-lookup"><span data-stu-id="02975-184">The correlation ID enables [distributed tracing](https://microservices.io/patterns/observability/distributed-tracing.html) across services.</span></span>

<span data-ttu-id="02975-185">Der erste Dienst, der eine Clientanforderung empfängt, sollte die Korrelations-ID generieren.</span><span class="sxs-lookup"><span data-stu-id="02975-185">The first service that receives a client request should generate the correlation ID.</span></span> <span data-ttu-id="02975-186">Wenn der Dienst einen HTTP-Aufruf eines anderen Diensts durchführt, wird die Korrelations-ID in einem Anforderungsheader angeordnet.</span><span class="sxs-lookup"><span data-stu-id="02975-186">If the service makes an HTTP call to another service, it puts the correlation ID in a request header.</span></span> <span data-ttu-id="02975-187">Entsprechend wird die Korrelations-ID in die Nachricht eingefügt, falls der Dienst eine asynchrone Nachricht sendet.</span><span class="sxs-lookup"><span data-stu-id="02975-187">Similarly, if the service sends an asynchronous message, it puts the correlation ID into the message.</span></span> <span data-ttu-id="02975-188">Nachgeschaltete Dienste setzen die Verteilung der Korrelations-ID fort, sodass diese im gesamten System weitergegeben wird.</span><span class="sxs-lookup"><span data-stu-id="02975-188">Downstream services continue to propagate the correlation ID, so that it flows through the entire system.</span></span> <span data-ttu-id="02975-189">Außerdem sollte der gesamte Code, mit dem Anwendungsmetriken oder Protokollereignisse geschrieben werden, die Korrelations-ID enthalten.</span><span class="sxs-lookup"><span data-stu-id="02975-189">In addition, all code that writes application metrics or log events should include the correlation ID.</span></span>

<span data-ttu-id="02975-190">Wenn Dienstaufrufe korreliert werden, können Sie betriebsbezogene Metriken berechnen, z.B. die End-to-End-Wartezeit bis zum Abschluss einer Transaktion, die Anzahl von erfolgreichen Transaktionen pro Sekunde und den Prozentsatz fehlgeschlagener Transaktionen.</span><span class="sxs-lookup"><span data-stu-id="02975-190">When service calls are correlated, you can calculate operational metrics such as the end-to-end latency for a complete transaction, the number of successful transactions per second, and the percentage of failed transactions.</span></span> <span data-ttu-id="02975-191">Das Einfügen von Korrelations-IDs in Anwendungsprotokolle ermöglicht die Durchführung einer Analyse der Grundursache.</span><span class="sxs-lookup"><span data-stu-id="02975-191">Including correlation IDs in application logs makes it possible to perform root cause analysis.</span></span> <span data-ttu-id="02975-192">Wenn ein Vorgang fehlschlägt, können Sie die Protokollanweisungen für alle Dienstaufrufe ermitteln, die Teil desselben Vorgangs waren.</span><span class="sxs-lookup"><span data-stu-id="02975-192">If an operation fails, you can find the log statements for all of the service calls that were part of the same operation.</span></span> 

<span data-ttu-id="02975-193">Hier sind einige Aspekte aufgeführt, die für die Implementierung der verteilten Ablaufverfolgung wichtig sind:</span><span class="sxs-lookup"><span data-stu-id="02975-193">Here are some considerations when implementing distributed tracing:</span></span>

- <span data-ttu-id="02975-194">Derzeit ist kein HTTP-Standardheader für Korrelations-IDs vorhanden.</span><span class="sxs-lookup"><span data-stu-id="02975-194">There is currently no standard HTTP header for correlation IDs.</span></span> <span data-ttu-id="02975-195">Ihr Team sollte standardmäßig einen benutzerdefinierten Headerwert verwenden.</span><span class="sxs-lookup"><span data-stu-id="02975-195">Your team should standardize on a custom header value.</span></span> <span data-ttu-id="02975-196">Treffen Sie die Wahl basierend auf Ihrem Framework für die Protokollierung bzw. Überwachung oder anhand Ihres Dienstnetzes.</span><span class="sxs-lookup"><span data-stu-id="02975-196">The choice may be decided by your logging/monitoring framework or choice of service mesh.</span></span>

- <span data-ttu-id="02975-197">Falls Ihre Messaginginfrastruktur das Hinzufügen von Metadaten zu Nachrichten unterstützt, sollten Sie die Korrelations-ID für asynchrone Nachrichten in Form von Metadaten einbinden.</span><span class="sxs-lookup"><span data-stu-id="02975-197">For asynchronous messages, if your messaging infrastructure supports adding metadata to messages, you should include the correlation ID as metadata.</span></span> <span data-ttu-id="02975-198">Fügen Sie sie andernfalls als Teil des Nachrichtenschemas ein.</span><span class="sxs-lookup"><span data-stu-id="02975-198">Otherwise, include it as part of the message schema.</span></span>

- <span data-ttu-id="02975-199">Anstelle eines einzelnen Opaque-Bezeichners können Sie auch einen *Korrelationskontext* mit umfassenderen Informationen senden, z.B. Beziehungen zwischen Aufrufer und Aufgerufenem.</span><span class="sxs-lookup"><span data-stu-id="02975-199">Rather than a single opaque identifier, you might send a *correlation context* that includes richer information, such as caller-callee relationships.</span></span> 

- <span data-ttu-id="02975-200">Mit dem Azure Application Insights-SDK wird automatisch Korrelationskontext in HTTP-Header und die Korrelations-ID in Application Insights-Protokolle eingefügt.</span><span class="sxs-lookup"><span data-stu-id="02975-200">The Azure Application Insights SDK automatically injects correlation context into HTTP headers, and includes the correlation ID in Application Insights logs.</span></span> <span data-ttu-id="02975-201">Wenn Sie sich dafür entscheiden, die in Application Insights integrierten Korrelationsfeatures zu verwenden, müssen einige Dienste je nach den genutzten Bibliotheken die Korrelationsheader trotzdem noch explizit verteilen.</span><span class="sxs-lookup"><span data-stu-id="02975-201">If you decide to use the correlation features built into Application Insights, some services may still need to explicitly propagate the correlation headers, depending on the libraries being used.</span></span> <span data-ttu-id="02975-202">Weitere Informationen finden Sie unter [Telemetriekorrelation in Application Insights](/azure/application-insights/application-insights-correlation).</span><span class="sxs-lookup"><span data-stu-id="02975-202">For more information, see [Telemetry correlation in Application Insights](/azure/application-insights/application-insights-correlation).</span></span>
   
- <span data-ttu-id="02975-203">Wenn Sie Istio oder linkerd als Dienstnetz verwenden, generieren diese Technologien automatisch Korrelationsheader, wenn HTTP-Aufrufe über die Dienstnetzproxys weitergeleitet werden.</span><span class="sxs-lookup"><span data-stu-id="02975-203">If you are using Istio or linkerd as a service mesh, these technologies automatically generate correlation headers when HTTP calls are routed through the service mesh proxies.</span></span> <span data-ttu-id="02975-204">Von den Diensten sollten jeweils die relevanten Header weitergeleitet werden.</span><span class="sxs-lookup"><span data-stu-id="02975-204">Services should forward the relevant headers.</span></span> 

    - <span data-ttu-id="02975-205">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html) (Verteilte Ablaufverfolgung von Anforderungen)</span><span class="sxs-lookup"><span data-stu-id="02975-205">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span></span>
    
    - <span data-ttu-id="02975-206">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers) (Kontextheader)</span><span class="sxs-lookup"><span data-stu-id="02975-206">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span></span>
    
- <span data-ttu-id="02975-207">Überlegen Sie sich, wie Protokolle aggregiert werden sollen.</span><span class="sxs-lookup"><span data-stu-id="02975-207">Consider how you will aggregate logs.</span></span> <span data-ttu-id="02975-208">Es kann ratsam sein, die Vorgehensweise beim Einbinden von Korrelations-IDs in Protokolle für alle Teams zu standardisieren.</span><span class="sxs-lookup"><span data-stu-id="02975-208">You may want to standardize across teams on how to include correlation IDs in logs.</span></span> <span data-ttu-id="02975-209">Verwenden Sie ein strukturiertes oder halbstrukturiertes Format, z.B. JSON, und definieren Sie ein gemeinsames Feld für die Korrelations-ID.</span><span class="sxs-lookup"><span data-stu-id="02975-209">Use a structured or semi-structured format, such as JSON, and define a common field to hold the correlation ID.</span></span>

## <a name="technology-options"></a><span data-ttu-id="02975-210">Technologieoptionen</span><span class="sxs-lookup"><span data-stu-id="02975-210">Technology options</span></span>

<span data-ttu-id="02975-211">**Application Insights** ist ein verwalteter Dienst in Azure, mit dem Telemetriedaten erfasst und gespeichert und Tools zum Analysieren von und Suchen nach Daten bereitgestellt werden.</span><span class="sxs-lookup"><span data-stu-id="02975-211">**Application Insights** is a managed service in Azure that ingests and stores telemetry data, and provides tools for analyzing and searching the data.</span></span> <span data-ttu-id="02975-212">Für die Nutzung von Application Insights installieren Sie in Ihrer Anwendung ein Instrumentierungspaket.</span><span class="sxs-lookup"><span data-stu-id="02975-212">To use Application Insights, you install an instrumentation package in your application.</span></span> <span data-ttu-id="02975-213">Dieses Paket überwacht die App und sendet Telemetriedaten an den Application Insights-Dienst.</span><span class="sxs-lookup"><span data-stu-id="02975-213">This package monitors the app and sends telemetry data to the Application Insights service.</span></span> <span data-ttu-id="02975-214">Außerdem können hiermit per Pullvorgang Telemetriedaten aus der Hostumgebung abgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="02975-214">It can also pull telemetry data from the host environment.</span></span> <span data-ttu-id="02975-215">Application Insights verfügt über eine integrierte Korrelations- und Abhängigkeitsnachverfolgung.</span><span class="sxs-lookup"><span data-stu-id="02975-215">Application Insights provides built-in correlation and dependency tracking.</span></span> <span data-ttu-id="02975-216">Sie können Systemmetriken, Anwendungsmetriken und Azure-Dienstmetriken zentral an einem Ort nachverfolgen.</span><span class="sxs-lookup"><span data-stu-id="02975-216">It lets you track system metrics, application metrics, and Azure service metrics, all in one place.</span></span>

<span data-ttu-id="02975-217">Beachten Sie, dass Application Insights gedrosselt wird, wenn die Datenrate einen bestimmten Höchstwert überschreitet. Ausführliche Informationen hierzu finden Sie unter [Application Insights-Grenzwerte](/azure/azure-subscription-service-limits#application-insights-limits).</span><span class="sxs-lookup"><span data-stu-id="02975-217">Be aware that Application Insights throttles if the data rate exceeds a maximum limit; for details, see [Application Insights limits](/azure/azure-subscription-service-limits#application-insights-limits).</span></span> <span data-ttu-id="02975-218">Ein einzelner Vorgang kann mehrere Telemetrieereignisse generieren, sodass die Anwendung wahrscheinlich gedrosselt wird, wenn die Menge an Datenverkehr sehr hoch ist.</span><span class="sxs-lookup"><span data-stu-id="02975-218">A single operation may generate several telemetry events, so if the application experiences a high volume of traffic, it is likely to get throttled.</span></span> <span data-ttu-id="02975-219">Zur Lösung dieses Problems können Sie den Telemetriedatenverkehr durch die Erstellung von Stichproben reduzieren.</span><span class="sxs-lookup"><span data-stu-id="02975-219">To mitigate this problem, you can perform sampling to reduce the telemetry traffic.</span></span> <span data-ttu-id="02975-220">Der Nachteil hierbei ist, dass Ihre Metriken weniger genau sind.</span><span class="sxs-lookup"><span data-stu-id="02975-220">The tradeoff is that your metrics will be less precise.</span></span> <span data-ttu-id="02975-221">Weitere Informationen finden Sie unter [Erstellen von Stichproben in Application Insights](/azure/application-insights/app-insights-sampling).</span><span class="sxs-lookup"><span data-stu-id="02975-221">For more information, see [Sampling in Application Insights](/azure/application-insights/app-insights-sampling).</span></span> <span data-ttu-id="02975-222">Sie können das Datenvolumen auch reduzieren, indem Sie Metriken vorab aggregieren. Hierzu berechnen Sie statistische Werte, z.B. die mittlere und die Standardabweichung, und senden diese Werte anstelle der Telemetrie-Rohdaten.</span><span class="sxs-lookup"><span data-stu-id="02975-222">You can also reduce the data volume by pre-aggregating metrics &mdash; that is, calculating statistical values such as average and standard deviation, and sending those values instead of the raw telemetry.</span></span> <span data-ttu-id="02975-223">Im folgenden Blogbeitrag wird ein Ansatz für die bedarfsabhängige Nutzung von Application Insights beschrieben: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/) (Bedarfsabhängige Nutzung der Azure-Überwachung und von Analytics).</span><span class="sxs-lookup"><span data-stu-id="02975-223">The following blog post describes an approach to using Application Insights at scale: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span></span>

<span data-ttu-id="02975-224">Stellen Sie außerdem sicher, dass Sie das Preismodell für Application Insights verstehen, da die Gebühren basierend auf dem Datenvolumen berechnet werden.</span><span class="sxs-lookup"><span data-stu-id="02975-224">In addition, make sure that you understand the pricing model for Application Insights, because you are charged based on data volume.</span></span> <span data-ttu-id="02975-225">Weitere Informationen finden Sie unter [Verwalten von Preisen und Datenvolumen in Application Insights](/azure/application-insights/app-insights-pricing).</span><span class="sxs-lookup"><span data-stu-id="02975-225">For more information, see [Manage pricing and data volume in Application Insights](/azure/application-insights/app-insights-pricing).</span></span> <span data-ttu-id="02975-226">Falls Ihre Anwendung eine große Menge an Telemetriedaten generiert und Sie keine Stichprobenentnahme oder Aggregation der Daten durchführen möchten, ist Application Insights unter Umständen nicht die richtige Wahl.</span><span class="sxs-lookup"><span data-stu-id="02975-226">If your application generates a large volume of telemetry, and you don't wish to perform sampling or aggregation of the data, then Application Insights may not be the appropriate choice.</span></span> 

<span data-ttu-id="02975-227">Hier sind einige Vorschläge für Ansätze mit beliebten Open-Source-Technologien aufgeführt, falls Application Insights Ihre Anforderungen nicht erfüllt.</span><span class="sxs-lookup"><span data-stu-id="02975-227">If Application Insights doesn't meet your requirements, here are some suggested approaches that use popular open-source technologies.</span></span>

<span data-ttu-id="02975-228">Für System- und Containermetriken könne Sie erwägen, die Metriken in eine Zeitreihen-Datenbank zu exportieren, z.B. **Prometheus** oder **InfluxDB**, die im Cluster ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="02975-228">For system and container metrics, consider exporting metrics to a time-series database such as **Prometheus** or **InfluxDB** running in the cluster.</span></span>

- <span data-ttu-id="02975-229">InfluxDB ist ein Push-basiertes System.</span><span class="sxs-lookup"><span data-stu-id="02975-229">InfluxDB is a push-based system.</span></span> <span data-ttu-id="02975-230">Die Metriken müssen von einem Agent per Pushvorgang übertragen werden.</span><span class="sxs-lookup"><span data-stu-id="02975-230">An agent needs to push the metrics.</span></span> <span data-ttu-id="02975-231">Sie können den Dienst [Heapster][heapster] nutzen, bei dem im gesamten Cluster Metriken von Kubelet gesammelt und die Daten aggregiert und per Pushvorgang an InfluxDB oder andere Zeitreihen-Speicherlösungen übertragen werden.</span><span class="sxs-lookup"><span data-stu-id="02975-231">You can use [Heapster][heapster], which is a service that collects cluster-wide metrics from kubelet, aggregates the data, and pushes it to InfluxDB or other time-series storage solution.</span></span> <span data-ttu-id="02975-232">Von Azure Container Service wird Heapster im Rahmen des Clustersetups bereitgestellt.</span><span class="sxs-lookup"><span data-stu-id="02975-232">Azure Container Service deploys Heapster as part of the cluster setup.</span></span> <span data-ttu-id="02975-233">Eine weitere Option ist [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), wobei es sich um einen Agent zu Sammeln und Melden von Metriken handelt.</span><span class="sxs-lookup"><span data-stu-id="02975-233">Another option is [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), which is an agent for collecting and reporting metrics.</span></span> 

- <span data-ttu-id="02975-234">Prometheus ist ein Pull-basiertes System.</span><span class="sxs-lookup"><span data-stu-id="02975-234">Prometheus is a pull-based system.</span></span> <span data-ttu-id="02975-235">Hierbei werden Metriken per „Scraping“ regelmäßig von konfigurierten Speicherorten abgerufen.</span><span class="sxs-lookup"><span data-stu-id="02975-235">It periodically scrapes metrics from configured locations.</span></span> <span data-ttu-id="02975-236">Mit Prometheus können Metriken abgerufen werden, die mit cAdvisor oder kube-state-metrics generiert werden.</span><span class="sxs-lookup"><span data-stu-id="02975-236">Prometheus can scrape metrics generated by cAdvisor or kube-state-metrics.</span></span> <span data-ttu-id="02975-237">[kube-state-metrics][kube-state-metrics] ist ein Dienst, mit dem Metriken vom Kubernetes-API-Server gesammelt und für Prometheus (oder einen Scraper, der mit einem Prometheus-Clientendpunkt kompatibel ist) zur Verfügung gestellt werden.</span><span class="sxs-lookup"><span data-stu-id="02975-237">[kube-state-metrics][kube-state-metrics] is a service that collects metrics from the Kubernetes API server and makes them available to Prometheus (or a scraper that is compatible with a Prometheus client endpoint).</span></span> <span data-ttu-id="02975-238">Während mit Heapster von Kubernetes generierte Metriken aggregiert und an eine Senke weitergeleitet werden, erstellt kube-state-metrics seine eigenen Metriken und stellt sie über einen Endpunkt für das Scraping bereit.</span><span class="sxs-lookup"><span data-stu-id="02975-238">Whereas Heapster aggregates metrics that Kubernetes generates and forwards them to a sink, kube-state-metrics generates its own metrics and makes them available through an endpoint for scraping.</span></span> <span data-ttu-id="02975-239">Verwenden Sie für Systemmetriken den [Node Exporter](https://github.com/prometheus/node_exporter). Dies ist ein Prometheus-Exportprogramm für Systemmetriken.</span><span class="sxs-lookup"><span data-stu-id="02975-239">For system metrics, use [Node exporter](https://github.com/prometheus/node_exporter), which is a Prometheus exporter for system metrics.</span></span> <span data-ttu-id="02975-240">Prometheus unterstützt Gleitkommadaten, aber keine Zeichenfolgendaten, und ist daher nicht für Protokolle geeignet, sondern nur für Systemmetriken.</span><span class="sxs-lookup"><span data-stu-id="02975-240">Prometheus supports floating point data, but not string data, so it is appropriate for system metrics but not logs.</span></span>

- <span data-ttu-id="02975-241">Nutzen Sie ein Dashboardtool wie **Kibana** oder **Grafana**, um die Daten zu visualisieren und zu überwachen.</span><span class="sxs-lookup"><span data-stu-id="02975-241">Use a dashboard tool such as **Kibana** or **Grafana** to visualize and monitor the data.</span></span> <span data-ttu-id="02975-242">Der Dashboarddienst kann auch in einem Container im Cluster ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="02975-242">The dashboard service can also run inside a container in the cluster.</span></span>

<span data-ttu-id="02975-243">Erwägen Sie für Anwendungsprotokolle die Verwendung von **Fluentd** und **Elasticsearch**.</span><span class="sxs-lookup"><span data-stu-id="02975-243">For application logs, consider using **Fluentd** and **Elasticsearch**.</span></span> <span data-ttu-id="02975-244">Fluentd ist ein Open-Source-Datensammler, und Elasticsearch ist eine Dokumentdatenbank, die für den Einsatz als Suchmodul optimiert ist.</span><span class="sxs-lookup"><span data-stu-id="02975-244">Fluentd is an open source data collector, and Elasticsearch is a document database that is optimized to act as a search engine.</span></span> <span data-ttu-id="02975-245">Bei dieser Vorgehensweise sendet jeder Dienst Protokolle an `stdout` und `stderr`, und Kubernetes schreibt diese Datenströme in das lokale Dateisystem.</span><span class="sxs-lookup"><span data-stu-id="02975-245">Using this approach, each service sends logs to `stdout` and `stderr`, and Kubernetes writes these streams to the local file system.</span></span> <span data-ttu-id="02975-246">Fluentd sammelt die Protokolle, erweitert sie optional um zusätzliche Metadaten aus Kubernetes und sendet die Protokolle an Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="02975-246">Fluentd collects the logs, optionally enriches them with additional metadata from Kubernetes, and sends the logs to Elasticsearch.</span></span> <span data-ttu-id="02975-247">Verwenden Sie Kibana, Grafana oder ein ähnliches Tool, um ein Dashboard für Elasticsearch zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="02975-247">Use Kibana, Grafana, or a similar tool to create a dashboard for Elasticsearch.</span></span> <span data-ttu-id="02975-248">Fluentd wird als Daemonset im Cluster ausgeführt, um sicherzustellen, dass jedem Knoten ein Fluentd-Pod zugewiesen ist.</span><span class="sxs-lookup"><span data-stu-id="02975-248">Fluentd runs as a daemonset in the cluster, which ensures that one Fluentd pod is assigned to each node.</span></span> <span data-ttu-id="02975-249">Sie können Fluentd so konfigurieren, dass sowohl Kubelet-Protokolle als auch Containerprotokolle gesammelt werden.</span><span class="sxs-lookup"><span data-stu-id="02975-249">You can configure Fluentd to collect kubelet logs as well as container logs.</span></span> <span data-ttu-id="02975-250">Bei hohen Volumen kann das Schreiben von Protokollen in das lokale Dateisystem zu einem Leistungsengpass führen. Dies gilt vor allem, wenn mehrere Dienste auf demselben Knoten ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="02975-250">At high volumes, writing logs to the local file system could become a performance bottleneck, especially when multiple services are running on the same node.</span></span> <span data-ttu-id="02975-251">Überwachen Sie die Datenträgerwartezeit und Dateisystemauslastung in der Produktion.</span><span class="sxs-lookup"><span data-stu-id="02975-251">Monitor disk latency and file system utilization in production.</span></span>

<span data-ttu-id="02975-252">Ein Vorteil bei Verwendung von Fluentd mit Elasticsearch für Protokolle besteht darin, dass für Dienste keine zusätzlichen Bibliotheksabhängigkeiten erforderlich sind.</span><span class="sxs-lookup"><span data-stu-id="02975-252">One advantage of using Fluentd with Elasticsearch for logs is that services do not require any additional library dependencies.</span></span> <span data-ttu-id="02975-253">Jeder Dienst schreibt nur in `stdout` und `stderr`, und Fluentd übernimmt den Export der Protokolle in Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="02975-253">Each service just writes to `stdout` and `stderr`, and Fluentd handles exporting the logs into Elasticsearch.</span></span> <span data-ttu-id="02975-254">Außerdem müssen sich die Teams, die die Dienste schreiben, nicht mit dem Konfigurieren der Protokollierungsinfrastruktur auskennen.</span><span class="sxs-lookup"><span data-stu-id="02975-254">Also, the teams writing services don't need to understand how to configure the logging infrastructure.</span></span> <span data-ttu-id="02975-255">Eine Herausforderung besteht darin, den Elasticsearch-Cluster für eine Produktionsbereitstellung so zu konfigurieren, dass er für die Verarbeitung Ihres Datenverkehrs skaliert werden kann.</span><span class="sxs-lookup"><span data-stu-id="02975-255">One challenge is to configure the Elasticsearch cluster for a production deployment, so that it scales to handle your traffic.</span></span> 

<span data-ttu-id="02975-256">Eine andere Möglichkeit ist das Senden von Protokollen an Operations Management Suite (OMS) Log Analytics.</span><span class="sxs-lookup"><span data-stu-id="02975-256">Another option is to send logs to Operations Management Suite (OMS) Log Analytics.</span></span> <span data-ttu-id="02975-257">Der [Log Analytics][log-analytics]-Dienst sammelt Protokolldaten in einem zentralen Repository und kann außerdem Daten anderer Azure-Dienste zusammenfassen, die von Ihrer Anwendung verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="02975-257">The [Log Analytics][log-analytics] service collects log data into a central repository, and can also consolidate data from other Azure services that your application uses.</span></span> <span data-ttu-id="02975-258">Weitere Informationen finden Sie unter [Überwachen eines Azure Container Service-Clusters mit Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span><span class="sxs-lookup"><span data-stu-id="02975-258">For more information, see [Monitor an Azure Container Service cluster with Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span></span>

## <a name="example-logging-with-correlation-ids"></a><span data-ttu-id="02975-259">Beispiel: Protokollierung mit Korrelations-IDs</span><span class="sxs-lookup"><span data-stu-id="02975-259">Example: Logging with correlation IDs</span></span>

<span data-ttu-id="02975-260">Hier ist ein erweitertes Beispiel dafür angegeben, wie die Protokollierung vom Paketdienst implementiert wird, um einige in diesem Kapitel beschriebene Punkte zu verdeutlichen.</span><span class="sxs-lookup"><span data-stu-id="02975-260">To illustrate some of the points discussed in this chapter, here is an extended example of how the Package service implements logging.</span></span> <span data-ttu-id="02975-261">Der Paketdienst wurde in TypeScript geschrieben und nutzt das [Koa](https://koajs.com/)-Webframework für Node.js.</span><span class="sxs-lookup"><span data-stu-id="02975-261">The Package service was written in TypeScript and uses the [Koa](https://koajs.com/) web framework for Node.js.</span></span> <span data-ttu-id="02975-262">Sie können zwischen mehreren Node.js-Protokollierungsbibliotheken wählen.</span><span class="sxs-lookup"><span data-stu-id="02975-262">There are several Node.js logging libraries to choose from.</span></span> <span data-ttu-id="02975-263">Wir haben uns für [Winston](https://github.com/winstonjs/winston) entschieden. Dies ist eine beliebte Protokollierungsbibliothek, die beim Testen unsere Leistungsanforderungen erfüllt hat.</span><span class="sxs-lookup"><span data-stu-id="02975-263">We picked [Winston](https://github.com/winstonjs/winston), a popular logging library that met our performance requirements when we tested it.</span></span>

<span data-ttu-id="02975-264">Zum Kapseln der Implementierungsdetails haben wir eine abstrakte `ILogger`-Schnittstelle definiert:</span><span class="sxs-lookup"><span data-stu-id="02975-264">To encapsulate the implementation details, we defined an abstract  `ILogger` interface:</span></span>

```ts
export interface ILogger {
    log(level: string, msg: string, meta?: any)
    debug(msg: string, meta?: any)
    info(msg: string, meta?: any)
    warn(msg: string, meta?: any)
    error(msg: string, meta?: any)
}
```

<span data-ttu-id="02975-265">Hier ist eine `ILogger`-Implementierung angegeben, bei der die Winston-Bibliothek eingeschlossen wird.</span><span class="sxs-lookup"><span data-stu-id="02975-265">Here is an `ILogger` implementation that wraps the Winston library.</span></span> <span data-ttu-id="02975-266">Die Korrelations-ID wird als Konstruktorparameter verwendet und in jede Protokollnachricht eingefügt.</span><span class="sxs-lookup"><span data-stu-id="02975-266">It takes the correlation ID as a constructor parameter, and injects the ID into every log message.</span></span> 

```ts
class WinstonLogger implements ILogger {
    constructor(private correlationId: string) {}
    log(level: string, msg: string, payload?: any) {
        var meta : any = {};
        if (payload) { meta.payload = payload };
        if (this.correlationId) { meta.correlationId = this.correlationId }
        winston.log(level, msg, meta)
    }
  
    info(msg: string, payload?: any) {
        this.log('info', msg, payload);
    }
    debug(msg: string, payload?: any) {
        this.log('debug', msg, payload);
    }
    warn(msg: string, payload?: any) {
        this.log('warn', msg, payload);
    }
    error(msg: string, payload?: any) {
        this.log('error', msg, payload);
    }
}
```

<span data-ttu-id="02975-267">Der Paketdienst muss die Korrelations-ID aus der HTTP-Anforderung extrahieren.</span><span class="sxs-lookup"><span data-stu-id="02975-267">The Package service needs to extract the correlation ID from the HTTP request.</span></span> <span data-ttu-id="02975-268">Wenn Sie linkerd nutzen, befindet sich die Korrelations-ID beispielsweise im `l5d-ctx-trace`-Header.</span><span class="sxs-lookup"><span data-stu-id="02975-268">For example, if you're using linkerd, the correlation ID is found in the `l5d-ctx-trace` header.</span></span> <span data-ttu-id="02975-269">In Koa wird die HTTP-Anforderung in einem Context-Objekt gespeichert, das über die Pipeline für die Anforderungsverarbeitung übergeben wird.</span><span class="sxs-lookup"><span data-stu-id="02975-269">In Koa, the HTTP request is stored in a Context object that gets passed through the request processing pipeline.</span></span> <span data-ttu-id="02975-270">Wir können eine Middleware-Funktion definieren, um die Korrelations-ID aus dem Context-Objekt abzurufen und die Protokollierung zu initialisieren.</span><span class="sxs-lookup"><span data-stu-id="02975-270">We can define a middleware function to get the correlation ID from the Context and initialize the logger.</span></span> <span data-ttu-id="02975-271">(Eine Middleware-Funktion in Koa ist lediglich eine Funktion, die für jede Anforderung ausgeführt wird.)</span><span class="sxs-lookup"><span data-stu-id="02975-271">(A middleware function in Koa is simply a function that gets executed for each request.)</span></span>

```ts
export type CorrelationIdFn = (ctx: Context) => string;

export function logger(level: string, getCorrelationId: CorrelationIdFn) {
    winston.configure({ 
        level: level,
        transports: [new (winston.transports.Console)()]
        });
    return async function(ctx: any, next: any) {
        ctx.state.logger = new WinstonLogger(getCorrelationId(ctx));
        await next();
    }
}
```

<span data-ttu-id="02975-272">Über diese Middleware wird eine vom Aufrufer definierte Funktion (`getCorrelationId`) aufgerufen, um die Korrelations-ID abzurufen.</span><span class="sxs-lookup"><span data-stu-id="02975-272">This middleware invokes a caller-defined function, `getCorrelationId`, to get the correlation ID.</span></span> <span data-ttu-id="02975-273">Anschließend wird eine Instanz der Protokollierung erstellt und in `ctx.state` dafür dann ein Stash ausgeführt. Dies ist ein Schlüssel-Wert-Wörterbuch, das in Koa zum Übergeben von Informationen über die Pipeline verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="02975-273">Then it creates an instance of the logger and stashes it inside `ctx.state`, which is a key-value dictionary used in Koa to pass information through the pipeline.</span></span> 

<span data-ttu-id="02975-274">Die Middleware der Protokollierung wird der Pipeline beim Starten hinzugefügt:</span><span class="sxs-lookup"><span data-stu-id="02975-274">The logger middleware is added to the pipeline on startup:</span></span>

```ts
app.use(logger(Settings.logLevel(), function (ctx) {
    return ctx.headers[Settings.correlationHeader()];  
}));
```

<span data-ttu-id="02975-275">Nachdem alles konfiguriert wurde, ist das Hinzufügen von Protokollierungsanweisungen zum Code ein einfacher Vorgang.</span><span class="sxs-lookup"><span data-stu-id="02975-275">Once everything is configured, it's easy to add logging statements to the code.</span></span> <span data-ttu-id="02975-276">Hier ist beispielsweise die Methode angegeben, mit der nach einem Paket gesucht wird.</span><span class="sxs-lookup"><span data-stu-id="02975-276">For example, here is the method that looks up a package.</span></span> <span data-ttu-id="02975-277">Es werden zwei Aufrufe der `ILogger.info`-Methode durchgeführt.</span><span class="sxs-lookup"><span data-stu-id="02975-277">It makes two calls to the `ILogger.info` method.</span></span>

```ts
async getById(ctx: any, next: any) {
  var logger : ILogger = ctx.state.logger;
  var packageId = ctx.params.packageId;
  logger.info('Entering getById, packageId = %s', packageId);

  await next();

  let pkg = await this.repository.findPackage(ctx.params.packageId)

  if (pkg == null) {
    logger.info(`getById: %s not found`, packageId);
    ctx.response.status= 404;
    return;
  }

  ctx.response.status = 200;
  ctx.response.body = this.mapPackageDbToApi(pkg);
}
```

<span data-ttu-id="02975-278">Es ist nicht erforderlich, die Korrelations-ID in die Protokollierungsanweisungen einzufügen, da dies automatisch von der Middleware-Funktion durchgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="02975-278">We don't need to include the correlation ID in the logging statements, because that's done automatically by the middleware function.</span></span> <span data-ttu-id="02975-279">So ist der Code für die Protokollierung weniger komplex, und es ist weniger wahrscheinlich, dass ein Entwickler das Einfügen der Korrelations-ID vergisst.</span><span class="sxs-lookup"><span data-stu-id="02975-279">This makes the logging code cleaner, and reduces the chance that a developer will forget to include the correlation ID.</span></span> <span data-ttu-id="02975-280">Und da für alle Protokollierungsanweisungen die abstrakte `ILogger`-Schnittstelle verwendet wird, ist es einfach, die Implementierung der Protokollierung zu einem späteren Zeitpunkt auszutauschen.</span><span class="sxs-lookup"><span data-stu-id="02975-280">And because all of the logging statements use the abstract `ILogger` interface, it would be easy to replace the logger implementation later.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="02975-281">Continuous Integration und Continuous Delivery</span><span class="sxs-lookup"><span data-stu-id="02975-281">Continuous integration and delivery</span></span>](./ci-cd.md)

<!-- links -->

[app-insights]: /azure/application-insights/app-insights-overview
[heapster]: https://github.com/kubernetes/heapster
[kube-state-metrics]: https://github.com/kubernetes/kube-state-metrics
[k8s-to-oms]: /azure/container-service/kubernetes/container-service-kubernetes-oms
[log-analytics]: /azure/log-analytics/
